<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live News Feed | Finex</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>tailwind.config = { darkMode: 'class' }</script>
  <link rel="stylesheet" href="main.css">
  <style>
    .card-truncate { max-height: 5.25rem; overflow: hidden; }
    .fade-in { animation: fadeIn .22s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
  </style>
</head>

<body class="antialiased textured-background">
  <div id="app-wrapper" style="display:none;">
    <div id="sidebar-placeholder"></div>
    <div id="header-placeholder"></div>

    <main class="container mx-auto p-4 md:p-8">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-color-base">ðŸ“¡ Live Market News</h1>
          <p class="text-sm text-color-muted mt-1">Real-time headlines and signals. Auto-updating.</p>
        </div>
        <div id="connection-status" class="text-sm font-medium text-yellow-500 flex items-center gap-2 bg-black/5 dark:bg-white/5 px-3 py-1.5 rounded-full">
            <span class="relative flex h-2.5 w-2.5">
                <span class="animate-spin inline-flex h-full w-full rounded-full border-2 border-dotted border-current"></span>
            </span>
            Connecting...
        </div>
      </div>

      <!-- Controls -->
      <section class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <input id="search" placeholder="Search news..." class="form-input" />
        <select id="impact" class="form-select"><option value="">All USD Impact</option><option value="up">USD Bullish â†‘</option><option value="down">USD Bearish â†“</option><option value="neutral">Neutral</option></select>
        <select id="goldImpact" class="form-select"><option value="">All Gold Impact</option><option value="up">Gold Bullish â†‘</option><option value="down">Gold Bearish â†“</option><option value="neutral">Neutral</option></select>
        <select id="sortBy" class="form-select"><option value="recent">Newest First</option><option value="confidence">Highest Confidence</option><option value="alert_first">Alerts First</option></select>
      </section>

      <!-- Feed -->
      <section id="feed" class="space-y-4 min-h-[200px]">
          <div class="text-center text-color-muted py-12"><i class="fas fa-circle-notch fa-spin mr-2"></i>Loading feed...</div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalRoot" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modalBackdrop"></div>
    <div class="relative max-w-2xl w-full bg-white dark:bg-gray-900 rounded-2xl shadow-2xl overflow-hidden transform transition-all">
      <div class="p-6 max-h-[70vh] overflow-y-auto text-base text-gray-800 dark:text-gray-300 whitespace-pre-wrap leading-relaxed" id="modalContent"></div>
      <div class="px-6 py-4 bg-gray-50 dark:bg-white/5 flex justify-end gap-3">
          <button id="modalClose" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 text-color-base hover:bg-gray-100 dark:hover:bg-white/10">Close</button>
          <a id="modalOpenOriginal" class="main-button py-2 px-4 rounded-lg hidden" target="_blank">Open Source</a>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
  <script type="module">
    import { initializeAppCore } from './app.js';
    import { collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    function initNewsPage(user, db) {
      document.getElementById('app-wrapper').style.display = 'block'; // REVEAL PAGE
      let allFeedData = [];
      const els = { feed: document.getElementById('feed'), status: document.getElementById('connection-status'), search: document.getElementById('search'), impact: document.getElementById('impact'), gold: document.getElementById('goldImpact'), sort: document.getElementById('sortBy'), modal: document.getElementById('modalRoot'), modalTxt: document.getElementById('modalContent'), modalLink: document.getElementById('modalOpenOriginal') };

      function render() {
        let data = allFeedData.filter(it => 
            (els.search.value === '' || (it.headline+it.text+it.source).toLowerCase().includes(els.search.value.toLowerCase())) &&
            (els.impact.value === '' || it.usd_impact === els.impact.value) &&
            (els.gold.value === '' || it.xauusd_impact === els.gold.value)
        );

        if (els.sort.value === 'confidence') data.sort((a,b) => (b.confidence||0) - (a.confidence||0));
        else if (els.sort.value === 'alert_first') data.sort((a,b) => (b.action==='ALERT' ? 1 : 0) - (a.action==='ALERT' ? 1 : 0) || new Date(b.published) - new Date(a.published));
        else data.sort((a,b) => new Date(b.published) - new Date(a.published));

        els.feed.innerHTML = data.length ? '' : '<div class="text-center py-12 text-color-muted bg-black/5 dark:bg-white/5 rounded-2xl">No news found.</div>';
        
        data.forEach(item => {
            const isAlert = item.action === 'ALERT', conf = Math.round((item.confidence||0)*100);
            const div = document.createElement('div');
            div.className = `p-5 rounded-2xl border fade-in transition-all hover:border-blue-500/30 ${isAlert ? 'border-red-500/30 bg-red-500/5' : 'border-gray-200 dark:border-white/10 bg-white dark:bg-white/5'}`;
            div.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                    <span class="${isAlert ? 'bg-red-500 text-white' : 'bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400'} text-[0.65rem] px-2 py-0.5 rounded-full font-bold tracking-wider">${isAlert ? 'ALERT' : 'INFO'}</span>
                    <span class="text-xs text-color-muted">${item.source || 'Finex'} â€¢ ${timeAgo(item.published)}</span>
                </div>
                 <div class="flex gap-3 text-xs font-bold">
                    <span class="${item.usd_impact==='up'?'text-green-500':item.usd_impact==='down'?'text-red-500':'text-color-muted'}">USD ${item.usd_impact?.toUpperCase()}</span>
                    <span class="${item.xauusd_impact==='up'?'text-yellow-500':item.xauusd_impact==='down'?'text-blue-500':'text-color-muted'}">GOLD ${item.xauusd_impact?.toUpperCase()}</span>
                 </div>
            </div>
            <h3 class="text-lg font-bold text-color-base mb-2 cursor-pointer hover:text-blue-500 transition-colors headline-trigger">${item.headline}</h3>
            ${item.reason ? `<p class="text-sm text-color-muted italic mb-3 bg-black/5 dark:bg-black/20 p-2 rounded"><i class="fas fa-info-circle mr-2 opacity-50"></i>${item.reason}</p>` : ''}
            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100 dark:border-white/5">
                <span class="text-xs font-medium text-color-muted">Confidence: <span class="${conf>75?'text-green-500':'text-yellow-500'}">${conf}%</span></span>
                <button class="text-xs font-bold text-blue-500 hover:underline headline-trigger">Read More</button>
            </div>`;
            div.querySelectorAll('.headline-trigger').forEach(b => b.onclick = () => {
                els.modalTxt.innerText = item.text || item.headline;
                els.modalLink.href = item.url; els.modalLink.style.display = item.url ? 'inline-flex' : 'none';
                els.modal.classList.remove('hidden');
            });
            els.feed.appendChild(div);
        });
      }

      onSnapshot(query(collection(db, 'news_feed'), orderBy('createdAt', 'desc'), limit(50)), (snap) => {
          allFeedData = snap.docs.map(d => ({...d.data(), id: d.id}));
          render();
          els.status.innerHTML = '<span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span></span> Live';
          els.status.className = 'text-sm font-medium text-green-500 flex items-center gap-2 bg-green-500/10 px-3 py-1.5 rounded-full';
      }, (err) => {
          console.error(err);
          els.status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline';
          els.status.className = 'text-sm font-medium text-red-500 flex items-center gap-2 bg-red-500/10 px-3 py-1.5 rounded-full';
      });

      [els.search, els.impact, els.gold, els.sort].forEach(el => el.addEventListener('input', render));
      document.getElementById('modalClose').onclick = document.getElementById('modalBackdrop').onclick = () => els.modal.classList.add('hidden');
      
      function timeAgo(iso) {
        try { const s = Math.floor((new Date() - new Date(iso))/1000);
        if (s<60) return 'Just now'; if (s<3600) return Math.floor(s/60)+'m ago'; if (s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; } catch { return ''; }
      }
    }
    initializeAppCore(initNewsPage);
  </script>
</body>
</html>
