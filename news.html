<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live News Feed | Finex</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: "Source Sans Pro", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #0b1220; color: #e6eef8; }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; }
    .card-collapsed { max-height: 5.2rem; overflow:hidden; }
    .time-small { font-variant-numeric: tabular-nums; }
    .muted { color: #98a0b3; }
    .confidence-bar { height: 8px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow:hidden; }
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto p-6">
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-bold">ðŸ“¡ Live Market News Feed</h1>
        <p class="muted mt-1">Headlines, full text and automated USD / XAU impact signals â€” live from admin.</p>
      </div>
      <div class="text-right">
        <div class="muted text-xs">Last update</div>
        <div id="last-updated" class="font-medium time-small">â€”</div>
      </div>
    </header>

    <section class="mb-5 grid gap-3 md:grid-cols-2 lg:grid-cols-4">
      <input id="search" type="search" placeholder="Search headline, text, or reason..." class="p-3 rounded-xl bg-white/3 border border-white/6" />
      <select id="filterUsd" class="p-3 rounded-xl bg-white/3 border border-white/6">
        <option value="">All USD impacts</option>
        <option value="up">USD â†‘ (Bullish)</option>
        <option value="down">USD â†“ (Dovish)</option>
        <option value="neutral">Neutral</option>
      </select>
      <select id="filterGold" class="p-3 rounded-xl bg-white/3 border border-white/6">
        <option value="">All XAUUSD impacts</option>
        <option value="up">Gold â†‘</option>
        <option value="down">Gold â†“</option>
        <option value="neutral">Neutral</option>
      </select>
      <select id="sortBy" class="p-3 rounded-xl bg-white/3 border border-white/6">
        <option value="recent">Sort: Newest</option>
        <option value="confidence">Sort: Confidence</option>
        <option value="alert_first">Sort: Alerts first</option>
      </select>
    </section>

    <section id="feed" class="space-y-4">
      <div class="muted text-center">Loading live feedâ€¦</div>
    </section>

    <div id="empty" class="text-center muted hidden mt-6">No news items found.</div>
  </main>

  <!-- Firebase + app logic -->
  <script type="module">
    // -------------------------
    // CONFIG: Replace with your Firebase config if different
    // -------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCRtzONV0M1syCLTF6H5__cGEBgJxM13sM",
      authDomain: "adminpanel-93879.firebaseapp.com",
      projectId: "adminpanel-93879",
      storageBucket: "adminpanel-93879.appspot.com",
      messagingSenderId: "854889610123",
      appId: "1:854889610123:web:4522c7fc685e9864014d8e"
    };

    // -------------------------
    // Firebase imports (modular)
    // -------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, getDoc, collection, query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------------------------
    // Init
    // -------------------------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const feedEl = document.getElementById('feed');
    const searchEl = document.getElementById('search');
    const filterUsdEl = document.getElementById('filterUsd');
    const filterGoldEl = document.getElementById('filterGold');
    const sortByEl = document.getElementById('sortBy');
    const lastUpdatedEl = document.getElementById('last-updated');
    const emptyEl = document.getElementById('empty');

    // Local state
    let feedData = [];
    let lastFetch = 0;

    function esc(s){
      if (s === null || s === undefined) return '';
      const d = document.createElement('div');
      d.innerText = String(s);
      return d.innerHTML;
    }

    function timeAgo(iso){
      try{
        const d = new Date(iso);
        const s = Math.floor((Date.now() - d.getTime())/1000);
        if (s < 60) return `${s}s ago`;
        const m = Math.floor(s/60); if (m < 60) return `${m}m ago`;
        const h = Math.floor(m/60); if (h < 24) return `${h}h ago`;
        const days = Math.floor(h/24); return `${days}d ago`;
      }catch(e){ return ''; }
    }

    function makeConfidenceHtml(conf){
      const pct = Math.round((conf||0)*100);
      const color = pct >= 75 ? 'bg-green-400' : pct >= 45 ? 'bg-yellow-400' : 'bg-gray-400';
      return `<div style="display:flex;align-items:center;gap:.5rem">
                <div class="confidence-bar" style="width:120px">
                  <div style="width:${pct}%;height:100%;background:linear-gradient(90deg, rgba(16,185,129,0.9), rgba(34,197,94,0.9));"></div>
                </div>
                <div class="muted" style="font-size:.8rem">${pct}%</div>
              </div>`;
    }

    function buildCard(item){
      const isAlert = (item.action||'').toUpperCase() === 'ALERT';
      const usd = (item.usd_impact||'neutral').toLowerCase();
      const gold = (item.xauusd_impact||'neutral').toLowerCase();
      const bullet = isAlert ? '<span style="background:#ffe4e6;color:#9b1c1c;padding:.2rem .5rem;border-radius:999px;font-weight:700;font-size:.75rem">ALERT</span>' : '';
      const short = esc(item.text || item.headline || '').replace(/\n/g,'<br/>');
      const headline = esc(item.headline || '').replace(/\n/g,' ');
      const published = item.published || item.createdAt || new Date().toISOString();
      const reason = esc(item.reason || '');
      const source = esc(item.source || '');
      const url = esc(item.url || '');

      return `
      <article class="glass p-4 rounded-lg border border-white/6">
        <div style="display:flex;justify-content:space-between;gap:1rem">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:.6rem">
              <h3 style="margin:0;font-size:1.05rem;font-weight:700">${headline}</h3>
              ${bullet}
            </div>
            <div class="muted" style="margin-top:.35rem;font-size:.85rem">${timeAgo(published)} Â· ${new Date(published).toLocaleString()} Â· Source: <strong>${source}</strong></div>
            <div id="txt-${btoa(headline).replace(/=/g,'')}" class="mt-3" style="${(short.length>600)?'max-height:5.2rem;overflow:hidden;':''}">${short}</div>
            <div class="mt-3 flex gap-2">
              <button data-expand="${btoa(headline).replace(/=/g,'')}" class="p-2 rounded-xl bg-white/3 text-sm">View ${short.length>600?'more':'full'}</button>
              ${ url ? `<a href="${url}" target="_blank" class="p-2 rounded-xl bg-white/3 text-sm">Open original</a>` : '' }
              <button data-copy="${headline}" class="p-2 rounded-xl bg-white/3 text-sm">Copy headline</button>
            </div>
          </div>

          <div style="width:180px;display:flex;flex-direction:column;align-items:flex-end;gap:.5rem">
            <div class="muted">USD <span style="font-weight:700;color:${usd==='up'?'#10b981':usd==='down'?'#ef4444':'#94a3b8'};margin-left:.4rem">${usd.toUpperCase()}</span></div>
            <div class="muted">XAUUSD <span style="font-weight:700;color:${gold==='up'?'#f59e0b':gold==='down'?'#3b82f6':'#94a3b8'};margin-left:.4rem">${gold.toUpperCase()}</span></div>
            <div style="margin-top:.5rem">${makeConfidenceHtml(item.confidence)}</div>
          </div>
        </div>
        <div class="muted" style="margin-top:.6rem">Reason: ${reason || 'â€”'}</div>
      </article>
      `;
    }

    function render(){
      const q = (searchEl.value||'').trim().toLowerCase();
      const usdFilter = filterUsdEl.value;
      const goldFilter = filterGoldEl.value;
      const sort = sortByEl.value;

      let items = Array.from(feedData || []);

      if (q) {
        items = items.filter(it => (it.headline||'').toLowerCase().includes(q) || (it.text||'').toLowerCase().includes(q) || (it.reason||'').toLowerCase().includes(q));
      }
      if (usdFilter) items = items.filter(it => (it.usd_impact||'').toLowerCase() === usdFilter);
      if (goldFilter) items = items.filter(it => (it.xauusd_impact||'').toLowerCase() === goldFilter);

      if (sort === 'confidence') {
        items.sort((a,b)=> (b.confidence||0)-(a.confidence||0));
      } else if (sort === 'alert_first') {
        items.sort((a,b)=> ( (b.action==='ALERT')?1:0 ) - ( (a.action==='ALERT')?1:0 ) || ( (b.confidence||0)-(a.confidence||0) ));
      } else {
        items.sort((a,b)=> new Date(b.published||b.createdAt).getTime() - new Date(a.published||a.createdAt).getTime());
      }

      feedEl.innerHTML = '';
      if (!items.length) {
        emptyEl.classList.remove('hidden');
        return;
      } else emptyEl.classList.add('hidden');

      items.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = buildCard(item);
        // attach expand/copy handlers
        const expandBtn = wrapper.querySelector('[data-expand]');
        if (expandBtn) {
          expandBtn.addEventListener('click', () => {
            const id = expandBtn.getAttribute('data-expand');
            const el = document.getElementById('txt-'+id);
            if (!el) return;
            if (el.style.maxHeight) {
              el.style.maxHeight = ''; expandBtn.textContent = 'View full';
            } else {
              el.style.maxHeight = 'none'; expandBtn.textContent = 'Collapse';
            }
          });
        }
        const copyBtn = wrapper.querySelector('[data-copy]');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            const txt = copyBtn.getAttribute('data-copy') || '';
            navigator.clipboard?.writeText(txt);
            copyBtn.textContent = 'Copied';
            setTimeout(()=> copyBtn.textContent = 'Copy headline', 1200);
          });
        }
        feedEl.appendChild(wrapper);
      });
    }

    // update last-updated helper
    function setLastUpdated(){
      lastUpdatedEl.innerText = 'Just now';
      lastFetch = Date.now();
      setTimeout(()=> {
        // update relative time display every sec
        const id = setInterval(()=>{
          const delta = Math.floor((Date.now()-lastFetch)/1000);
          if (delta < 5) lastUpdatedEl.innerText = 'Just now';
          else if (delta < 60) lastUpdatedEl.innerText = `${delta}s ago`;
          else if (delta < 3600) lastUpdatedEl.innerText = `${Math.floor(delta/60)}m ago`;
          else lastUpdatedEl.innerText = `${Math.floor(delta/3600)}h ago`;
        }, 1000);
        // stop after 10 minutes to avoid leaking timers â€” harmless but tidy
        setTimeout(()=>clearInterval(id), 10*60*1000);
      }, 0);
    }

    // -------------------------
    // Primary: listen to meta/latest_feed doc
    // -------------------------
    async function subscribeToSnapshot(){
      try{
        const metaRef = doc(db, 'meta', 'latest_feed');
        onSnapshot(metaRef, async (docSnap) => {
          if (!docSnap.exists) {
            // fallback: load collection
            console.warn('meta/latest_feed not found, falling back to collection read');
            await loadFromCollection();
            return;
          }
          const data = docSnap.data();
          const arr = data.snapshot || data.items || [];
          // normalize timestamps if needed
          feedData = arr.map(it => ({
            headline: it.headline,
            text: it.text,
            source: it.source,
            published: it.published,
            createdAt: it.createdAt,
            usd_impact: it.usd_impact,
            xauusd_impact: it.xauusd_impact,
            confidence: it.confidence,
            reason: it.reason,
            action: it.action,
            url: it.url
          }));
          setLastUpdated();
          render();
        }, (err) => {
          console.error('meta/latest_feed onSnapshot error', err);
          // fallback to collection read
          loadFromCollection();
        });
      } catch (err) {
        console.error('subscribeToSnapshot error', err);
        loadFromCollection();
      }
    }

    // -------------------------
    // Fallback: read top N from collection
    // -------------------------
    async function loadFromCollection(){
      try{
        const q = query(collection(db, 'news_feed'), orderBy('createdAt','desc'), limit(200));
        const snap = await getDocs(q);
        feedData = snap.docs.map(d => d.data());
        setLastUpdated();
        render();
      } catch (err) {
        console.error('loadFromCollection failed', err);
        feedEl.innerHTML = `<div class="text-center" style="color:#ffb4b4">Failed to load feed â€” check Firestore rules or network. (${esc(err.message||err)})</div>`;
      }
    }

    // -------------------------
    // Start subscription
    // -------------------------
    subscribeToSnapshot();

    // wire UI interactions
    [searchEl, filterUsdEl, filterGoldEl, sortByEl].forEach(el => el.addEventListener('input', render));
    // expose reload helper for debugging
    window.reloadFeed = () => { subscribeToSnapshot(); };

  </script>
</body>
</html>
