<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal | Finex</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {/* Keep Chart.js */}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    </head>
<body class="antialiased textured-background">
     <div id="app-wrapper" style="display: none;">
        
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div class="min-h-screen flex flex-col">
            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Left Column: Analytics */}
                    <div class="lg:col-span-1 space-y-8">
                        {/* Performance Stats */}
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold text-center mb-4">Performance Analytics</h2>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="glass-card p-3"><span class="text-sm text-color-muted block">Total P/L</span><span id="total-pl" class="text-xl font-bold">-$--.--</span></div>
                                <div class="glass-card p-3"><span class="text-sm text-color-muted block">Total Trades</span><span id="total-trades" class="text-xl font-bold">0</span></div>
                                <div class="glass-card p-3"><span class="text-sm text-color-muted block">Win Rate</span><span id="win-rate" class="text-xl font-bold">--%</span></div>
                                <div class="glass-card p-3"><span class="text-sm text-color-muted block">Profit Factor</span><span id="profit-factor" class="text-xl font-bold">--</span></div>
                                <div class="glass-card p-3 col-span-2"><span class="text-sm text-color-muted block">Avg Win / Loss</span><span id="avg-win-loss" class="text-lg font-bold">-$-- / -$--</span></div>
                            </div>
                        </div>
                        {/* Equity Curve */}
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Equity Curve</h2>
                            <div style="height: 250px;"> {/* Constrain chart height */}
                               <canvas id="equity-curve-chart"></canvas>
                            </div>
                        </div>
                        {/* Tag Filter */}
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Filter by Tag</h2>
                            <div id="tags-container" class="flex flex-wrap gap-2">
                                <p class="text-color-muted text-sm">No trades with tags yet.</p>
                            </div>
                        </div>
                    </div>
                    {/* Right Column: Trade Entry & History */}
                    <div class="lg:col-span-2 space-y-8">
                        {/* New Trade Form */}
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Log a New Trade</h2>
                            <form id="trade-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="text-sm text-color-muted block mb-1">Symbol</label><input type="text" id="trade-symbol" required class="form-input w-full" placeholder="e.g., AAPL"></div>
                                    <div><label class="text-sm text-color-muted block mb-1">Direction</label><select id="trade-direction" class="form-select w-full"><option value="long">Long</option><option value="short">Short</option></select></div>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><label class="text-sm text-color-muted block mb-1">Entry</label><input type="number" step="any" id="trade-entry" required class="form-input w-full"></div>
                                    <div><label class="text-sm text-color-muted block mb-1">Exit</label><input type="number" step="any" id="trade-exit" required class="form-input w-full"></div>
                                    <div><label class="text-sm text-color-muted block mb-1">Size</label><input type="number" step="any" id="trade-size" required class="form-input w-full" placeholder="Shares/Lots"></div>
                                    <div><label class="text-sm text-color-muted block mb-1">P/L ($)</label><input type="text" id="trade-pl-display" readonly class="form-input w-full bg-black/10 dark:bg-white/5 cursor-not-allowed"></div> {/* Adjusted background */}
                                </div>
                                <div><label class="text-sm text-color-muted block mb-1">Chart Screenshot URL</label><input type="url" id="trade-image" class="form-input w-full" placeholder="Paste image link here..."></div>
                                <div><label class="text-sm text-color-muted block mb-1">Tags (comma-separated)</label><input type="text" id="trade-tags" class="form-input w-full" placeholder="#breakout, #followed_plan..."></div>
                                <div><label class="text-sm text-color-muted block mb-1">Notes / Setup</label><textarea id="trade-notes" rows="3" class="form-textarea w-full" placeholder="Why did you take this trade? What was your mindset?"></textarea></div>
                                <button type="submit" id="save-trade-btn" class="main-button w-full font-bold py-3">Save Trade</button>
                                <p id="form-message" class="text-center text-sm mt-3 h-4"></p>
                            </form>
                        </div>
                        {/* Trade History */}
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Trade History</h2>
                            <div id="trade-history" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"> {/* Add max-height and overflow */}
                                <p class="text-center text-color-muted">No trades logged yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content glass-card p-8 rounded-2xl w-full max-w-sm text-center transform scale-95">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="text-color-muted mb-6">Are you sure you want to permanently delete this trade?</p>
                <div class="flex gap-4">
                    <button id="cancel-delete-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">Cancel</button> {/* Adjusted colors */}
                    <button id="confirm-delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">Delete</button>
                </div>
            </div>
        </div>
        <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <button id="close-image-modal" class="absolute top-4 right-6 text-white text-4xl hover:opacity-75">&times;</button>
            <div class="modal-content w-full h-full flex items-center justify-center transform scale-95">
                <img id="modal-image-src" src="" alt="Trade Screenshot" class="max-w-[90vw] max-h-[90vh] rounded-lg"> {/* Added default alt */}
            </div>
        </div>
        </div>

    <script type="module" src="app.js"></script>
    
    <script type="module">
        // Import the core initializer, db, and auth from app.js
        import { initializeAppCore, db, auth } from './app.js'; 
        // Import Firestore functions needed for the journal
        import { collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // Define the function containing this page's unique JavaScript logic
        function initJournalPage(user, db) {
            console.log("Setting up Trading Journal specific logic...");

            // --- Elements Cache ---
            const elements = { 
                totalPl: document.getElementById('total-pl'), 
                totalTrades: document.getElementById('total-trades'), 
                winRate: document.getElementById('win-rate'), 
                profitFactor: document.getElementById('profit-factor'), 
                avgWinLoss: document.getElementById('avg-win-loss'), 
                tradeHistory: document.getElementById('trade-history'), 
                tradeForm: document.getElementById('trade-form'), 
                saveBtn: document.getElementById('save-trade-btn'), 
                formMessage: document.getElementById('form-message'), 
                deleteModal: document.getElementById('delete-modal'), 
                cancelDelete: document.getElementById('cancel-delete-btn'), 
                confirmDelete: document.getElementById('confirm-delete-btn'), 
                imageModal: document.getElementById('image-modal'), 
                closeImageModal: document.getElementById('close-image-modal'), 
                modalImageSrc: document.getElementById('modal-image-src'), 
                tagsContainer: document.getElementById('tags-container'), 
                plDisplay: document.getElementById('trade-pl-display'),
                chartCanvas: document.getElementById('equity-curve-chart') // Get canvas element
            };

             // --- State Variables ---
            let allTrades = []; 
            let filteredTrades = []; 
            let activeTag = null; 
            let equityChart = null; // Chart instance
            let tradeToDeleteId = null;
            const userId = user.uid; // Get userId from passed user object
            const tradesCollectionRef = collection(db, "trades"); // Define collection ref

            // --- Check for Missing Elements ---
            let missingElement = false;
            for (const key in elements) {
                if (!elements[key]) {
                    console.error(`Error: Element with ID '${key}' not found!`);
                    missingElement = true;
                }
            }
            if(missingElement) {
                 // Display error to user if critical elements are missing
                 document.getElementById('app-wrapper').innerHTML = "<p class='text-red-500 text-center p-8'>Error initializing journal page elements. Please contact support.</p>";
                 return; // Stop execution
            }

            // --- P/L Calculation ---
            const calculatePL = () => { 
                // Ensure form elements exist before accessing values
                if (!elements.tradeForm || !elements.plDisplay) return; 
                const entry = parseFloat(elements.tradeForm['trade-entry']?.value) || 0; 
                const exit = parseFloat(elements.tradeForm['trade-exit']?.value) || 0; 
                const size = parseFloat(elements.tradeForm['trade-size']?.value) || 0; 
                const direction = elements.tradeForm['trade-direction']?.value; 
                let pl = (direction === 'long' ? (exit - entry) : (entry - exit)) * size; 
                elements.plDisplay.value = isNaN(pl) ? '' : pl.toLocaleString('en-US', {style: 'currency', currency: 'USD'}); 
            };

            // --- Analytics Update ---
            function updateAnalytics(tradesToAnalyze) { 
                const total = tradesToAnalyze.length; 
                const totalPL = tradesToAnalyze.reduce((sum, t) => sum + (t.pl || 0), 0); // Handle potential undefined pl
                const winners = tradesToAnalyze.filter(t => t.pl > 0); 
                const losers = tradesToAnalyze.filter(t => t.pl < 0); 
                const winRate = total > 0 ? (winners.length / total) * 100 : 0; 
                const grossProfit = winners.reduce((sum, t) => sum + t.pl, 0); 
                const grossLoss = Math.abs(losers.reduce((sum, t) => sum + t.pl, 0)); 
                const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? Infinity : 0); // Handle zero loss/profit
                const avgWin = winners.length > 0 ? grossProfit / winners.length : 0; 
                const avgLoss = losers.length > 0 ? grossLoss / losers.length : 0; 
                
                // Update DOM elements safely
                elements.totalPl.textContent = totalPL.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); 
                elements.totalPl.className = `text-xl font-bold ${totalPL >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'}`; 
                elements.totalTrades.textContent = total; 
                elements.winRate.textContent = `${winRate.toFixed(1)}%`; 
                elements.profitFactor.textContent = isFinite(profitFactor) ? profitFactor.toFixed(2) : '∞'; 
                elements.avgWinLoss.innerHTML = `<span class="text-green-500 dark:text-green-400">${avgWin.toLocaleString('en-US', {style:'currency', currency:'USD'})}</span> / <span class="text-red-500 dark:text-red-400">${avgLoss.toLocaleString('en-US', {style:'currency', currency:'USD'})}</span>`; 
                
                updateEquityCurve(tradesToAnalyze); 
            }

            // --- Equity Curve Chart ---
            function initEquityChart() { 
                if (equityChart) { equityChart.destroy(); } // Destroy existing chart if any
                const ctx = elements.chartCanvas.getContext('2d'); 
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                const tickColor = isDarkMode ? '#a9a9b3' : '#4b5563';
                const lineColor = isDarkMode ? '#0065ff' : '#0052cc'; // Brighter blue for dark

                equityChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: [], datasets: [{ label: 'Equity', data: [], borderColor: lineColor, tension: 0.1, fill: false, pointRadius: 0, pointHoverRadius: 0 }] }, // Hide points initially
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            x: { 
                                ticks: { display: false }, 
                                grid: { color: gridColor, drawBorder: false } // Hide X border
                            }, 
                            y: { 
                                grid: { color: gridColor, drawBorder: false }, // Hide Y border
                                ticks: { color: tickColor, // Use theme color
                                     // Format ticks as currency (optional)
                                    // callback: function(value, index, values) {
                                    //     return value.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits: 0});
                                    // } 
                                } 
                            } 
                        },
                        interaction: { // Improve tooltip behavior
                           intersect: false,
                           mode: 'index',
                        },
                    } 
                }); 
            }
            function updateEquityCurve(trades) { 
                if (!equityChart) return;
                let runningTotal = 0; 
                // Sort trades by date ASCENDING for the curve calculation
                const sortedTrades = trades.slice().sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate()); 
                const equityData = sortedTrades.map(trade => runningTotal += (trade.pl || 0)); 
                
                equityChart.data.labels = sortedTrades.map((_, i) => i + 1); 
                equityChart.data.datasets[0].data = [0, ...equityData]; // Start curve at 0
                 equityChart.data.labels = [0, ...equityChart.data.labels]; // Add label for starting point

                equityChart.update(); 
            }

             // --- Render Trades & Tags ---
            function renderTrades(tradesToRender) { 
                if (tradesToRender.length === 0) { 
                    elements.tradeHistory.innerHTML = `<p class="text-center text-color-muted">No trades ${activeTag ? `with tag #${activeTag}` : 'logged yet'}.</p>`; 
                    return; 
                } 
                elements.tradeHistory.innerHTML = tradesToRender.map(trade => { 
                    const plColor = (trade.pl || 0) >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'; 
                    const directionColor = trade.direction === 'long' ? 'bg-green-600/20 text-green-400' : 'bg-red-600/20 text-red-400'; 
                    const tagsHTML = Array.isArray(trade.tags) ? trade.tags.map(tag => `<span class="text-xs text-blue-400 dark:text-blue-300 mr-1">#${tag}</span>`).join('') : ''; 
                    const dateString = trade.createdAt?.toDate() ? trade.createdAt.toDate().toLocaleString() : 'Date unavailable';

                    return `
                    <div class="bg-black/10 dark:bg-white/5 p-4 rounded-lg"> {/* Theme background */}
                        <div class="flex justify-between items-start gap-4 flex-wrap"> {/* Allow wrapping */}
                            <div>
                                <div class="flex items-center gap-3 flex-wrap mb-1"> {/* Margin bottom */}
                                    <span class="font-bold text-lg text-color-base">${trade.symbol?.toUpperCase() || 'N/A'}</span>
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-md ${directionColor}">${trade.direction?.toUpperCase() || 'N/A'}</span> 
                                    ${trade.image ? `<button class="view-chart-btn text-color-muted hover:text-blue-500" data-img-src="${trade.image}"><i class="fas fa-image"></i></button>` : ''}
                                </div>
                                <p class="text-xs text-color-muted">${dateString}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="font-bold text-lg ${plColor}">${(trade.pl || 0).toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</p>
                                <p class="text-xs text-color-muted">${trade.entryPrice || '?'} &rarr; ${trade.exitPrice || '?'} (Size: ${trade.positionSize || '?'})</p>
                            </div>
                        </div>
                        <p class="text-sm text-color-muted mt-2">${trade.notes || ''}</p>
                        <div class="flex justify-between items-end mt-2 pt-2 border-t border-color-base">
                            <div class="flex gap-2 flex-wrap text-xs">${tagsHTML}</div>
                            <button data-id="${trade.id}" class="delete-trade-btn text-xs text-red-500 hover:text-red-400">Delete</button>
                        </div>
                    </div>`; 
                }).join(''); 
            }
            function renderTags() { 
                const allTags = new Set(allTrades.flatMap(t => t.tags || [])); 
                if (allTags.size === 0) { 
                    elements.tagsContainer.innerHTML = '<p class="text-color-muted text-sm">No trades with tags yet.</p>'; 
                    return; 
                } 
                elements.tagsContainer.innerHTML = 
                    `<button class="tag text-xs font-semibold py-1 px-3 ${!activeTag ? 'active' : ''}" data-tag="all">All</button>` + 
                    [...allTags].sort().map(tag => // Sort tags alphabetically
                        `<button class="tag text-xs font-semibold py-1 px-3 ${activeTag === tag ? 'active' : ''}" data-tag="${tag}">#${tag}</button>`
                    ).join(''); 
            }

            // --- Apply Filters ---
            function applyFilters() { 
                filteredTrades = activeTag ? allTrades.filter(t => Array.isArray(t.tags) && t.tags.includes(activeTag)) : allTrades; 
                // Sort filtered trades DESCENDING for the history view
                const sortedForHistory = filteredTrades.slice().sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                renderTrades(sortedForHistory); 
                updateAnalytics(filteredTrades); // Analytics use unfiltered or tag-filtered, order doesn't matter for calc
                renderTags(); // Re-render tags to update active state
            }

             // --- UI Feedback & Modals ---
            function showFormMessage(message, isError = false) { 
                elements.formMessage.textContent = message; 
                elements.formMessage.className = `text-center text-sm mt-3 h-4 ${isError ? 'text-red-400' : 'text-green-400'}`; 
                setTimeout(() => elements.formMessage.textContent = '', 3000); 
            }
            function openModal(modal) { 
                if(!modal) return;
                modal.classList.remove('opacity-0', 'pointer-events-none'); 
                modal.querySelector('.modal-content')?.classList.remove('scale-95'); // Optional: check if content exists
            }
            function closeModal(modal) { 
                if(!modal) return;
                modal.classList.add('opacity-0', 'pointer-events-none'); 
                modal.querySelector('.modal-content')?.classList.add('scale-95'); // Optional: check if content exists
                 // Reset delete ID when closing delete modal
                 if (modal === elements.deleteModal) { tradeToDeleteId = null; }
                 // Clear image source when closing image modal
                 if (modal === elements.imageModal) { setTimeout(() => { elements.modalImageSrc.src = ''; }, 300); }
            }

            // --- Event Listeners ---
            function setupEventListeners() {
                // Form submission
                elements.tradeForm.addEventListener('submit', async (e) => { 
                    e.preventDefault(); 
                    elements.saveBtn.disabled = true; 
                    elements.saveBtn.textContent = 'Saving...'; 
                    const tradeData = { 
                        userId, // Store user ID with trade
                        symbol: elements.tradeForm['trade-symbol'].value, 
                        direction: elements.tradeForm['trade-direction'].value, 
                        entryPrice: parseFloat(elements.tradeForm['trade-entry'].value), 
                        exitPrice: parseFloat(elements.tradeForm['trade-exit'].value), 
                        positionSize: parseFloat(elements.tradeForm['trade-size'].value), 
                        image: elements.tradeForm['trade-image'].value, 
                        tags: elements.tradeForm['trade-tags'].value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean), // Lowercase tags
                        notes: elements.tradeForm['trade-notes'].value, 
                        createdAt: serverTimestamp() 
                    }; 
                    try { 
                        await addDoc(tradesCollectionRef, tradeData); 
                        elements.tradeForm.reset(); 
                        elements.plDisplay.value = ''; 
                        showFormMessage('Trade Saved!'); 
                    } catch (error) { 
                        console.error("Error adding trade: ", error); 
                        showFormMessage('Error: Could not save trade.', true); 
                    } finally { 
                        elements.saveBtn.disabled = false; 
                        elements.saveBtn.textContent = 'Save Trade'; 
                    } 
                }); 

                // Auto P/L calculation on input change
                ['trade-entry', 'trade-exit', 'trade-size', 'trade-direction'].forEach(id => { 
                    const inputElement = elements.tradeForm[id];
                    if (inputElement) {
                       inputElement.addEventListener('input', calculatePL); 
                    }
                }); 

                // Trade history click delegation (Delete / View Chart)
                elements.tradeHistory.addEventListener('click', (e) => { 
                    const deleteButton = e.target.closest('.delete-trade-btn');
                    const viewChartButton = e.target.closest('.view-chart-btn');
                    
                    if (deleteButton) { 
                        tradeToDeleteId = deleteButton.dataset.id; 
                        openModal(elements.deleteModal); 
                    } else if (viewChartButton) { 
                        elements.modalImageSrc.src = viewChartButton.dataset.imgSrc; 
                        openModal(elements.imageModal); 
                    } 
                }); 

                // Tag filtering
                elements.tagsContainer.addEventListener('click', e => { 
                    if (e.target.matches('.tag')) { 
                        const tag = e.target.dataset.tag; 
                        activeTag = tag === 'all' ? null : tag; 
                        applyFilters(); // Apply filter and re-render everything needed
                    } 
                }); 

                // Modal close buttons & background clicks
                [elements.cancelDelete, elements.closeImageModal].forEach(btn => {
                   if(btn) btn.addEventListener('click', () => {
                       closeModal(elements.deleteModal); // Close delete modal on cancel
                       closeModal(elements.imageModal); // Close image modal on its close button
                   });
                });
                [elements.deleteModal, elements.imageModal].forEach(modal => {
                   if(modal) modal.addEventListener('click', e => { 
                       if (e.target === modal) { // Click on modal background
                           closeModal(modal); 
                       } 
                   });
                });

                // Confirm delete button
                if(elements.confirmDelete) elements.confirmDelete.addEventListener('click', async () => { 
                    if (tradeToDeleteId) { 
                        try {
                            elements.confirmDelete.textContent = "Deleting...";
                            elements.confirmDelete.disabled = true;
                            await deleteDoc(doc(db, "trades", tradeToDeleteId)); 
                            console.log("Trade deleted:", tradeToDeleteId);
                        } catch (error) {
                             console.error("Error deleting trade:", error);
                             alert("Error deleting trade. Please try again."); // Simple error feedback
                        } finally {
                            elements.confirmDelete.textContent = "Delete";
                            elements.confirmDelete.disabled = false;
                            closeModal(elements.deleteModal); 
                            // Data will refresh via onSnapshot listener
                        }
                    } 
                }); 
                
                // Close modals on Escape key
                 document.addEventListener('keydown', (e) => { 
                     if (e.key === 'Escape') {
                         if (!elements.deleteModal.classList.contains('opacity-0')) closeModal(elements.deleteModal);
                         if (!elements.imageModal.classList.contains('opacity-0')) closeModal(elements.imageModal);
                     }
                 });

            } // End of setupEventListeners

            // --- Firestore Listener Setup ---
            function listenForTrades() {
                const q = query(tradesCollectionRef, where("userId", "==", userId), orderBy("createdAt", "desc")); 
                onSnapshot(q, (snapshot) => { 
                    allTrades = snapshot.docs.map(doc => {
                         const data = doc.data();
                         // Calculate P/L here if not stored, ensure values are numbers
                         const entry = Number(data.entryPrice) || 0;
                         const exit = Number(data.exitPrice) || 0;
                         const size = Number(data.positionSize) || 0; // Default to 0 if not present/invalid
                         const pl = (data.direction === 'long' ? (exit - entry) : (entry - exit)) * size;
                         
                         return { 
                             id: doc.id, 
                             ...data, 
                             pl: isNaN(pl) ? 0 : pl // Ensure pl is a number, default to 0
                         };
                    }); 
                    applyFilters(); // Apply current filter (or show all) and update UI
                }, (error) => { 
                    console.error("Error fetching trades:", error); 
                    elements.tradeHistory.innerHTML = `<p class="text-center text-red-500">Error loading trades. ${error.code === 'failed-precondition' ? 'Database index required - check console.' : ''}</p>`; 
                });
            }

            // --- Initial Setup ---
            initEquityChart(); // Initialize chart structure
            setupEventListeners(); // Attach all event handlers
            listenForTrades(); // Start listening for Firestore data

        } // End of initJournalPage function

        // Initialize the app core, passing in the page-specific setup function
        initializeAppCore(initJournalPage);
    </script>
</body>
</html>
