<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal | Finex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    <style>
        details[open] > summary .chevron-icon { transform: rotate(180deg); }
        summary .chevron-icon { transition: transform 0.2s ease-in-out; }
        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }
        
        .glass-card-inset { @apply bg-gray-100 dark:bg-white/5 p-3 rounded-lg; }
        .stat-card { @apply bg-gray-100 dark:bg-white/5 p-3 rounded-lg; }
        .stat-title { @apply text-xs sm:text-sm font-medium text-color-muted uppercase tracking-wider block mb-1; }
        .stat-value { @apply text-lg sm:text-xl font-bold text-color-base; }

        /* === NEW CUSTOM DROPDOWN STYLES (EXPANDED) === */
        .custom-select-wrapper { 
            position: relative; 
        }
        .custom-select-trigger {
            /* Inherits from .form-input in main.css */
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        /* Chevron icon styling is now in the HTML classes */
        .custom-select-wrapper.open .custom-select-trigger .fa-chevron-down {
            transform: rotate(180deg);
        }
        .custom-select-options {
            position: absolute;
            z-index: 20;
            width: 100%;
            background-color: #f4f6f9; /* Light mode background */
            border: 1px solid rgba(0, 0, 0, 0.1); /* Light mode border */
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            max-height: 12rem;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: none;
        }
        .dark .custom-select-options {
            background-color: #1f2937; /* Dark mode background (gray-800) */
            border-color: rgba(255, 255, 255, 0.1); /* Dark mode border */
        }
        .custom-select-wrapper.open .custom-select-options { 
            display: block; 
        }
        .custom-option {
            padding: 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            color: #1f2937; /* Light mode text */
        }
        .dark .custom-option {
            color: #f4f6f9; /* Dark mode text */
        }
        .custom-option:hover {
            background-color: #dbeafe; /* Light mode hover (blue-100) */
        }
        .dark .custom-option:hover {
            background-color: rgba(59, 130, 246, 0.2); /* Dark mode hover (blue-500/20) */
        }
        .custom-option.selected {
            background-color: #dbeafe; /* Light mode selected (blue-100) */
            font-weight: 600;
        }
        .dark .custom-option.selected {
            background-color: rgba(59, 130, 246, 0.2); /* Dark mode selected (blue-500/20) */
        }

        /* Color styles for triggers */
        .source-impulse { @apply !border-yellow-500/50 !bg-yellow-500/5; }
        .source-watchlist { @apply !border-blue-500/50 !bg-blue-500/5; }
        .source-focus { @apply !border-green-500/50 !bg-green-500/5; }
        .dir-long { @apply !border-green-500/50 !bg-green-500/5; }
        .dir-short { @apply !border-red-500/50 !bg-red-500/5; }
        /* === END OF NEW STYLES === */
    </style>
</head>
<body class="antialiased textured-background">
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div class="min-h-screen flex flex-col">
            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                        
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold text-center mb-4">Performance Analytics</h2>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="stat-card"><h4 class="stat-title">Total P/L</h4><p id="total-pl" class="stat-value">-$--.--</p></div>
                                <div class="stat-card"><h4 class="stat-title">Total Trades</h4><p id="total-trades" class="stat-value">0</p></div>
                                <div class="stat-card"><h4 class="stat-title">Win Rate</h4><p id="win-rate" class="stat-value">--%</p></div>
                                <div class="stat-card"><h4 class="stat-title">Profit Factor</h4><p id="profit-factor" class="stat-value">--</p></div>
                                <div class="stat-card"><h4 class="stat-title">Planned P/L</h4><p id="planned-pl" class="stat-value">-$--.--</p></div>
                                <div class="stat-card"><h4 class="stat-title">Impulse P/L</h4><p id="impulse-pl" class="stat-value">-$--.--</p></div>
                                <div class="stat-card col-span-2"><h4 class="stat-title">Avg Win / Loss</h4><p id="avg-win-loss" class="stat-value !text-lg">-$-- / -$--</p></div>
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Equity Curve</h2>
                            <div style="height: 250px;"><canvas id="equity-curve-chart"></canvas></div>
                        </div>
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Filter by Tag</h2>
                            <div id="tags-container" class="flex flex-wrap gap-2"><p class="text-color-muted text-sm">Loading tags...</p></div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-8">
                        <div class="glass-card">
                            <details class="group" open> <summary class="p-6 cursor-pointer flex justify-between items-center list-none group-open:border-b group-open:border-color-base">
                                    <h2 class="text-2xl font-bold">Log a New Trade</h2>
                                    <i class="fas fa-chevron-down chevron-icon text-color-muted group-hover:text-color-base"></i>
                                </summary>
                                
                                <form id="trade-form" class="space-y-4 p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="text-sm text-color-muted block mb-1">Symbol</label>
                                            <input type="text" id="trade-symbol" required class="form-input w-full" placeholder="e.g., EUR/USD">
                                        </div>
                                        
                                        <div class="custom-select-wrapper">
                                            <label class="text-sm text-color-muted block mb-1">Direction</label>
                                            <input type="hidden" id="trade-direction" name="trade-direction" value="long">
                                            <div class="custom-select-trigger dir-long" data-dropdown-trigger="trade-direction">
                                                <span>Long</span>
                                                <i class="fas fa-chevron-down text-color-muted text-xs transition-transform duration-200"></i>
                                            </div>
                                            <div class="custom-select-options">
                                                <div class="custom-option selected" data-value="long">Long</div>
                                                <div class="custom-option" data-value="short">Short</div>
                                            </div>
                                        </div>
                                        
                                        <div class="custom-select-wrapper">
                                            <label class="text-sm text-color-muted block mb-1">Setup Source</label>
                                            <input type="hidden" id="trade-setup-source" name="trade-setup-source" value="impulse">
                                            <div class="custom-select-trigger source-impulse" data-dropdown-trigger="trade-setup-source">
                                                <span>Unplanned / Impulse</span>
                                                <i class="fas fa-chevron-down text-color-muted text-xs transition-transform duration-200"></i>
                                            </div>
                                            <div class="custom-select-options">
                                                <div class="custom-option selected" data-value="impulse">Unplanned / Impulse</div>
                                                <div class="custom-option" data-value="watchlist">From Watchlist</div>
                                                <div class="custom-option" data-value="focus">From Top Pairs Focus</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div><label class="text-sm text-color-muted block mb-1">Entry</label><input type="number" step="any" id="trade-entry" required class="form-input w-full"></div>
                                        <div><label class="text-sm text-color-muted block mb-1">Exit</label><input type="number" step="any" id="trade-exit" required class="form-input w-full"></div>
                                        <div><label class="text-sm text-color-muted block mb-1">Size</label><input type="number" step="any" id="trade-size" required class="form-input w-full" placeholder="Shares/Lots"></div>
                                        <div><label class="text-sm text-color-muted block mb-1">P/L ($)</label><input type="text" id="trade-pl-display" readonly class="form-input w-full bg-black/10 dark:bg-white/5 cursor-not-allowed"></div>
                                    </div>
                                    <div><label class="text-sm text-color-muted block mb-1">Chart Screenshot URL</label><input type="url" id="trade-image" class="form-input w-full" placeholder="Paste image link here..."></div>
                                    <div><label class="text-sm text-color-muted block mb-1">Tags (comma-separated)</label><input type="text" id="trade-tags" class="form-input w-full" placeholder="#breakout, #followed_plan..."></div>
                                    <div><label class="text-sm text-color-muted block mb-1">Notes / Setup</label><textarea id="trade-notes" rows="3" class="form-textarea w-full" placeholder="Why did you take this trade? What was your mindset?"></textarea></div>
                                    <button type="submit" id="save-trade-btn" class="main-button w-full font-bold py-3">Save Trade</button>
                                    <p id="form-message" class="text-center text-sm mt-3 h-4"></p>
                                </form>
                                </details>
                        </div>

                        <div id="weekly-plan-card" class="glass-card p-6">
                            <div class="flex flex-wrap justify-between items-center gap-2 mb-4">
                                <h2 class="text-2xl font-bold">This Week's Plan</h2>
                                <a href="weekly_checklist.html" class="main-button-ghost text-sm py-1 px-3">Edit Plan <i class="fas fa-arrow-right ml-1"></i></a>
                            </div>
                            <div id="weekly-plan-loading"><p class="text-color-muted text-sm text-center">Loading weekly plan...</p></div>
                            <div id="weekly-plan-content" class="hidden space-y-4">
                                <div>
                                    <h3 class="font-semibold text-color-base mb-2">Top Pairs Focus</h3>
                                    <div id="weekly-plan-focus" class="space-y-2"></div>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-color-base mb-2">Watchlist</h3>
                                    <div id="weekly-plan-watchlist" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                            <div id="weekly-plan-empty" class="hidden"><p class="text-color-muted text-sm text-center">No weekly plan found. <a href="weekly_checklist.html" class="text-blue-500 hover:underline">Create one now</a>.</p></div>
                        </div>

                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Trade History</h2>
                            <div id="trade-history" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"><p class="text-center text-color-muted">Loading trades...</p></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal"><div class="modal-content glass-card p-8 rounded-2xl w-full max-w-sm text-center transform scale-95"><h2 class="text-xl font-bold mb-4">Confirm Deletion</h2><p class="text-color-muted mb-6">Are you sure?</p><div class="flex gap-4"><button id="cancel-delete-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">Cancel</button><button id="confirm-delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">Delete</button></div></div></div>
        <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal"><button id="close-image-modal" class="absolute top-4 right-6 text-white text-4xl hover:opacity-75">&times;</button><div class="modal-content w-full h-full flex items-center justify-center transform scale-95"><img id="modal-image-src" src="" alt="Trade Screenshot" class="max-w-[90vw] max-h-[90vh] rounded-lg"></div></div>
        </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { initializeAppCore, db, auth, getWeekId } from './app.js';
        import { collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        function initJournalPage(user, db) {
            console.log("Setting up Trading Journal specific logic...");
            
            // === THIS JAVASCRIPT IS UPDATED ===
            
            const elements = { 
                totalPl: document.getElementById('total-pl'), totalTrades: document.getElementById('total-trades'),
                winRate: document.getElementById('win-rate'), profitFactor: document.getElementById('profit-factor'),
                plannedPl: document.getElementById('planned-pl'), impulsePl: document.getElementById('impulse-pl'),
                avgWinLoss: document.getElementById('avg-win-loss'), tradeHistory: document.getElementById('trade-history'),
                tradeForm: document.getElementById('trade-form'), saveBtn: document.getElementById('save-trade-btn'),
                formMessage: document.getElementById('form-message'), deleteModal: document.getElementById('delete-modal'),
                cancelDelete: document.getElementById('cancel-delete-btn'), confirmDelete: document.getElementById('confirm-delete-btn'),
                imageModal: document.getElementById('image-modal'), closeImageModal: document.getElementById('close-image-modal'),
                modalImageSrc: document.getElementById('modal-image-src'), tagsContainer: document.getElementById('tags-container'),
                plDisplay: document.getElementById('trade-pl-display'), chartCanvas: document.getElementById('equity-curve-chart'),
                weeklyPlanLoading: document.getElementById('weekly-plan-loading'), weeklyPlanContent: document.getElementById('weekly-plan-content'),
                weeklyPlanEmpty: document.getElementById('weekly-plan-empty'), weeklyPlanFocus: document.getElementById('weekly-plan-focus'), 
                weeklyPlanWatchlist: document.getElementById('weekly-plan-watchlist'),
            };

            let allTrades = []; let filteredTrades = []; let activeTag = null;
            let equityChart = null; let tradeToDeleteId = null; const userId = user.uid;
            const tradesCollectionRef = collection(db, "trades");

            let missingElement = false;
            for (const key in elements) { if (!elements[key]) { console.error(`Error: Element ID '${key}' not found!`); missingElement = true; } }
            if(missingElement) { const main = document.querySelector('main'); if(main) main.innerHTML = "<p class='text-red-500 text-center p-8'>Error initializing page.</p>"; return; }

            // --- P/L Calc, Analytics, Chart, Rendering, Filters, Modals, Event Listeners (Minified) ---
            const calculatePL=()=>{const e=parseFloat(elements.tradeForm["trade-entry"]?.value)||0,t=parseFloat(elements.tradeForm["trade-exit"]?.value)||0,l=parseFloat(elements.tradeForm["trade-size"]?.value)||0,a=elements.tradeForm["trade-direction"]?.value;let d=("long"===a?t-e:e-t)*l;elements.plDisplay.value=isNaN(d)?"":d.toLocaleString("en-US",{style:"currency",currency:"USD"})};
            
            function updateAnalytics(e){const t=e.length,l=e.reduce((e,t)=>e+(t.pl||0),0),a=e.filter(e=>e.pl>0),d=e.filter(e=>e.pl<0),n=t>0?a.length/t*100:0,o=a.reduce((e,t)=>e+t.pl,0),s=Math.abs(d.reduce((e,t)=>e+t.pl,0)),r=s>0?o/s:o>0?1/0:0,i=a.length>0?o/a.length:0,c=d.length>0?s/d.length:0;const p=e.filter(e=>"focus"===e.setupSource||"watchlist"===e.setupSource),u=e.filter(e=>"impulse"===e.setupSource||!e.setupSource),m=p.reduce((e,t)=>e+(t.pl||0),0),g=u.reduce((e,t)=>e+(t.pl||0),0);elements.plannedPl&&(elements.plannedPl.textContent=m.toLocaleString("en-US",{style:"currency",currency:"USD"}),elements.plannedPl.className=`stat-value ${m>=0?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400"}`),elements.impulsePl&&(elements.impulsePl.textContent=g.toLocaleString("en-US",{style:"currency",currency:"USD"}),elements.impulsePl.className=`stat-value ${g>=0?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400"}`),elements.totalPl.textContent=l.toLocaleString("en-US",{style:"currency",currency:"USD"}),elements.totalPl.className=`stat-value ${l>=0?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400"}`,elements.totalTrades.textContent=t,elements.winRate.textContent=`${n.toFixed(1)}%`,elements.profitFactor.textContent=isFinite(r)?r.toFixed(2):"∞",elements.avgWinLoss.innerHTML=`<span class="text-green-500 dark:text-green-400">${i.toLocaleString("en-US",{style:"currency",currency:"USD"})}</span> / <span class="text-red-500 dark:text-red-400">${c.toLocaleString("en-US",{style:"currency",currency:"USD"})}</span>`,updateEquityCurve(e)}

            function initEquityChart(){if(equityChart){equityChart.destroy();}const e=elements.chartCanvas.getContext("2d"),t=document.documentElement.classList.contains("dark"),l=t?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",a=t?"#a9a9b3":"#4b5563",d=t?"#0065ff":"#0052cc";equityChart=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:d,tension:.1,fill:!1,pointRadius:0,pointHoverRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{ticks:{display:!1},grid:{color:l,drawBorder:!1}},y:{grid:{color:l,drawBorder:!1},ticks:{color:a}}},interaction:{intersect:!1,mode:"index"}}})}
            function updateEquityCurve(e){if(!equityChart)return;let t=0;const l=e.slice().filter(e=>e.createdAt?.toDate).sort((e,t)=>e.createdAt.toDate()-t.createdAt.toDate()),a=l.map(e=>t+=(e.pl||0)),d=l.map((e,t)=>t+1);equityChart.data.labels=[0,...d],equityChart.data.datasets[0].data=[0,...a],equityChart.update("none")}
            
            function renderTrades(e){if(0===e.length){elements.tradeHistory.innerHTML=`<p class="text-center text-color-muted">No trades ${activeTag?`with tag #${activeTag}`:"logged yet"}.</p>`;return}elements.tradeHistory.innerHTML=e.map(e=>{const t=(e.pl||0)>=0?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",l="long"===e.direction?"bg-green-600/20 text-green-400":"bg-red-600/20 text-red-400";let s="bg-gray-600/20 text-gray-400",i=e.setupSource?e.setupSource.replace("_"," "):"N/A";"focus"===e.setupSource?(s="bg-green-600/20 text-green-400",i="Focus Pair"):"watchlist"===e.setupSource?(s="bg-blue-600/20 text-blue-400",i="Watchlist"):"impulse"===e.setupSource&&(s="bg-yellow-600/20 text-yellow-400",i="Impulse");const a=Array.isArray(e.tags)&&e.tags.length>0?e.tags.map(e=>`<span class="tag text-xs font-semibold py-1 px-3 mr-1 mb-1 inline-block">#${e}</span>`).join(""):`<span class="text-xs text-color-muted italic">No tags</span>`,d=e.createdAt?.toDate()?e.createdAt.toDate().toLocaleString():"Date unavailable";return`\n                        <div class="glass-card-inset p-4 rounded-lg">\n                            <div class="grid grid-cols-3 gap-4 mb-3">\n                                <div class="col-span-2 flex items-center gap-2 flex-wrap">\n                                    <span class="font-bold text-xl text-color-base">${e.symbol?.toUpperCase()||"N/A"}</span>\n                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-md ${l}">${e.direction?.toUpperCase()||"N/A"}</span>\n                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-md ${s}">${i}</span>\n                                </div>\n                                <div class="text-right"><p class="font-bold text-xl ${t}">${(e.pl||0).toLocaleString("en-US",{style:"currency",currency:"USD"})}</p></div>\n                            </div>\n                            <div class="grid grid-cols-2 gap-4 text-xs text-color-muted mb-3">\n                                <div><span class="font-semibold">Entry/Exit:</span> <span>${e.entryPrice??"?"} &rarr; ${e.exitPrice??"?"} (Size: ${e.positionSize??"?"})</span></div>\n                                <div class="text-right"><span class="font-semibold">Date:</span> <span>${d}</span></div>\n                            </div>\n                            <p class="text-sm text-color-base bg-black/10 dark:bg-white/5 p-3 rounded-md mb-3 break-words">${e.notes||'<i class="text-color-muted">No notes provided.</i>'}</p>\n                            <div class="flex justify-between items-center mt-2 pt-2 border-t border-color-base">\n                                <div class="flex gap-1 flex-wrap">${a}</div>\n                                <div class="flex-shrink-0 flex gap-3">\n                                    ${e.image?`<button class="view-chart-btn text-sm text-color-muted hover:text-blue-500" data-img-src="${e.image}"><i class="fas fa-image mr-1"></i>View Chart</button>`:""}\n                                    <button data-id="${e.id}" class="delete-trade-btn text-sm text-red-500 hover:text-red-400"><i class="fas fa-trash-alt mr-1"></i>Delete</button>\n                                </div>\n                            </div>\n                        </div>`}).join("")}

            function renderTags(){const e=new Set(allTrades.flatMap(e=>e.tags||[]));if(0===e.size){elements.tagsContainer.innerHTML='<p class="text-color-muted text-sm">No trades with tags yet.</p>';return}elements.tagsContainer.innerHTML=`<button class="tag text-xs font-semibold py-1 px-3 ${activeTag?null:"active"}" data-tag="all">All</button>`+[...e].sort().map(e=>`<button class="tag text-xs font-semibold py-1 px-3 ${activeTag===e?"active":""}" data-tag="${e}">#${e}</button>`).join("")}
            function applyFilters(){filteredTrades=activeTag?allTrades.filter(e=>Array.isArray(e.tags)&&e.tags.includes(activeTag)):allTrades;const e=filteredTrades.slice().sort((e,t)=>(t.createdAt?.toDate()??0)-(e.createdAt?.toDate()??0));renderTrades(e),updateAnalytics(filteredTrades),renderTags()}
            function showFormMessage(e,t=!1){elements.formMessage.textContent=e,elements.formMessage.className=`text-center text-sm mt-3 h-4 ${t?"text-red-400":"text-green-400"}`,setTimeout(()=>elements.formMessage.textContent="",3e3)}
            function openModal(e){if(!e)return;e.classList.remove("opacity-0","pointer-events-none"),e.querySelector(".modal-content")?.classList.remove("scale-95")}
            function closeModal(e){if(!e)return;e.classList.add("opacity-0","pointer-events-none"),e.querySelector(".modal-content")?.classList.add("scale-95"),e===elements.deleteModal&&(tradeToDeleteId=null),e===elements.imageModal&&setTimeout(()=>{elements.modalImageSrc.src=""},300)}
            
            // === NEW FUNCTION FOR CUSTOM DROPDOWNS ===
            function setupCustomDropdowns() {
                document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
                    const trigger = wrapper.querySelector('.custom-select-trigger');
                    const optionsContainer = wrapper.querySelector('.custom-select-options');
                    const hiddenInput = wrapper.querySelector('input[type="hidden"]');
                    const triggerText = trigger.querySelector('span');

                    // 1. Toggle dropdown
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Close all other dropdowns
                        document.querySelectorAll('.custom-select-wrapper.open').forEach(openWrapper => {
                            if (openWrapper !== wrapper) {
                                openWrapper.classList.remove('open');
                            }
                        });
                        wrapper.classList.toggle('open');
                    });

                    // 2. Handle option selection
                    optionsContainer.addEventListener('click', (e) => {
                        const option = e.target.closest('.custom-option');
                        if (!option) return;

                        const selectedValue = option.dataset.value;
                        const selectedText = option.textContent;

                        // Update hidden input
                        hiddenInput.value = selectedValue;
                        // Update trigger text
                        triggerText.textContent = selectedText;

                        // Update selected state in options
                        optionsContainer.querySelectorAll('.custom-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');

                        // Update trigger colors
                        updateDropdownColor(trigger, selectedValue);
                        
                        // Manually trigger 'input' event on hidden input for P/L calc
                        if (hiddenInput.id === 'trade-direction') {
                            calculatePL();
                        }

                        wrapper.classList.remove('open');
                    });
                });

                // 3. Close when clicking outside
                document.addEventListener('click', () => {
                    document.querySelectorAll('.custom-select-wrapper.open').forEach(wrapper => {
                        wrapper.classList.remove('open');
                    });
                });
            }

            // === NEW FUNCTION TO STYLE DROPDOWNS ===
            function updateDropdownColor(triggerElement, value) {
                if (!triggerElement) return;
                
                // Clear all color classes
                triggerElement.classList.remove('source-impulse', 'source-watchlist', 'source-focus', 'dir-long', 'dir-short');
                
                if (value === 'impulse') triggerElement.classList.add('source-impulse');
                else if (value === 'watchlist') triggerElement.classList.add('source-watchlist');
                else if (value === 'focus') triggerElement.classList.add('source-focus');
                else if (value === 'long') triggerElement.classList.add('dir-long');
                else if (value === 'short') triggerElement.classList.add('dir-short');
            }

            // === THIS FUNCTION IS UPDATED ===
            function setupEventListeners(){
                // Note: The form submit now reads from the hidden inputs, which have the correct IDs.
                // The 't' (tradeData) object is UNCHANGED and works correctly.
                elements.tradeForm.addEventListener("submit",async e=>{e.preventDefault(),elements.saveBtn.disabled=!0,elements.saveBtn.textContent="Saving...";const t={userId:userId,symbol:elements.tradeForm["trade-symbol"].value,direction:elements.tradeForm["trade-direction"].value,setupSource:elements.tradeForm["trade-setup-source"].value,entryPrice:parseFloat(elements.tradeForm["trade-entry"].value),exitPrice:parseFloat(elements.tradeForm["trade-exit"].value),positionSize:parseFloat(elements.tradeForm["trade-size"].value),image:elements.tradeForm["trade-image"].value,tags:elements.tradeForm["trade-tags"].value.split(",").map(e=>e.trim().toLowerCase()).filter(Boolean),notes:elements.tradeForm["trade-notes"].value,createdAt:serverTimestamp()};try{await addDoc(tradesCollectionRef,t),elements.tradeForm.reset(),elements.plDisplay.value="",
                
                // Manually reset custom dropdowns
                document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
                    const hiddenInput = wrapper.querySelector('input[type="hidden"]');
                    const optionsContainer = wrapper.querySelector('.custom-select-options');
                    const firstOption = optionsContainer.querySelector('.custom-option');
                    if (firstOption) {
                        const defaultValue = firstOption.dataset.value;
                        const defaultText = firstOption.textContent;
                        hiddenInput.value = defaultValue;
                        wrapper.querySelector('.custom-select-trigger span').textContent = defaultText;
                        optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                        firstOption.classList.add('selected');
                        updateDropdownColor(wrapper.querySelector('.custom-select-trigger'), defaultValue);
                    }
                });
                
                showFormMessage("Trade Saved!")}catch(e){console.error("Error adding trade:",e),showFormMessage("Error: Could not save trade.",!0)}finally{elements.saveBtn.disabled=!1,elements.saveBtn.textContent="Save Trade"}}),
                
                // Updated P/L calc listeners
                ["trade-entry","trade-exit","trade-size"].forEach(e=>{const t=elements.tradeForm[e];t&&t.addEventListener("input",calculatePL)}),
                
                elements.tradeHistory.addEventListener("click",e=>{const t=e.target.closest(".delete-trade-btn"),l=e.target.closest(".view-chart-btn");t?(tradeToDeleteId=t.dataset.id,openModal(elements.deleteModal)):l&&(elements.modalImageSrc.src=l.dataset.imgSrc,openModal(elements.imageModal))}),elements.tagsContainer.addEventListener("click",e=>{if(e.target.matches(".tag")){const t=e.target.dataset.tag;activeTag="all"===t?null:t,applyFilters()}}),[elements.cancelDelete,elements-closeImageModal].forEach(e=>{e&&e.addEventListener("click",()=>{closeModal(elements.deleteModal),closeModal(elements.imageModal)})}),[elements.deleteModal,elements.imageModal].forEach(e=>{e&&e.addEventListener("click",t=>{t.target===e&&closeModal(e)})}),elements.confirmDelete&&elements.confirmDelete.addEventListener("click",async()=>{if(tradeToDeleteId){try{elements.confirmDelete.textContent="Deleting...",elements.confirmDelete.disabled=!0,await deleteDoc(doc(db,"trades",tradeToDeleteId)),console.log("Trade deleted:",tradeToDeleteId)}catch(e){console.error("Error deleting trade:",e),alert("Error deleting trade.")}finally{elements.confirmDelete.textContent="Delete",elements.confirmDelete.disabled=!1,closeModal(elements.deleteModal)}}}),document.addEventListener("keydown",e=>{if("Escape"===e.key){elements.deleteModal&&!elements.deleteModal.classList.contains("opacity-0")&&closeModal(elements.deleteModal),elements.imageModal&&!elements.imageModal.classList.contains("opacity-0")&&closeModal(elements.imageModal)}})
            
                // Call the new dropdown setup function
                setupCustomDropdowns();
            }
            // === END OF UPDATE ===


            // --- Firestore Listeners ---
            function listenForTrades() {
                const q=query(tradesCollectionRef,where("userId","==",userId),orderBy("createdAt","desc")); onSnapshot(q,(snapshot)=>{allTrades=snapshot.docs.map(doc=>{const data=doc.data(); const entry=Number(data.entryPrice)||0; const exit=Number(data.exitPrice)||0; const size=Number(data.positionSize)||0; const pl=(data.direction==='long'?(exit-entry):(entry-exit))*size; const createdAt=data.createdAt; return{id:doc.id,...data,createdAt,pl:isNaN(pl)?0:pl};}); applyFilters();},(error)=>{console.error("Error fetching trades:",error); elements.tradeHistory.innerHTML=`<p class="text-center text-red-500">Error loading trades. ${error.code==='failed-precondition'?'Index required.':''}</p>`;});
            }
            
            function listenForWeeklyPlan() {
                const currentWeekId = getWeekId(new Date()); 
                const checklistDocRef = doc(db, `users/${userId}/weeklyChecklists`, currentWeekId); 
                
                onSnapshot(checklistDocRef, (doc) => {
                    elements.weeklyPlanLoading.style.display = 'none'; 
                    if (doc.exists()) {
                        const data = doc.data(); 
                        
                        if (Array.isArray(data.topFocusPairs) && data.topFocusPairs.length > 0) {
                            elements.weeklyPlanFocus.innerHTML = data.topFocusPairs.map(fp => `
                                <div class="glass-card-inset p-3">
                                    <p class="font-bold text-color-base">${fp.pair}</p>
                                    <p class="text-color-muted text-sm whitespace-pre-wrap">${fp.reason || '<i class="text-color-muted">No reason added.</i>'}</p>
                                </div>
                            `).join('');
                        } else if (data.topPairsFocus) { 
                            elements.weeklyPlanFocus.innerHTML = `<p class="text-color-muted text-sm whitespace-pre-wrap rounded-lg bg-gray-100 dark:bg-white/5 p-3">${data.topPairsFocus}</p>`;
                        } else {
                            elements.weeklyPlanFocus.innerHTML = '<p class="text-color-muted text-sm italic">No focus pairs set for this week.</p>';
                        }

                        let combinedWatchlist=[]; 
                        if(Array.isArray(data.watchlist)){combinedWatchlist=[...data.watchlist];} 
                        if(combinedWatchlist.length===0&&typeof data.otherPairs==='string'&&data.otherPairs){const others=data.otherPairs.split(',').map(p=>p.trim().toUpperCase()).filter(Boolean); combinedWatchlist.push(...others);} 
                        
                        if(combinedWatchlist.length>0){
                            elements.weeklyPlanWatchlist.innerHTML=combinedWatchlist.sort().map(pair=>`<span class="tag text-xs font-semibold py-1 px-3">${pair}</span>`).join('');
                        } else {
                            elements.weeklyPlanWatchlist.innerHTML='<p class="text-color-muted text-sm italic">No watchlist set for this week.</p>';
                        } 
                        
                        elements.weeklyPlanContent.classList.remove('hidden'); 
                        elements.weeklyPlanEmpty.classList.add('hidden');
                    } else {
                        elements.weeklyPlanContent.classList.add('hidden'); 
                        elements.weeklyPlanEmpty.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("Error fetching weekly plan:", error); 
                    elements.weeklyPlanLoading.style.display='none'; 
                    elements.weeklyPlanEmpty.classList.remove('hidden'); 
                    elements.weeklyPlanEmpty.innerHTML='<p class="text-red-500 text-sm">Error loading weekly plan.</p>';
                });
            }

            // --- Initial Setup ---
            initEquityChart();
            setupEventListeners();
            listenForTrades();
            listenForWeeklyPlan();

        } // End initJournalPage
        initializeAppCore(initJournalPage);
    </script>
</body>
</html>
