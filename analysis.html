<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis | Finex</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    <style>
        #image-modal { transition: opacity 0.3s ease-in-out; }
        #modal-image { transition: transform 0.3s ease-in-out; }
        /* Add open/close state styles if not handled by JS opacity toggle */
        #image-modal:not(.opacity-100) #modal-image { transform: scale(0.95); } 
        #image-modal.opacity-100 #modal-image { transform: scale(1); } 
    </style>
</head>
<body class="antialiased textured-background">
    <div id="app-wrapper" style="display: none;">
        
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div>
            /* Removed min-h-screen flex flex-col here, might not be needed */
            <main class="container mx-auto p-4 md:p-8">
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold text-color-base">Analysis Gallery</h1>
                     <p class="text-lg text-color-muted mt-4 max-w-2xl mx-auto">Browse the latest market analysis charts and images from the Finex team.</p>
                </div>
                <div id="analysis-container" class="space-y-12">
                    <p id="loading-message" class="text-center text-color-muted col-span-full">Loading analysis...</p>
                    </div>
            </main>
        </div>

        <div id="image-modal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-white text-4xl leading-none hover:opacity-75 transition-opacity">&times;</button>
            <div class="w-full h-full flex items-center justify-center">
                <img id="modal-image" src="" alt="Full-size analysis image" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl object-contain">
            </div>
        </div>
        </div>

    <script type="module" src="app.js"></script>
    
    <script type="module">
        // Import the core initializer and db instance from app.js
        import { initializeAppCore, db } from './app.js';
        // Import Firestore functions needed specifically for this page
        import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // Define the function containing this page's unique JavaScript logic
        function initAnalysisPage(user, db) {
            console.log("Setting up Analysis page specific logic...");

            // Get elements specific to this page
            const analysisContainer = document.getElementById('analysis-container');
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const loadingMsg = document.getElementById('loading-message'); // Get loading message element

            // Check if essential elements exist
            if (!analysisContainer || !modal || !modalImage || !closeModalBtn || !loadingMsg) {
                 console.error("One or more elements required for the Analysis page were not found.");
                 if(analysisContainer) analysisContainer.innerHTML = "<p class='text-red-500 text-center'>Error: Page elements missing.</p>";
                 return;
            }

            // --- Fetch and Display Analysis Items ---
            function fetchAnalysis() {
                // Query Firestore for analysis items, ordered by creation date descending
                onSnapshot(query(collection(db, "analysis"), orderBy("createdAt", "desc")), (snapshot) => {
                    
                    loadingMsg.style.display = 'none'; // Hide loading message once data arrives (or doesn't)
                    
                    // Handle empty results
                    if (snapshot.empty) { 
                        analysisContainer.innerHTML = '<p class="text-center text-color-muted">No analysis has been posted yet.</p>'; 
                        return; 
                    }
                    
                    // Group items by date
                    const groupedByDate = {};
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        // Ensure createdAt is a Firestore Timestamp before converting
                        if (item.createdAt && typeof item.createdAt.toDate === 'function') {
                            const date = item.createdAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                            if (!groupedByDate[date]) groupedByDate[date] = [];
                            groupedByDate[date].push(item);
                        } else {
                            console.warn("Analysis item missing or has invalid 'createdAt' field:", item);
                        }
                    });
                    
                    analysisContainer.innerHTML = ''; // Clear previous content
                    
                    // Render items grouped by date
                    for (const date in groupedByDate) {
                        const dateGroupEl = document.createElement('div');
                        let imageGridHTML = groupedByDate[date].map(item => `
                            <div class="glass-card group overflow-hidden cursor-pointer" data-full-src="${item.imageUrl}" data-title="${item.title || 'Analysis Image'}">
                                <img src="${item.imageUrl}" alt="${item.title || 'Analysis Image'}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy">
                                <div class="p-4"><p class="font-semibold text-color-base truncate" title="${item.title || ''}">${item.title || 'Untitled Analysis'}</p></div>
                            </div>`).join('');
                            
                        dateGroupEl.innerHTML = `
                            <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">${date}</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${imageGridHTML}
                            </div>`;
                        analysisContainer.appendChild(dateGroupEl);
                    }
                }, (error) => {
                    console.error("Error fetching analysis data:", error);
                    loadingMsg.style.display = 'none';
                    analysisContainer.innerHTML = '<p class="text-center text-red-500">Could not load analysis data.</p>';
                });
            }

            // --- Modal Logic ---
            function openModal(imageUrl, altText) { 
                modalImage.src = imageUrl; 
                modalImage.alt = altText || 'Analysis Image'; 
                modal.classList.add('opacity-100'); // Use opacity for transition
                modal.classList.remove('pointer-events-none'); 
            }
            function closeModal() { 
                modal.classList.remove('opacity-100'); 
                modal.classList.add('pointer-events-none'); 
                // Delay clearing src to avoid visual glitch during fade out
                setTimeout(() => { modalImage.src = ""; modalImage.alt = ""; }, 300); // Match CSS transition duration
            }

            // --- Event Listeners ---
            analysisContainer.addEventListener('click', (e) => { 
                const card = e.target.closest('[data-full-src]'); 
                if (card) {
                    openModal(card.dataset.fullSrc, card.dataset.title); 
                }
            });
            closeModalBtn.addEventListener('click', closeModal);
            // Close modal if clicking outside the image area
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) { // Check if the click was directly on the background overlay
                    closeModal(); 
                }
            }); 
            // Close modal on Escape key press
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape' && modal.classList.contains('opacity-100')) { // Check if modal is open
                    closeModal(); 
                }
            });

            // Initial fetch of analysis data
            fetchAnalysis(); 
        }

        // Initialize the app core, passing in the page-specific setup function
        initializeAppCore(initAnalysisPage);
    </script>
</body>
</html>
