<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Analysis | Finex Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --sidebar-width: 18rem; }
        html { scroll-behavior: smooth; }
        body { background-color: #111827; color: #f9fafb; font-family: 'Source Sans Pro', sans-serif; }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        
        /* Form Styles */
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #9ca3af; }
        .form-input, .form-textarea, .form-select {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: rgba(0, 82, 204, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.3);
        }
        .form-textarea { min-height: 120px; }

        /* Button Styles */
        .main-button { background-color: #0052cc; color: white; transition: background-color 0.3s ease; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
        .main-button:hover { background-color: #0065ff; }
        .secondary-button { background-color: #4a5568; color: white; transition: background-color 0.3s ease; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
        .secondary-button:hover { background-color: #2d3748; }
        .delete-button { background-color: #e53e3e; color: white; transition: background-color 0.3s ease; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .delete-button:hover { background-color: #c53030; }
        .edit-button { background-color: #4a5568; color: white; transition: background-color 0.3s ease; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .edit-button:hover { background-color: #2d3748; }

        /* Sidebar */
        .sidebar-link.active { background-color: rgba(0, 82, 204, 0.5); color: white; }
        #sidebar, .main-content { transition: all 0.3s ease-in-out; }
        #sidebar { transform: translateX(-100%); }
        .main-content { margin-left: 0; }
        #sidebar-overlay { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #app-container.sidebar-is-open #sidebar { transform: translateX(0); }
        @media (min-width: 1024px) { #app-container.sidebar-is-open .main-content { margin-left: var(--sidebar-width); } }
        @media (max-width: 1023px) { #app-container.sidebar-is-open #sidebar-overlay { display: block; opacity: 1; pointer-events: auto; } }
    </style>
</head>
<body class="antialiased">
    
    <div id="app-container" style="display: none;">
        
        <div id="sidebar-placeholder"></div> 
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden"></div>

        <main class="main-content p-4 lg:p-8">
            <header class="flex items-center gap-4 mb-8">
                <button id="toggle-sidebar-btn" class="text-white p-2 rounded-md hover:bg-white/10"><i class="fas fa-bars fa-lg"></i></button>
                <div>
                    <h1 class="text-4xl font-bold">Manage Analysis</h1>
                    <p class="text-gray-400">Upload and manage your market analysis.</p>
                </div>
            </header>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="glass-card p-6 md:p-8 self-start">
                    <h2 id="form-title" class="text-2xl font-bold mb-6">Add New Analysis</h2>
                    <form id="analysis-form" class="space-y-6">
                        <input type="hidden" id="analysis-id">
                        
                        <div>
                            <label for="analysis-title" class="form-label">Title</label>
                            <input type="text" id="analysis-title" required class="form-input" placeholder="e.g., EUR/USD Breakout Setup">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="analysis-analyst" class="form-label">Analyst</label>
                                <input type="text" id="analysis-analyst" class="form-input" placeholder="e.g., Finex Team"> </div>
                            <div>
                                <label for="analysis-category" class="form-label">Category</label>
                                <input type="text" id="analysis-category" class="form-input" placeholder="e.g., Forex, Stocks, Crypto">
                            </div>
                        </div>

                        <div>
                            <label for="analysis-image-url" class="form-label">TradingView Image URL</label>
                            <input type="url" id="analysis-image-url" placeholder="https://s3.tradingview.com/..." required class="form-input">
                        </div>

                        <div>
                            <label for="analysis-tags" class="form-label">Tags (comma-separated)</label>
                            <input type="text" id="analysis-tags" class="form-input" placeholder="e.g., EURUSD, H4, Breakout, Buy">
                        </div>

                        <div>
                            <label for="analysis-description" class="form-label">Description</label>
                            <textarea id="analysis-description" required rows="6" class="form-textarea" placeholder="Explain the trade idea, setup, and thesis..."></textarea>
                        </div>
                        
                        <div class="flex gap-4 pt-4 border-t border-white/10">
                            <button type="submit" id="submit-btn" class="main-button w-full">Publish Analysis</button>
                            <button type="button" id="cancel-edit-btn" class="secondary-button w-full" style="display: none;">Cancel</button>
                        </div>
                    </form>
                    <p id="success-message" class="text-center text-green-400 mt-4 font-semibold" style="display: none;"></p>
                </div>
                
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-6">Existing Analyses</h2>
                    <div id="analysis-list" class="space-y-6 max-h-[80vh] overflow-y-auto pr-2">
                        <p class="text-center text-gray-400">Loading...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, serverTimestamp, onSnapshot, 
            query, orderBy, doc, getDoc, updateDoc, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // --- 1. SET CURRENT PAGE ID ---
        const currentPageId = 'analysis'; // Matches the data-pageid in _admin_sidebar.html if you use that pattern

        // --- Firebase Config ---
        const firebaseConfig = { apiKey: "AIzaSyCRtzONV0M1syCLTF6H5__cGEBgJxM13sM", authDomain: "adminpanel-93879.firebaseapp.com", projectId: "adminpanel-93879", storageBucket: "adminpanel-93879.appspot.com", messagingSenderId: "854889610123", appId: "1:854889610123:web:4522c7fc685e9864014d8e" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const analysisForm = document.getElementById('analysis-form');
        const successMessage = document.getElementById('success-message');
        const analysisListContainer = document.getElementById('analysis-list');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const analysisIdInput = document.getElementById('analysis-id');
        let currentAdminUserId = null; // Variable to store admin user ID

        // --- Auth & Sidebar ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentAdminUserId = user.uid; // Store the logged-in admin's user ID
                console.log("Admin User ID:", currentAdminUserId); // Log for verification
                
                // --- 2. LOAD SIDEBAR ---
                await loadAdminSidebar(currentPageId); // Assuming you have this function and _admin_sidebar.html
                appContainer.style.display = 'block';
                setInitialSidebarState();
                
                // --- 3. RUN PAGE-SPECIFIC CODE ---
                loadAnalysisList(); // Load data after auth
            } else {
                // Redirect non-admins to login or main site
                window.location.href = new URL('index.html', window.location.href).href; 
            }
        });

        // --- Form State ---
        function setFormState(state, docId = null) {
            if (state === 'edit') {
                formTitle.textContent = 'Edit Analysis';
                submitBtn.textContent = 'Update Analysis';
                cancelEditBtn.style.display = 'block';
                analysisIdInput.value = docId;
            } else {
                formTitle.textContent = 'Add New Analysis';
                submitBtn.textContent = 'Publish Analysis';
                cancelEditBtn.style.display = 'none';
                analysisIdInput.value = '';
                analysisForm.reset();
            }
        }

        // --- CRUD Functions ---
        function loadAnalysisList() {
            // Only load posts created by admins (isUserPost === false or missing)
             const analysisQuery = query(
                 collection(db, "analysis"), 
                 where("isUserPost", "==", false), // Filter for admin posts
                 orderBy("createdAt", "desc")
             );
            // Alternative if some old posts might miss the flag:
            // const analysisQuery = query(collection(db, "analysis"), orderBy("createdAt", "desc"));
            // Then filter client-side: snapshot.docs.filter(doc => !doc.data().isUserPost).forEach(...)

            onSnapshot(analysisQuery, (snapshot) => {
                if (snapshot.empty) {
                    analysisListContainer.innerHTML = '<p class="text-center text-gray-400">No admin analyses found.</p>';
                    return;
                }
                analysisListContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const analysis = { id: doc.id, ...doc.data() };
                    const tagsHTML = (Array.isArray(analysis.tags) && analysis.tags.length > 0)
                        ? analysis.tags.map(tag => `<span class="text-xs bg-white/10 px-2 py-0.5 rounded-full">#${tag}</span>`).join(' ')
                        : '<span class="text-xs text-gray-500">No tags</span>';

                    const analysisEl = document.createElement('div');
                    analysisEl.className = 'bg-white/5 p-4 rounded-lg';
                    analysisEl.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                            <div>
                                <p class="font-bold text-lg">${analysis.title}</p>
                                <p class="text-sm text-blue-400 mt-1">${analysis.category || 'N/A'}</p>
                                <p class="text-sm text-gray-300 mt-1">By: ${analysis.analyst || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mt-2">${analysis.createdAt ? analysis.createdAt.toDate().toLocaleString() : 'No date'}</p>
                                <div class="flex flex-wrap gap-2 mt-3">${tagsHTML}</div>
                            </div>
                            <div class="flex flex-col gap-2 flex-shrink-0 ml-4">
                                <button data-id="${analysis.id}" class="edit-btn edit-button text-xs font-bold">Edit</button>
                                <button data-id="${analysis.id}" class="delete-btn delete-button text-xs font-bold">Delete</button>
                            </div>
                        </div>
                        <img src="${analysis.imageUrl}" alt="${analysis.title}" class="w-full h-auto rounded-md mt-4 border border-white/10">
                    `;
                    analysisListContainer.appendChild(analysisEl);
                });
            }, (error) => {
                console.error("Error loading analysis list: ", error);
                analysisListContainer.innerHTML = '<p class="text-center text-red-400">Error loading data.</p>';
                if (error.code === 'failed-precondition' && analysisListContainer) {
                     analysisListContainer.innerHTML += `<p class="text-center text-red-400 text-xs mt-2"><b>Action Required:</b> Create Firestore index: analysis | isUserPost (Asc), createdAt (Desc)</p>`;
                }
            });
        }
        
        analysisForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const analysisId = analysisIdInput.value;
            
            const tagsString = document.getElementById('analysis-tags').value;
            const tagsArray = tagsString.split(',')
                                      .map(tag => tag.trim().toLowerCase()) // Standardize tags
                                      .filter(tag => tag.length > 0);
            
            // --- UPDATED: Add admin fields ---
            const analysisData = {
                title: document.getElementById('analysis-title').value.trim(),
                imageUrl: document.getElementById('analysis-image-url').value.trim(),
                description: document.getElementById('analysis-description').value.trim(),
                analyst: document.getElementById('analysis-analyst').value.trim() || "Finex Team", // Default analyst
                category: document.getElementById('analysis-category').value.trim() || null, // Use null if empty
                tags: tagsArray,
                userId: currentAdminUserId || "FINEX_ADMIN", // Use logged-in admin ID or fallback
                isUserPost: false // Mark as admin post
            };
            // --- END OF UPDATE ---
            
            // Basic validation
            if (!analysisData.title || !analysisData.description || !analysisData.imageUrl) {
                 alert("Title, Description, and Image URL are required.");
                 return;
            }

            submitBtn.disabled = true;

            try {
                if (analysisId) { // Editing existing post
                    analysisData.lastUpdated = serverTimestamp();
                    await updateDoc(doc(db, "analysis", analysisId), analysisData);
                    showSuccess('Analysis updated successfully!');
                } else { // Creating new post
                    analysisData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "analysis"), analysisData);
                    showSuccess('Analysis published successfully!');
                }
                setFormState('create'); // Reset form after success
            } catch (error) {
                console.error("Error writing document: ", error);
                alert("An error occurred. Please check the console.");
            } finally {
                submitBtn.disabled = false;
            }
        });

        analysisListContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const analysisId = button.dataset.id;
            if (!analysisId) return;

            if (button.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this analysis?')) {
                    try {
                        await deleteDoc(doc(db, "analysis", analysisId));
                        showSuccess('Analysis deleted!');
                        if (analysisIdInput.value === analysisId) {
                            setFormState('create'); // Reset form if editing deleted item
                        }
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                    }
                }
            } else if (button.classList.contains('edit-btn')) {
                try {
                    const docSnap = await getDoc(doc(db, "analysis", analysisId));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('analysis-title').value = data.title || '';
                        document.getElementById('analysis-image-url').value = data.imageUrl || '';
                        document.getElementById('analysis-description').value = data.description || '';
                        document.getElementById('analysis-analyst').value = data.analyst || '';
                        document.getElementById('analysis-category').value = data.category || '';
                        document.getElementById('analysis-tags').value = Array.isArray(data.tags) ? data.tags.join(', ') : '';
                        
                        setFormState('edit', analysisId);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } catch (error) {
                    console.error("Error fetching document for edit: ", error);
                }
            }
        });

        // --- UI Feedback ---
        cancelEditBtn.addEventListener('click', () => setFormState('create'));

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
        }

        // --- 4. Sidebar Loader & Helper Functions (Assume existence or copy from previous) ---
        async function loadAdminSidebar(pageId) {
            const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
            if (!sidebarPlaceholder) { console.warn("Sidebar placeholder not found"); return; }
            try {
                // Adjust fetch path if necessary
                const response = await fetch('_admin_sidebar.html'); 
                if (!response.ok) throw new Error('Failed to load sidebar HTML');
                sidebarPlaceholder.innerHTML = await response.text();
                
                const nav = document.getElementById('admin-sidebar-nav');
                if (nav) {
                    const activeLink = nav.querySelector(`a[data-pageid="${pageId}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
                attachSidebarEventListeners(); // Attach listeners AFTER sidebar is loaded
            } catch (error) {
                console.error("Error loading sidebar:", error);
                sidebarPlaceholder.innerHTML = "<p class='p-4 text-red-400'>Error loading sidebar.</p>";
            }
        }

        function attachSidebarEventListeners() {
            const logoutBtn = document.getElementById('logout-btn');
            const toggleBtn = document.getElementById('toggle-sidebar-btn');
            const closeBtn = document.getElementById('close-sidebar-btn');
            const overlay = document.getElementById('sidebar-overlay');

            if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth));
            if (toggleBtn) toggleBtn.addEventListener('click', toggleSidebar);
            if (closeBtn) closeBtn.addEventListener('click', toggleSidebar);
            if (overlay) overlay.addEventListener('click', toggleSidebar);
        }

        function toggleSidebar() { appContainer.classList.toggle('sidebar-is-open'); }
        
        function setInitialSidebarState() {
            if (window.innerWidth >= 1024) appContainer.classList.add('sidebar-is-open');
             else appContainer.classList.remove('sidebar-is-open'); // Ensure closed on mobile initially
        }
        // --- End Sidebar Functions ---
    </script>

</body>
</html>
