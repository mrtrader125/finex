<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Finex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        // --- ANTI-FLASH SCRIPT (NEW) ---
        // Checks local storage BEFORE page renders to set correct theme immediately.
        const savedTheme = localStorage.getItem('finex_theme');
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
        } else if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    <style>
        /* Main details/summary */
        details > summary {
            list-style: none; /* Hide default <details> marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Hide default <details> marker */
        }
        details[open] > summary .chevron-icon {
            transform: rotate(180deg);
        }
        details > summary .chevron-icon {
            transition: transform 0.2s ease-in-out;
        }

        /* Nested sidebar item details/summary */
        .sidebar-option-item summary {
            list-style: none;
        }
        .sidebar-option-item summary::-webkit-details-marker {
            display: none;
        }
        .sidebar-option-item[open] > summary .chevron-icon-nested {
            transform: rotate(90deg);
        }
        .sidebar-option-item .chevron-icon-nested {
            transition: transform 0.2s ease-in-out;
            font-size: 0.7rem;
            margin-right: 0.75rem; /* 12px */
            width: 1rem; /* w-4 */
            text-align: center;
        }
    </style>
</head>
<body class="antialiased textured-background">
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div class="min-h-screen flex flex-col">
            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <div class="max-w-4xl mx-auto space-y-8">

                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div>
                                <label for="display-name" class="text-sm text-color-muted block mb-1">Display Name</label>
                                <input type="text" id="display-name" required class="form-input w-full md:w-1/2" placeholder="e.g., Alex">
                            </div>
                            <div class="flex items-center gap-4">
                                <button type="submit" id="save-profile-btn" class="main-button py-2 px-5">Save Profile</button>
                                <p id="profile-save-status" class="text-sm text-color-muted h-4"></p>
                            </div>
                        </form>
                    </div>
                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Appearance</h2>
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-color-base">Theme</span>
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-sun text-yellow-500"></i>
                                <label class="form-switch"><input type="checkbox" id="theme-toggle" class="sr-only"><div class="form-switch-bg"><div class="form-switch-knob"></div></div></label>
                                <i class="fas fa-moon text-blue-400 dark:text-blue-300"></i>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 md:p-8">
                        <details open>
                            <summary class="flex justify-between items-center cursor-pointer list-none">
                                <h2 class="text-2xl font-bold">Sidebar Menu Items</h2>
                                <i class="fas fa-chevron-down chevron-icon text-color-muted text-lg"></i> 
                            </summary>
                            <div class="mt-6 border-t border-color-base pt-6">
                                <p class="text-color-muted mb-6 text-sm">Choose which pages appear in your sidebar navigation for quick access.</p>
                                <div id="sidebar-options-container" class="space-y-1">
                                    <p class="text-color-muted text-center col-span-full">Loading options...</p>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Account</h2>
                         <div class="space-y-4">
                             <div><span class="font-semibold text-color-base block mb-1">Email Address</span><span id="account-email" class="text-color-muted">Loading...</span></div>
                             <div><span class="font-semibold text-color-base block mb-1">Password</span><button class="text-sm text-blue-500 hover:underline disabled:opacity-50 disabled:cursor-not-allowed" disabled>Change Password (Coming Soon)</button></div>
                         </div>
                    </div>
                     <p id="save-status" class="text-center text-sm text-color-muted h-4"></p>
                </div>
            </main>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { initializeAppCore, db, auth, applyTheme, renderSidebar, allSidebarItems, userPreferences } from './app.js';
        import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        function initSettingsPage(user, db) {
            console.log("Setting up Settings page specific logic...");
            
            const elements = {
                accountEmailSpan: document.getElementById('account-email'),
                themeToggle: document.getElementById('theme-toggle'),
                sidebarOptionsContainer: document.getElementById('sidebar-options-container'),
                saveStatus: document.getElementById('save-status'),
                profileForm: document.getElementById('profile-form'),
                displayNameInput: document.getElementById('display-name'),
                saveProfileBtn: document.getElementById('save-profile-btn'),
                profileSaveStatus: document.getElementById('profile-save-status')
            };

            if (Object.values(elements).some(el => !el)) {
                console.error("Critical settings elements missing!");
                 const main = document.querySelector('main'); if(main) main.innerHTML = "<p class='text-red-500 text-center p-8'>Error loading settings page elements.</p>"; return;
            }

            let currentUserId = user.uid;
            let settingsDocRef = doc(db, `users/${currentUserId}/preferences`, 'settings');
            let userDocRef = doc(db, "users", currentUserId);
            
            let globalPreferences = { theme: 'dark', sidebarItems: {} };
            let debounceTimer = null;

            async function loadData() {
                try {
                    // Load Profile
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        elements.displayNameInput.value = userDocSnap.data().displayName || user.email.split('@')[0];
                    } else {
                        elements.displayNameInput.value = user.email.split('@')[0];
                    }
                    elements.accountEmailSpan.textContent = user.email;

                    // Theme is already applied by app.js on load, just sync the toggle switch state here
                    elements.themeToggle.checked = (userPreferences.theme === 'dark');

                    // Load Sidebar Options
                    const globalSettingsRef = doc(db, "siteSettings", "sidebarDefaults");
                    const globalDocSnap = await getDoc(globalSettingsRef);
                    if (globalDocSnap.exists()) {
                        globalPreferences = { ...globalPreferences, ...globalDocSnap.data() };
                    }
                    populateSidebarOptions();

                } catch (error) { console.error("Error loading data:", error); }
            }
            
            // === INSTANT THEME SWITCHING LISTENER (NEW) ===
            elements.themeToggle.addEventListener('change', () => {
                const newTheme = elements.themeToggle.checked ? 'dark' : 'light';
                // Apply INSTANTLY to the DOM and LocalStorage
                applyTheme(newTheme); 
                // Save to database in background (debounced)
                debouncedSavePreferences(); 
            });

            async function savePreferences() {
                elements.saveStatus.textContent = 'Saving...';
                try { 
                     await setDoc(settingsDocRef, {
                        theme: userPreferences.theme, 
                        sidebarItems: userPreferences.sidebarItems, 
                        lastUpdated: serverTimestamp()
                    }, { merge: true });
                     elements.saveStatus.textContent = 'Preferences Saved.'; 
                     setTimeout(() => elements.saveStatus.textContent = '', 2000);
                     renderSidebar(); 
                 } catch (error) { 
                     console.error("Error saving preferences:", error); 
                     elements.saveStatus.textContent = 'Error Saving.'; 
                 }
            }

            function debouncedSavePreferences() { 
                clearTimeout(debounceTimer); 
                elements.saveStatus.textContent = 'Saving...'; 
                debounceTimer = setTimeout(savePreferences, 1000); 
            }

            async function saveProfile(e) {
                e.preventDefault();
                const newName = elements.displayNameInput.value.trim();
                if (!newName) return;
                elements.saveProfileBtn.disabled = true; elements.saveProfileBtn.textContent = 'Saving...';
                try {
                    await updateDoc(userDocRef, { displayName: newName });
                    elements.profileSaveStatus.textContent = "Profile Saved!"; elements.profileSaveStatus.className = 'text-sm h-4 text-green-400';
                    setTimeout(() => elements.profileSaveStatus.textContent = '', 3000);
                } catch (error) {
                    console.error("Error saving profile:", error);
                    elements.profileSaveStatus.textContent = "Error saving."; elements.profileSaveStatus.className = 'text-sm h-4 text-red-400';
                } finally {
                    elements.saveProfileBtn.disabled = false; elements.saveProfileBtn.textContent = 'Save Profile';
                }
            }

            function populateSidebarOptions() {
                elements.sidebarOptionsContainer.innerHTML = '';
                allSidebarItems.forEach(item => {
                    if (item.id === 'settings') return;
                    if (globalPreferences.sidebarItems[item.id] === false) return; 
                    
                    const createCheckbox = (itemData, isSubItem = false) => {
                        const userVal = userPreferences.sidebarItems[itemData.id];
                        const globalVal = globalPreferences.sidebarItems[itemData.id];
                        const isChecked = (userVal !== undefined) ? userVal : (globalVal !== undefined ? globalVal : true);

                        const label = document.createElement('label');
                        label.className = `flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover-bg-base checkbox-label ${isSubItem ? 'pl-10' : ''}`;
                        
                        label.innerHTML = `
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700" 
                                ${isChecked ? 'checked' : ''} 
                                data-item-id="${itemData.id}" 
                                ${!isSubItem && itemData.subItems ? 'data-is-parent="true"' : ''} 
                                ${isSubItem ? `data-parent-id="${item.id}"` : ''}>
                            <i class="fas ${itemData.icon} fa-fw text-color-muted w-4 text-center"></i>
                            <span class="text-color-base">${itemData.text}</span>
                        `;
                        return label;
                    };

                    if (item.subItems) {
                        const details = document.createElement('details'); details.className = 'sidebar-option-item'; details.open = true;
                        const summary = document.createElement('summary'); summary.className = 'flex items-center cursor-pointer rounded-lg hover-bg-base';
                        
                        summary.innerHTML = `<i class="fas fa-chevron-right chevron-icon-nested text-color-muted"></i>`;
                        const parentLabel = createCheckbox(item, false);
                        parentLabel.classList.add('flex-grow'); parentLabel.classList.remove('p-2');
                        summary.appendChild(parentLabel);
                        
                        const subItemsContainer = document.createElement('div'); subItemsContainer.className = 'space-y-1';
                        item.subItems.forEach(sub => { if (globalPreferences.sidebarItems[sub.id] !== false) subItemsContainer.appendChild(createCheckbox(sub, true)); });
                        
                        details.appendChild(summary); details.appendChild(subItemsContainer); elements.sidebarOptionsContainer.appendChild(details);
                    } else {
                        elements.sidebarOptionsContainer.appendChild(createCheckbox(item, false));
                    }
                });
            }

            elements.sidebarOptionsContainer.addEventListener('change', (e) => {
                if (e.target.type !== 'checkbox') return;
                const checkbox = e.target;
                userPreferences.sidebarItems[checkbox.dataset.itemId] = checkbox.checked;

                if (checkbox.dataset.isParent && !checkbox.checked) {
                    elements.sidebarOptionsContainer.querySelectorAll(`[data-parent-id="${checkbox.dataset.itemId}"]`).forEach(child => {
                        child.checked = false; userPreferences.sidebarItems[child.dataset.itemId] = false;
                    });
                }
                if (checkbox.dataset.parentId && checkbox.checked) {
                    const parent = elements.sidebarOptionsContainer.querySelector(`[data-item-id="${checkbox.dataset.parentId}"]`);
                    if (parent && !parent.checked) {
                        parent.checked = true; userPreferences.sidebarItems[parent.dataset.itemId] = true;
                    }
                }
                debouncedSavePreferences();
            });

            elements.profileForm.addEventListener('submit', saveProfile);
            loadData();
        }
        initializeAppCore(initSettingsPage);
    </script>
</body>
</html>
