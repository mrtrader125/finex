<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Finex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    <style>
        .sidebar-option-item summary {
            list-style: none; /* Hide default <details> marker */
        }
        .sidebar-option-item summary::-webkit-details-marker {
            display: none; /* Hide default <details> marker */
        }
        .sidebar-option-item[open] > summary .chevron-icon {
            transform: rotate(90deg);
        }
        .sidebar-option-item .chevron-icon {
            transition: transform 0.2s ease-in-out;
            font-size: 0.7rem;
            margin-right: 0.75rem; /* 12px */
            width: 1rem; /* w-4 */
            text-align: center;
        }
    </style>
    </head>
<body class="antialiased textured-background">
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div class="min-h-screen flex flex-col">
            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Appearance</h2>
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-color-base">Theme</span>
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-sun text-yellow-500"></i>
                                <label class="form-switch"><input type="checkbox" id="theme-toggle" class="sr-only"><div class="form-switch-bg"><div class="form-switch-knob"></div></div></label>
                                <i class="fas fa-moon text-blue-400 dark:text-blue-300"></i>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Sidebar Menu Items</h2>
                        <p class="text-color-muted mb-6 text-sm">Choose which pages appear in your sidebar navigation for quick access.</p>
                        <div id="sidebar-options-container" class="space-y-1">
                            <p class="text-color-muted text-center col-span-full">Loading options...</p>
                        </div>
                    </div>
                    <div class="glass-card p-6 md:p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Account</h2>
                         <div class="space-y-4">
                             <div><span class="font-semibold text-color-base block mb-1">Email Address</span><span id="account-email" class="text-color-muted">Loading...</span></div>
                             <div><span class="font-semibold text-color-base block mb-1">Password</span><button class="text-sm text-blue-500 hover:underline disabled:opacity-50 disabled:cursor-not-allowed" disabled>Change Password (Coming Soon)</button></div>
                         </div>
                    </div>
                   
                     <p id="save-status" class="text-center text-sm text-color-muted h-4"></p>
                </div>
            </main>
        </div>
        </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { initializeAppCore, db, auth, applyTheme, renderSidebar, allSidebarItems } from './app.js';
        import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        function initSettingsPage(user, db) {
            console.log("Setting up Settings page specific logic...");
            const accountEmailSpan = document.getElementById('account-email');
            const themeToggle = document.getElementById('theme-toggle');
            const sidebarOptionsContainer = document.getElementById('sidebar-options-container');
            const saveStatus = document.getElementById('save-status');

            if (!accountEmailSpan || !themeToggle || !sidebarOptionsContainer || !saveStatus) {
                console.error("Critical settings elements missing!");
                 const main = document.querySelector('main'); if(main) main.innerHTML = "<p class='text-red-500 text-center p-8'>Error loading settings page elements.</p>"; return;
            }

            let currentUserId = user.uid;
            let settingsDocRef = doc(db, `users/${currentUserId}/preferences`, 'settings');
            
            let globalPreferences = { theme: 'dark', sidebarItems: {} }; // From admin
            let userPreferences = { theme: 'dark', sidebarItems: {} };   // From user
            
            // Initialize local defaults using the imported allSidebarItems
            let defaultSidebarItems = {};
            allSidebarItems.forEach(item => {
                defaultSidebarItems[item.id] = true; // Default parent to true
                if(item.subItems) { item.subItems.forEach(sub => defaultSidebarItems[sub.id] = true); } // Default subitems to true
            });

            let debounceTimer = null;

            async function loadPreferencesForSettings() {
                try {
                    const globalSettingsRef = doc(db, "siteSettings", "sidebarDefaults");
                    const globalDocSnap = await getDoc(globalSettingsRef);
                    if (globalDocSnap.exists()) {
                        globalPreferences = { ...globalPreferences, ...globalDocSnap.data() };
                    }
                    
                    const userDocSnap = await getDoc(settingsDocRef);
                    if (userDocSnap.exists()) {
                        const loadedPrefs = userDocSnap.data();
                        userPreferences.theme = loadedPrefs.theme; 
                        userPreferences.sidebarItems = loadedPrefs.sidebarItems || {};
                    }
                } catch (error) { console.error("Error loading preferences for settings:", error); }
                
                accountEmailSpan.textContent = user.email;
                
                const finalTheme = userPreferences.theme || globalPreferences.theme || 'dark';
                themeToggle.checked = (finalTheme === 'dark');
                
                populateSidebarOptions();
            }

            async function savePreferences(type = 'all') {
                if (!settingsDocRef) return; 
                saveStatus.textContent = 'Saving...';
                
                const dataToSave = {
                    theme: userPreferences.theme, 
                    sidebarItems: userPreferences.sidebarItems, 
                    lastUpdated: serverTimestamp()
                };

                 try { 
                     await setDoc(settingsDocRef, dataToSave, { merge: true });
                     saveStatus.textContent = 'Preferences Saved.'; 
                     setTimeout(() => saveStatus.textContent = '', 2000);
                     
                     let finalMergedPrefs = {};
                     Object.keys(defaultSidebarItems).forEach(key => {
                        const globalVal = globalPreferences.sidebarItems[key];
                        const userVal = userPreferences.sidebarItems[key];
                        if (globalVal === false) { finalMergedPrefs[key] = false; }
                        else if (userVal !== undefined) { finalMergedPrefs[key] = userVal; }
                        else if (globalVal !== undefined) { finalMergedPrefs[key] = globalVal; }
                        else { finalMergedPrefs[key] = true; }
                     });
                     
                     try {
                        const app = await import('./app.js');
                        app.userPreferences.sidebarItems = finalMergedPrefs;
                        app.userPreferences.theme = userPreferences.theme || globalPreferences.theme || 'dark';
                        renderSidebar(); 
                     } catch(e) {
                         console.error("Could not update app.js state", e);
                         renderSidebar();
                     }

                 } catch (error) { 
                     console.error("Error saving preferences:", error); 
                     saveStatus.textContent = 'Error Saving.'; 
                 }
            }
            function debouncedSavePreferences() { clearTimeout(debounceTimer); saveStatus.textContent = 'Saving...'; debounceTimer = setTimeout(() => savePreferences('sidebar'), 1000); }

            // --- === THIS FUNCTION IS HEAVILY MODIFIED === ---
            function populateSidebarOptions() {
                sidebarOptionsContainer.innerHTML = ''; // Clear loading message
                
                allSidebarItems.forEach(item => {
                    if (item.id === 'settings') return; // Skip settings itself

                    // If the admin has set this item to 'false', do not render the option
                    if (globalPreferences.sidebarItems[item.id] === false) {
                        return; 
                    }
                    
                    // --- Helper function to create a checkbox label ---
                    const createCheckbox = (itemData, isSubItem = false) => {
                        const userValue = userPreferences.sidebarItems[itemData.id];
                        const globalValue = globalPreferences.sidebarItems[itemData.id];
                        const isChecked = (userValue !== undefined) ? userValue : (globalValue !== undefined ? globalValue : true);

                        const label = document.createElement('label');
                        label.className = `flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover-bg-base checkbox-label ${isSubItem ? 'pl-10' : ''}`;
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:focus:ring-blue-600 dark:ring-offset-gray-800';
                        checkbox.checked = isChecked;
                        checkbox.dataset.itemId = itemData.id;
                        
                        // Add parent/child data attributes for linked checking
                        if (!isSubItem && itemData.subItems) {
                            checkbox.dataset.isParent = true;
                        }
                        if (isSubItem) {
                            checkbox.dataset.parentId = item.id;
                        }

                        const icon = document.createElement('i');
                        icon.className = `fas ${itemData.icon} fa-fw text-color-muted w-4 text-center`; // w-4 for alignment
                        
                        const text = document.createElement('span');
                        text.className = 'text-color-base'; 
                        text.textContent = itemData.text;

                        label.appendChild(checkbox); 
                        label.appendChild(icon); 
                        label.appendChild(text);
                        return label;
                    };

                    // --- Logic for Parent Items vs. Dropdowns ---
                    
                    // Case 1: Item is a Dropdown (has subItems)
                    if (item.subItems) {
                        const details = document.createElement('details');
                        details.className = 'sidebar-option-item';
                        details.open = true; // Default to open
                        
                        const summary = document.createElement('summary');
                        summary.className = 'flex items-center cursor-pointer rounded-lg hover-bg-base';
                        
                        // Add chevron icon
                        const chevron = document.createElement('i');
                        chevron.className = 'fas fa-chevron-right chevron-icon text-color-muted';
                        
                        // Create parent checkbox
                        const parentLabel = createCheckbox(item, false);
                        parentLabel.classList.add('flex-grow'); // Make label take up space
                        parentLabel.classList.remove('p-2'); // Remove padding, summary has it
                        
                        summary.appendChild(chevron);
                        summary.appendChild(parentLabel);
                        
                        const subItemsContainer = document.createElement('div');
                        subItemsContainer.className = 'space-y-1';
                        
                        // Create checkboxes for sub-items
                        item.subItems.forEach(sub => {
                            // Also check if admin has hidden the sub-item
                            if (globalPreferences.sidebarItems[sub.id] !== false) {
                                subItemsContainer.appendChild(createCheckbox(sub, true));
                            }
                        });
                        
                        details.appendChild(summary);
                        details.appendChild(subItemsContainer);
                        sidebarOptionsContainer.appendChild(details);
                    
                    // Case 2: Item is a simple link
                    } else {
                        sidebarOptionsContainer.appendChild(createCheckbox(item, false));
                    }
                });
                
                // --- Add Event Listeners for new logic ---
                sidebarOptionsContainer.addEventListener('change', (e) => {
                    if (e.target.type !== 'checkbox') return;
                    
                    const checkbox = e.target;
                    const itemId = checkbox.dataset.itemId;
                    const isChecked = checkbox.checked;

                    // Save the user's *explicit* choice
                    userPreferences.sidebarItems[itemId] = isChecked;

                    // If this is a parent, update its children
                    if (checkbox.dataset.isParent) {
                        // Only update children if parent is being *unchecked*
                        if (!isChecked) {
                            const children = sidebarOptionsContainer.querySelectorAll(`[data-parent-id="${itemId}"]`);
                            children.forEach(childCheckbox => {
                                childCheckbox.checked = false;
                                userPreferences.sidebarItems[childCheckbox.dataset.itemId] = false;
                            });
                        }
                    }
                    
                    // If this is a child, update its parent
                    if (checkbox.dataset.parentId) {
                        // Only update parent if child is being *checked*
                        if (isChecked) {
                            const parentCheckbox = sidebarOptionsContainer.querySelector(`[data-item-id="${checkbox.dataset.parentId}"]`);
                            if (parentCheckbox && !parentCheckbox.checked) {
                                parentCheckbox.checked = true;
                                userPreferences.sidebarItems[parentCheckbox.dataset.itemId] = true;
                            }
                        }
                    }

                    debouncedSavePreferences();
                });
            }
            // --- === END OF MODIFIED FUNCTION === ---


            themeToggle.addEventListener('change', () => {
                userPreferences.theme = themeToggle.checked ? 'dark' : 'light';
                applyTheme(userPreferences.theme);
                savePreferences('theme'); 
            });

            loadPreferencesForSettings();
        }
        initializeAppCore(initSettingsPage);
    </script>
</body>
</html>
