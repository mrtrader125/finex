<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Finclarity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        // Tailwind config for dark mode
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
        }
    </script>
    <style>
        html { scrollbar-width: none; -ms-overflow-style: none; }
        html::-webkit-scrollbar { display: none; }
        
        /* Base styles */
        body { 
            font-family: 'Source Sans Pro', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4, h5, h6 { font-family: 'Montserrat', sans-serif; }
        
        /* Light Theme */
        body { 
            background-color: #f4f6f9; /* Light gray background */
            color: #1f2937; /* Dark text */
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.8); /* Lighter white */
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(0, 0, 0, 0.08); 
            border-radius: 1.5rem; 
            color: #1f2937; /* Dark text for cards */
        }
        .sidebar { 
            background-color: #e5e7eb/80; /* Light gray sidebar */
            color: #374151; /* Medium gray text */
        }
         .header {
             background-color: #f9fafb/30; /* Very light gray header */
         }
        .sidebar-link { color: #4b5563; } /* Slightly darker gray for links */
        .sidebar-link:hover, .sidebar-link.active { color: #0052cc; background-color: rgba(0, 82, 204, 0.08); } /* Blue accent */
        .logout-link { color: #dc2626; } /* Red for logout */
        .logout-link:hover { color: #b91c1c; background-color: rgba(220, 38, 38, 0.1); }
        .form-input, .form-switch-bg { background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.1); color: #1f2937; }
        .text-color-base { color: #1f2937; }
        .text-color-muted { color: #4b5563; }
        .border-color-base { border-color: rgba(0, 0, 0, 0.1); }
        .hover-bg-base:hover { background-color: rgba(0, 0, 0, 0.05); }
        /* Background pattern for light mode */
        .textured-background {
             background-image: linear-gradient(rgba(0, 0, 0, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.02) 1px, transparent 1px);
             background-size: 2rem 2rem;
        }

        /* Dark Theme */
        .dark body { 
            background-color: #0c111e; 
            color: #f4f6f9; 
        }
        .dark .glass-card { 
            background: rgba(17, 24, 39, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #f4f6f9; 
        }
        .dark .sidebar { 
            background-color: #111827/80; 
            color: #a9a9b3; 
        }
         .dark .header {
             background-color: #111827/30;
         }
        .dark .sidebar-link { color: #a9a9b3; }
        .dark .sidebar-link:hover, .dark .sidebar-link.active { color: #ffffff; background-color: rgba(255, 255, 255, 0.08); }
        .dark .logout-link { color: #f87171; } /* Lighter red */
        .dark .logout-link:hover { color: #ef4444; background-color: rgba(248, 113, 113, 0.1); }
        .dark .form-input, .dark .form-switch-bg { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #f4f6f9; }
        .dark .text-color-base { color: #f4f6f9; }
        .dark .text-color-muted { color: #a9a9b3; }
        .dark .border-color-base { border-color: rgba(255, 255, 255, 0.1); }
        .dark .hover-bg-base:hover { background-color: rgba(255, 255, 255, 0.05); }
        /* Background pattern for dark mode */
        .dark .textured-background {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
             background-size: 2rem 2rem;
        }

        /* General styles */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .form-switch { display: inline-flex; align-items: center; cursor: pointer; }
        .form-switch-bg { width: 40px; height: 20px; border-radius: 9999px; position: relative; transition: background-color 0.2s ease; }
        .form-switch-knob { width: 16px; height: 16px; background-color: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.2s ease; }
        .form-switch input:checked + .form-switch-bg { background-color: #0052cc; }
        .form-switch input:checked + .form-switch-bg .form-switch-knob { transform: translateX(20px); }
        .checkbox-label { user-select: none; } /* Prevent text selection on double click */
    </style>
</head>
<body class="antialiased textured-background"> <!-- Apply textured background -->
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 hidden dark:bg-opacity-80"></div>
        
        <!-- Sidebar - Content will be dynamically generated -->
        <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-72 backdrop-blur-lg shadow-2xl z-50 transform -translate-x-full">
            <div class="p-6 flex flex-col h-full">
                <div class="flex justify-between items-center mb-8">
                    <div class="text-xl font-bold tracking-wider"><a href="member_dashboard.html" class="text-color-base hover:opacity-80">FINCLARITY</a></div>
                    <button id="close-sidebar-btn" class="text-color-muted hover:text-color-base"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <nav id="sidebar-nav" class="flex flex-col space-y-2 text-lg overflow-y-auto">
                    <!-- Links will be injected here by JS -->
                </nav>
                <div class="mt-auto">
                    <a href="#" id="logout-btn" class="logout-link flex items-center gap-4 hover-bg-base p-3 rounded-lg transition-colors"><i class="fas fa-sign-out-alt fa-fw w-6"></i><span>Log Out</span></a>
                </div>
            </div>
        </aside>

        <div class="min-h-screen flex flex-col">
            <header id="header" class="header backdrop-blur-md sticky top-0 z-30">
                <div class="container mx-auto flex justify-between items-center p-4">
                     <div class="flex items-center gap-4">
                        <button id="open-sidebar-btn" class="text-color-base hover:text-blue-500 p-2 rounded-full hover-bg-base"><i class="fas fa-bars fa-lg"></i></button>
                        <div class="text-2xl font-bold tracking-wider text-color-base">Settings</div>
                    </div>
                    <nav class="flex items-center gap-4">
                         <span id="user-email" class="hidden sm:inline text-color-muted"></span>
                         <a href="settings.html" class="text-color-base p-2 rounded-full hover-bg-base"><i class="fas fa-user-circle fa-lg"></i></a>
                    </nav>
                </div>
            </header>

            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <div class="max-w-4xl mx-auto space-y-8">
                    <!-- Appearance Settings -->
                    <div class="glass-card p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Appearance</h2>
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-color-base">Theme</span>
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-sun text-yellow-500"></i>
                                <label class="form-switch">
                                    <input type="checkbox" id="theme-toggle" class="sr-only">
                                    <div class="form-switch-bg">
                                        <div class="form-switch-knob"></div>
                                    </div>
                                </label>
                                <i class="fas fa-moon text-blue-300"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Customization -->
                    <div class="glass-card p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Sidebar Menu Items</h2>
                        <p class="text-color-muted mb-6 text-sm">Choose which pages appear in your sidebar navigation for quick access.</p>
                        <div id="sidebar-options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Checkboxes will be dynamically loaded here -->
                            <p class="text-color-muted text-center col-span-full">Loading options...</p>
                        </div>
                    </div>

                    <!-- Account Information -->
                    <div class="glass-card p-8">
                        <h2 class="text-2xl font-bold mb-6 border-b border-color-base pb-3">Account</h2>
                         <div class="space-y-4">
                             <div>
                                 <span class="font-semibold text-color-base block mb-1">Email Address</span>
                                 <span id="account-email" class="text-color-muted">Loading...</span>
                             </div>
                             <div>
                                <span class="font-semibold text-color-base block mb-1">Password</span>
                                <button class="text-sm text-blue-500 hover:underline">Change Password (Not implemented)</button>
                             </div>
                         </div>
                    </div>
                     <p id="save-status" class="text-center text-sm text-color-muted h-4"></p>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Unified JS Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCRtzONV0M1syCLTF6H5__cGEBgJxM13sM", authDomain: "adminpanel-93879.firebaseapp.com", projectId: "adminpanel-93879", storageBucket: "adminpanel-93879.appspot.com", messagingSenderId: "854889610123", appId: "1:854889610123:web:4522c7fc685e9864014d8e" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Core Elements ---
        const appWrapper = document.getElementById('app-wrapper');
        const userEmailSpan = document.getElementById('user-email');
        const accountEmailSpan = document.getElementById('account-email');
        const sidebarNav = document.getElementById('sidebar-nav');
        const themeToggle = document.getElementById('theme-toggle');
        const sidebarOptionsContainer = document.getElementById('sidebar-options-container');
        const saveStatus = document.getElementById('save-status');

        let currentUserId = null;
        let userPreferences = { // Default preferences
            theme: 'dark',
            sidebarItems: {} // Will be populated with all items initially visible
        }; 
        let settingsDocRef = null;
        let debounceTimer = null;

        // --- Available Sidebar Items ---
        const allSidebarItems = [
            { id: 'dashboard', href: 'member_dashboard.html', icon: 'fa-tachometer-alt', text: 'Dashboard' },
            { id: 'portfolio', href: 'portfolio.html', icon: 'fa-wallet', text: 'Portfolio' },
            { id: 'articles', href: 'articles.html', icon: 'fa-book-reader', text: 'Articles' },
            { id: 'analysis', href: 'analysis.html', icon: 'fa-image', text: 'Analysis' },
            { id: 'checklist', href: 'weekly_checklist.html', icon: 'fa-clipboard-check', text: 'Weekly Checklist' },
            { id: 'results', href: 'real_results.html', icon: 'fa-chart-line', text: 'Real-World Results' },
            { id: 'screener', href: 'market_screener.html', icon: 'fa-search-dollar', text: 'Market Screener' },
            { id: 'news', href: 'news.html', icon: 'fa-newspaper', text: 'Live News Feed' },
            { id: 'calendar', href: 'economic_calendar.html', icon: 'fa-calendar-alt', text: 'Economic Calendar' },
            { id: 'journal', href: 'trading_journal.html', icon: 'fa-book', text: 'Trading Journal' },
            { id: 'tools', href: 'tools_calculators.html', icon: 'fa-tools', text: 'Tools' },
            { id: 'settings', href: 'settings.html', icon: 'fa-user-cog', text: 'Settings' },
        ];
        
        // Initialize default sidebar visibility
        allSidebarItems.forEach(item => userPreferences.sidebarItems[item.id] = true);

        // --- Auth State ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUserId = user.uid;
                settingsDocRef = doc(db, `users/${currentUserId}/preferences`, 'settings');
                userEmailSpan.textContent = user.email;
                accountEmailSpan.textContent = user.email; // Display email on settings page
                
                await loadPreferences(); // Load saved preferences
                
                applyTheme(userPreferences.theme); // Apply loaded theme
                renderSidebar(); // Render sidebar based on loaded preferences
                populateSidebarOptions(); // Populate checkboxes on settings page
                
                appWrapper.style.display = 'block'; // Show the app content
            } else {
                // Not logged in, redirect to login
                window.location.replace(new URL('login.html', window.location.href).href);
            }
        });

        // --- Preference Management ---
        async function loadPreferences() {
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const loadedPrefs = docSnap.data();
                    // Merge loaded prefs with defaults, ensuring all keys exist
                    userPreferences.theme = loadedPrefs.theme || 'dark';
                    // Ensure sidebarItems exists and merge individual item visibility
                    userPreferences.sidebarItems = { ...userPreferences.sidebarItems }; // Clone default visibility
                    if (loadedPrefs.sidebarItems && typeof loadedPrefs.sidebarItems === 'object') {
                         for (const key in userPreferences.sidebarItems) {
                             if (loadedPrefs.sidebarItems.hasOwnProperty(key)) {
                                 userPreferences.sidebarItems[key] = loadedPrefs.sidebarItems[key];
                             }
                         }
                    }
                } else {
                     // No saved settings, save the defaults
                     await savePreferences(); 
                }
            } catch (error) {
                console.error("Error loading preferences:", error);
                 // Fallback to defaults if loading fails
                 userPreferences = { theme: 'dark', sidebarItems: {} };
                 allSidebarItems.forEach(item => userPreferences.sidebarItems[item.id] = true);
            }
        }
        
        async function savePreferences() {
            if (!settingsDocRef) return;
            saveStatus.textContent = 'Saving...';
             try {
                 await setDoc(settingsDocRef, { 
                     ...userPreferences, // Save the entire preferences object
                     lastUpdated: serverTimestamp() 
                 }, { merge: true }); // Merge to avoid overwriting unrelated fields if any
                 saveStatus.textContent = 'Preferences Saved.';
                 setTimeout(() => saveStatus.textContent = '', 2000);
             } catch (error) {
                 console.error("Error saving preferences:", error);
                 saveStatus.textContent = 'Error Saving.';
             }
        }
        
        // Debounced save
        function debouncedSavePreferences() {
            clearTimeout(debounceTimer);
            saveStatus.textContent = 'Saving...';
            debounceTimer = setTimeout(savePreferences, 1000); // Save 1 second after last change
        }

        // --- Theme ---
        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                themeToggle.checked = false;
            } else {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            }
        }

        themeToggle.addEventListener('change', () => {
            userPreferences.theme = themeToggle.checked ? 'dark' : 'light';
            applyTheme(userPreferences.theme);
            savePreferences(); // Save immediately on theme change
        });

        // --- Sidebar Rendering ---
        function renderSidebar() {
            const currentPage = window.location.pathname.split('/').pop(); // Get current filename
            sidebarNav.innerHTML = ''; // Clear existing links
            
            allSidebarItems.forEach(item => {
                 // Only render if the visibility preference is true
                if (userPreferences.sidebarItems[item.id]) {
                    const link = document.createElement('a');
                    link.href = item.href;
                    link.className = `sidebar-link flex items-center gap-4 p-3 rounded-lg`;
                    if (item.href === currentPage) {
                        link.classList.add('active'); // Add active class if it's the current page
                    }
                    link.innerHTML = `<i class="fas ${item.icon} fa-fw w-6"></i><span>${item.text}</span>`;
                    sidebarNav.appendChild(link);
                }
            });
        }

        // --- Populate Settings Checkboxes ---
        function populateSidebarOptions() {
            sidebarOptionsContainer.innerHTML = ''; // Clear loading message
            allSidebarItems.forEach(item => {
                // Don't allow hiding the settings page itself
                if (item.id === 'settings') return; 

                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover-bg-base checkbox-label';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-input w-4 h-4 text-blue-600 rounded focus:ring-blue-500';
                checkbox.checked = userPreferences.sidebarItems[item.id] || false; // Default to false if not set? No, use loaded pref.
                checkbox.dataset.itemId = item.id;

                const icon = document.createElement('i');
                icon.className = `fas ${item.icon} fa-fw text-color-muted`;

                const text = document.createElement('span');
                text.className = 'text-color-base';
                text.textContent = item.text;

                label.appendChild(checkbox);
                label.appendChild(icon);
                label.appendChild(text);
                sidebarOptionsContainer.appendChild(label);

                checkbox.addEventListener('change', (e) => {
                     const itemId = e.target.dataset.itemId;
                     userPreferences.sidebarItems[itemId] = e.target.checked;
                     renderSidebar(); // Re-render sidebar immediately
                     debouncedSavePreferences(); // Debounce saving to Firestore
                });
            });
        }

        // --- Sidebar Toggle & Logout ---
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        function openSidebar() { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); setTimeout(() => sidebarOverlay.classList.remove('opacity-0'), 10); }
        function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('opacity-0'); setTimeout(() => sidebarOverlay.classList.add('hidden'), 300); }
        openSidebarBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        sidebarNav.addEventListener('click', (e) => { if (e.target.closest('a') && window.innerWidth < 1024) { closeSidebar(); } }); // Use closest('a')
        document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); signOut(auth).then(() => window.location.href = 'index.html'); });

    </script>
</body>
</html>
