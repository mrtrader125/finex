<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>
    /* Prevent dark/light flicker */
    try {
      const theme = localStorage.getItem('finex_theme');
      if (theme === 'light') document.documentElement.classList.remove('dark');
      else document.documentElement.classList.add('dark');
    } catch { document.documentElement.classList.add('dark'); }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Member Dashboard | Finex - Financial Clarity</title>

  <meta name="description" content="Your personal dashboard for tracking financial growth, accessing exclusive guides, and analyzing trading results on the Finex platform.">
  <meta property="og:title" content="Member Dashboard | Finex">
  <meta property="og:description" content="Your personal hub for financial tools and clarity.">
  <meta name="twitter:title" content="Member Dashboard | Finex">
  <meta name="twitter:description" content="Your personal hub for financial tools and clarity.">

  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js" />
  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js" />
  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <link rel="stylesheet" href="main.css" />

  <style type="text/tailwindcss">
    @layer utilities {
      .text-color-base   { @apply text-zinc-900 dark:text-zinc-100; }
      .text-color-muted  { @apply text-zinc-500 dark:text-zinc-400; }
      .border-color-base { @apply border-zinc-200 dark:border-zinc-800; }
      .hover-bg-base     { @apply hover:bg-zinc-100 dark:hover:bg-zinc-800; }
      .glass-card        { @apply rounded-2xl border border-color-base bg-white/60 dark:bg-zinc-900/40 backdrop-blur; }
      .textured-background { @apply bg-gradient-to-b from-zinc-50 to-zinc-100 dark:from-zinc-950 dark:to-zinc-900; }
      .content-container { @apply container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8; }
    }

    /* 3D glass effect text (visual only; no glass backgrounds) */
    #digital-clock-3d,
    #digital-clock-3d * ,
    #hero-session-widget,
    #hero-session-widget * {
      color: rgba(63, 63, 70, 0.85);
      text-shadow:
        0 1px 1px rgba(255, 255, 255, 0.8),
        0 -1px 1px rgba(0, 0, 0, 0.25);
    }
    .dark #digital-clock-3d,
    .dark #digital-clock-3d * ,
    .dark #hero-session-widget,
    .dark #hero-session-widget * {
      color: rgba(228, 228, 231, 0.9);
      text-shadow:
        0 1px 1px rgba(255, 255, 255, 0.2),
        0 -1px 1px rgba(0, 0, 0, 0.5);
    }
    /* Stop blinking */
    #digital-clock-3d .colon { animation: none; }
  </style>
</head>

<body class="antialiased textured-background">

  <!-- Loader -->
  <div id="app-loader" class="fixed inset-0 flex items-center justify-center bg-gray-900/80 z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <div id="app-wrapper" style="display: none;">

    <!-- Sidebar overlay + aside -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 hidden"></div>

    <aside id="sidebar"
      class="fixed top-0 left-0 h-full w-72 bg-[#111827]/80 backdrop-blur-lg shadow-2xl z-50 transform -translate-x-full
             transition-transform duration-300 will-change-transform">
      <div class="p-6 flex flex-col h-full">
        <div class="flex justify-between items-center mb-8">
          <div class="text-xl font-bold tracking-wider text-white">
            <a href="member_dashboard.html">FINEX</a>
          </div>
          <button id="close-sidebar-btn" class="text-gray-400 hover:text-white">
            <i class="fas fa-times fa-lg"></i>
          </button>
        </div>

        <nav id="sidebar-nav" class="flex flex-col space-y-2 text-lg overflow-y-auto"></nav>

        <div class="mt-auto">
          <a href="#" id="logout-btn"
             class="flex items-center gap-4 text-red-400 hover:text-red-300 hover:bg-red-500/10 p-3 rounded-lg transition-colors">
            <i class="fas fa-sign-out-alt fa-fw w-6"></i>
            <span>Log Out</span>
          </a>
        </div>
      </div>
    </aside>

    <!-- Header (email removed) -->
    <header id="header" class="header backdrop-blur-md sticky top-0 z-30 h-[68px]">
      <div class="container mx-auto h-full flex justify-between items-center px-4">
        <div class="flex items-center gap-4">
          <button id="open-sidebar-btn" class="text-color-base hover:text-blue-500 p-2 rounded-full hover-bg-base">
            <i class="fas fa-bars fa-lg"></i>
          </button>
          <div id="page-title" class="text-2xl font-bold tracking-wider text-color-base">Finex</div>
        </div>
        <nav class="flex items-center gap-4">
          <!-- Email span removed -->
          <a href="settings.html" class="text-color-base p-2 rounded-full hover-bg-base">
            <i class="fas fa-user-circle fa-lg"></i>
          </a>
        </nav>
      </div>
    </header>

    <!-- MAIN -->
    <main>

      <!-- HERO (fills viewport minus header) -->
      <section class="container mx-auto min-h-[calc(100svh-68px)] flex flex-col items-center justify-center text-center p-4 relative overflow-hidden">

        <div class="max-w-3xl">
          <h1 class="text-4xl md:text-6xl font-bold text-color-base">
            Welcome back, <span id="member-name">Member</span>.
          </h1>
          <p class="text-lg md:text-xl text-color-muted mt-4 max-w-xl mx-auto">
            Your journey to financial clarity continues. What will you master today?
          </p>
        </div>

        <!-- Bottom bar pinned inside viewport -->
        <div
          class="absolute z-10 flex items-end justify-between gap-2 w-full"
          style="
            left:  max(10px, env(safe-area-inset-left));
            right: max(10px, env(safe-area-inset-right));
            bottom: max(20px, env(safe-area-inset-bottom));
          "
        >
          <!-- Left: Session & pairs -->
          <div id="hero-session-widget" class="text-left px-3 py-2 rounded-xl">
            <h3 id="hero-session-name" class="text-base md:text-lg font-bold leading-tight">--</h3>
            <ul id="hero-best-pairs" class="text-xs md:text-sm font-medium flex flex-wrap gap-2 mt-1">
              <li class="inline-block">--</li>
            </ul>
          </div>

          <!-- Down arrow (centered) -->
          <a href="#dashboard-content"
             class="text-color-muted hover:text-color-base transition-colors inline-flex items-center justify-center mx-auto"
             aria-label="Scroll to content"
             style="position:absolute; left:50%; transform:translateX(-50%); bottom:0;">
            <i class="fas fa-chevron-down text-2xl md:text-3xl animate-bounce"></i>
          </a>

          <!-- Right: Clock (with 1ch spacing from right border) -->
          <div id="digital-clock-3d"
               class="ml-auto text-2xl md:text-3xl font-bold font-sans p-1 mr-[1ch]"></div>
        </div>
      </section>

      <!-- DASHBOARD CONTENT -->
      <section id="dashboard-content" class="content-container pt-16 md:pt-20 space-y-10">
        <!-- Featured card -->
        <article class="glass-card flex flex-col md:flex-row items-center gap-8 p-8 transition-all duration-300 hover:border-blue-500/50">
          <div class="text-7xl text-blue-500 flex-shrink-0" aria-hidden="true">
            <i class="fas fa-book-open"></i>
          </div>
          <div>
            <span class="text-sm font-semibold text-blue-400 uppercase tracking-wider">Featured Guide</span>
            <h2 class="text-3xl font-bold mt-2 mb-3">Your Guide: The 5 Pillars of Wealth</h2>
            <p class="text-color-muted mb-6">Start with the fundamentals. This guide covers the core principles for building a strong financial foundation.</p>
            <a href="articles.html" class="main-button font-bold py-3 px-6 rounded-lg inline-block">Start Learning</a>
          </div>
        </article>

        <!-- Session + Pairs (plain, no glass) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="rounded-2xl border border-color-base p-6 flex flex-col justify-center bg-transparent">
            <h3 class="text-xl font-bold text-color-base mb-1">Current Trading Session</h3>
            <p id="session-name" class="text-2xl font-semibold text-blue-400">--</p>
          </div>
          <div class="rounded-2xl border border-color-base p-6 flex flex-col justify-center bg-transparent">
            <h3 class="text-xl font-bold text-color-base mb-2">Top Pairs by Volatility</h3>
            <ul id="best-pairs" class="flex flex-wrap gap-x-3 gap-y-2 text-base font-medium text-color-base">
              <li class="inline-block">--</li>
            </ul>
          </div>
        </div>

        <!-- Live blocks -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass-card h-[500px] flex flex-col p-6">
            <h3 class="text-2xl font-bold mb-4">Al Jazeera English Live</h3>
            <div class="aspect-video mb-4 rounded-lg overflow-hidden">
              <iframe
                src="https://www.youtube.com/embed/gCNeDWCI0vo?autoplay=1&mute=1"
                title="Al Jazeera English 24/7 Live"
                class="w-full h-full"
                loading="lazy"
                referrerpolicy="strict-origin-when-cross-origin"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>
            </div>
            <div class="mt-auto">
              <h4 class="text-lg font-semibold">Live Global News</h4>
              <p class="text-sm text-color-muted">24/7 coverage of global news, finance, and major events.</p>
            </div>
          </div>

          <div class="glass-card h-[500px] flex flex-col p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold">Live Market Updates</h3>
              <button id="news-refresh-btn" class="text-color-muted hover:text-blue-500 transition-colors" title="Refresh Feed">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>

            <div class="flex w-full h-9 items-center justify-center rounded-lg bg-black/20 p-1 mb-4" id="news-tab-container">
              <button class="news-tab-btn flex-1"
                data-tab-name="LiveSquawk"
                data-tab-url="https://www.investing.com/rss/news.rss"
                data-tab-link="https://www.investing.com/news/latest-news"
                data-state="inactive">
                LiveSquawk
              </button>
              <button class="news-tab-btn flex-1"
                data-tab-name="PiQ"
                data-tab-url="https://www.investing.com/rss/news_285.rss"
                data-tab-link="https://www.investing.com/news/forex-news"
                data-state="inactive">
                PiQ
              </button>
              <button class="news-tab-btn flex-1"
                data-tab-name="FinancialJuice"
                data-tab-url="https://www.dailyfx.com/rss/market_news.xml"
                data-tab-link="https://www.dailyfx.com/market-news"
                data-state="inactive">
                FinancialJuice
              </button>
            </div>

            <div id="news-content-container" class="flex-grow overflow-y-auto pr-2 space-y-4" aria-live="polite">
              <p class="text-color-muted text-center" id="news-loading-text">Loading live feed...</p>
            </div>

            <div class="mt-auto pt-4 border-t border-color-base">
              <a href="https://www.investing.com/news/latest-news" id="view-more-link" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 hover:underline">
                View more <i class="fas fa-external-link-alt fa-xs ml-1"></i>
              </a>
            </div>
          </div>
        </div>

        <!-- Live Forex -->
        <div class="glass-card p-8">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">Live Forex (vs. USD)</h3>
            <p class="text-sm text-color-muted" id="currency-last-updated">Updating...</p>
          </div>
          <div id="currency-strength-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4" aria-live="polite">
            <p class="text-color-muted text-center">Loading live rates...</p>
          </div>
        </div>

        <!-- Latest -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass-card p-8">
            <h3 class="text-2xl font-bold mb-4">Fresh Insights</h3>
            <div id="latest-articles-list" class="space-y-2">
              <p class="text-color-muted text-center">Loading latest articles...</p>
            </div>
          </div>

          <div class="glass-card p-8">
            <h3 class="text-2xl font-bold mb-4">Latest Analysis</h3>
            <div id="latest-analysis-list" class="space-y-2">
              <p class="text-color-muted text-center">Loading latest analysis...</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    try {
      /* 3D CLOCK */
      function updateClock() {
        const clockElement = document.getElementById('digital-clock-3d');
        if (!clockElement) return;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        clockElement.innerHTML = `
          <span>${hours}</span>
          <span class="colon text-3xl md:text-4xl">:</span>
          <span>${minutes}</span>
          <span class="colon text-3xl md:text-4xl">:</span>
          <span class="text-2xl md:text-3xl opacity-80">${seconds}</span>
        `;
      }
      updateClock();
      setInterval(updateClock, 1000);

      /* Core app */
      const { initializeAppCore, db } = await import('./app.js');
      const { collection, onSnapshot, query, orderBy, limit } =
        await import("https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js");

      const rssFeedCache = new Map();

      /* Session & pairs — fixed names */
      function updateSessionInfo() {
        const sessionElement = document.getElementById('session-name');
        const pairsElement = document.getElementById('best-pairs');
        const heroSessionElement = document.getElementById('hero-session-name');
        const heroPairsElement = document.getElementById('hero-best-pairs');

        if (!sessionElement && !pairsElement && !heroSessionElement && !heroPairsElement) return;

        const now = new Date();
        const utcHour = now.getUTCHours();
        const utcDay = now.getUTCDay();

        let sessionName = "";
        let bestPairs = [];

        if ((utcDay === 5 && utcHour >= 21) || utcDay === 6 || (utcDay === 0 && utcHour < 21)) {
          sessionName = "Market Closed";
          bestPairs = ["--"];
        } else if (utcHour >= 12 && utcHour < 16) {
          sessionName = "London / New York Overlap";
          bestPairs = ["EUR/USD", "GBP/USD", "USD/JPY"];
        } else if (utcHour >= 7 && utcHour < 9) {
          sessionName = "Tokyo / London Overlap";
          bestPairs = ["EUR/JPY", "GBP/JPY", "CHF/JPY"];
        } else if (utcHour >= 0 && utcHour < 6) {
          sessionName = "Sydney / Tokyo Overlap";
          bestPairs = ["AUD/JPY", "NZD/JPY", "USD/JPY"];
        } else if (utcHour >= 9 && utcHour < 12) {
          sessionName = "London Session";
          bestPairs = ["EUR/USD", "GBP/USD", "USD/CHF"];
        } else if (utcHour >= 16 && utcHour < 21) {
          sessionName = "New York Session";
          bestPairs = ["USD/CAD", "AUD/USD", "NZD/USD"];
        } else if (utcHour >= 6 && utcHour < 7) {
          sessionName = "Tokyo Session";
          bestPairs = ["USD/JPY", "AUD/JPY", "NZD/JPY"];
        } else if (utcHour >= 21) {
          sessionName = "Sydney Session";
          bestPairs = ["AUD/USD", "NZD/USD", "AUD/JPY"];
        } else {
          sessionName = "Market Open (Low Volatility)";
          bestPairs = ["--"];
        }

        if (sessionElement) sessionElement.textContent = sessionName;
        if (heroSessionElement) heroSessionElement.textContent = sessionName;

        const renderPairs = (ul, pairs, chip=false) => {
          if (!ul) return;
          ul.innerHTML = "";
          pairs.forEach(pair => {
            ul.innerHTML += chip
              ? `<li class="px-2.5 py-1 bg-zinc-100 dark:bg-zinc-800 rounded-md shadow-sm">${pair}</li>`
              : `<li>${pair}</li>`;
          });
        };

        renderPairs(pairsElement, bestPairs, true);
        renderPairs(heroPairsElement, bestPairs, false);
      }

      /* Smooth scroll */
      function scrollToContent() {
        const el = document.getElementById('dashboard-content');
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      document.querySelector('a[href="#dashboard-content"]')
        ?.addEventListener('click', (e) => { e.preventDefault(); scrollToContent(); });

      /* News helpers */
      function formatTimeAgo(dateString) {
        const time = new Date(dateString);
        const now = new Date();
        const diffInMinutes = Math.floor((now.getTime() - time.getTime()) / 60000);
        if (diffInMinutes < 1) return "just now";
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `${diffInHours}h ago`;
        const diffInDays = Math.floor(diffInHours / 24);
        return `${diffInDays}d ago`;
      }

      async function fetchRSSFeed(feedUrl, sourceName, containerId, forceRefresh = false) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = `<p class="text-color-muted text-center">Loading ${sourceName} feed...</p>`;
        if (rssFeedCache.has(feedUrl) && !forceRefresh) {
          renderRSSFeed(rssFeedCache.get(feedUrl), sourceName, container);
          return;
        }
        try {
          const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
          if (!response.ok) throw new Error('Network error');
          const data = await response.json();
          if (data.status !== 'ok') throw new Error('RSS feed error');
          rssFeedCache.set(feedUrl, data.items);
          renderRSSFeed(data.items, sourceName, container);
        } catch (error) {
          console.error("Error fetching RSS feed:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load ${sourceName} feed.</p>`;
        }
      }

      function renderRSSFeed(items, sourceName, container) {
        if (!container) return;
        container.innerHTML = '';
        if (!items || items.length === 0) {
          container.innerHTML = `<p class="text-color-muted text-center">No news available.</p>`;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach(item => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = item.description;
          const description = (tempDiv.textContent || tempDiv.innerText || "").trim();
          const iconClass = sourceName === "LiveSquawk" ? "fa-satellite-dish"
                          : sourceName === "PiQ" ? "fa-chart-pie"
                          : "fa-newspaper";
          const node = document.createElement('div');
          node.innerHTML = `
            <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="news-item hover-bg-base transition-colors rounded-lg">
              <div class="news-item-icon">
                <i class="fas ${iconClass}"></i>
              </div>
              <div class="news-item-content">
                <div class="news-item-meta">
                  <span class="news-item-source">${sourceName}</span>
                  <span class="news-item-time">${formatTimeAgo(item.pubDate)}</span>
                </div>
                <h4 class="news-item-title">${item.title}</h4>
                <p class="news-item-desc">${description}</p>
              </div>
            </a>`;
          fragment.appendChild(node);
        });
        container.appendChild(fragment);
      }

      /* Live currency rates */
      async function loadLiveCurrencyRates() {
        const container = document.getElementById('currency-strength-container');
        const lastUpdatedEl = document.getElementById('currency-last-updated');
        if (!container || !lastUpdatedEl) return;

        container.innerHTML = '<p class="text-color-muted text-center">Loading live rates...</p>';

        try {
          const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR,JPY,GBP,AUD,CAD,CHF,NZD');
          if (!response.ok) throw new Error('Network response was not ok');
          const data = await response.json();

          const yesterday = new Date(data.date);
          yesterday.setDate(yesterday.getDate() - 1);
          const yds = yesterday.toISOString().split('T')[0];

          const r2 = await fetch(`https://api.frankfurter.app/${yds}?from=USD&to=EUR,JPY,GBP,AUD,CAD,CHF,NZD`);
          if (!r2.ok) throw new Error('Network response for historical data was not ok');
          const old = await r2.json();

          const { rates } = data;
          const oldRates = old.rates;

          container.innerHTML = '';
          const currencies = ['EUR','JPY','GBP','AUD','CAD','CHF','NZD'];

          currencies.forEach(ccy => {
            if (!rates?.[ccy] || !oldRates?.[ccy]) return;
            const current = rates[ccy];
            const prev = oldRates[ccy];
            const change = ((current - prev) / prev) * 100;

            const changeStyle = change > 0.01 ? { class:'change-green', icon:'▲' }
                              : change < -0.01 ? { class:'change-red', icon:'▼' }
                              : { class:'change-gray', icon:'■' };

            const rateString = ccy === 'JPY'
              ? `1 USD = ${current.toFixed(2)} ${ccy}`
              : `1 ${ccy} = ${(1 / current).toFixed(4)} USD`;

            container.innerHTML += `
              <div class="space-y-1">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-color-base">${ccy}</span>
                  </div>
                  <div class="flex items-center">
                    <span class="text-sm font-medium text-color-base">${rateString}</span>
                    <span class="text-xs ml-2 ${changeStyle.class}">${changeStyle.icon} ${Math.abs(change).toFixed(2)}%</span>
                  </div>
                </div>
              </div>`;
          });

          lastUpdatedEl.textContent = `Live data from ${data.date}`;
        } catch (error) {
          console.error("Error fetching currency rates:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load live rates.</p>`;
          lastUpdatedEl.textContent = 'Error updating data';
        }
      }

      /* News tabs */
      function loadLiveNewsTabs() {
        const tabContainer = document.getElementById('news-tab-container');
        const refreshButton = document.getElementById('news-refresh-btn');
        const moreLink = document.getElementById('view-more-link');
        if (!tabContainer || !refreshButton || !moreLink) return;

        const activeTabClasses = ['bg-blue-500','text-white','shadow'];
        const inactiveTabClasses = ['text-zinc-400','hover:text-zinc-50'];
        const baseTabClasses = ['flex-1','inline-flex','items-center','justify-center','whitespace-nowrap','rounded-md','px-3','py-1','text-sm','font-medium','transition-all','cursor-pointer'];

        let activeTab = tabContainer.querySelector('.news-tab-btn[data-tab-name="LiveSquawk"]');

        function styleTabs() {
          tabContainer.querySelectorAll('.news-tab-btn').forEach(tab => {
            tab.classList.remove(...activeTabClasses, ...inactiveTabClasses);
            tab.classList.add(...baseTabClasses);
            if (tab === activeTab) {
              tab.setAttribute('data-state','active');
              tab.classList.add(...activeTabClasses);
            } else {
              tab.setAttribute('data-state','inactive');
              tab.classList.add(...inactiveTabClasses);
            }
          });
        }

        tabContainer.addEventListener('click', (e) => {
          const button = e.target.closest('button.news-tab-btn');
          if (!button) return;
          activeTab = button;
          styleTabs();
          moreLink.href = button.dataset.tabLink;
          fetchRSSFeed(button.dataset.tabUrl, button.dataset.tabName, 'news-content-container');
        });

        refreshButton.addEventListener('click', () => {
          const icon = refreshButton.querySelector('i');
          icon.classList.add('animate-spin');
          fetchRSSFeed(activeTab.dataset.tabUrl, activeTab.dataset.tabName, 'news-content-container', true);
          setTimeout(() => icon.classList.remove('animate-spin'), 500);
        });

        styleTabs();
        if (activeTab) {
          fetchRSSFeed(activeTab.dataset.tabUrl, activeTab.dataset.tabName, 'news-content-container');
        }
      }

      /* Latest articles */
      function loadLatestArticles(db) {
        const container = document.getElementById('latest-articles-list');
        if (!container) return;
        const q = query(collection(db, "articles"), orderBy("createdAt", "desc"), limit(3));
        onSnapshot(q, (snapshot) => {
          container.innerHTML = '';
          if (snapshot.empty) {
            container.innerHTML = `<p class="text-color-muted text-center">No articles available yet.</p>`;
            return;
          }
          snapshot.forEach((doc, index) => {
            const article = { id: doc.id, ...doc.data() };
            container.innerHTML += `
              <div class="p-4 rounded-lg group hover-bg-base transition-colors">
                <a href="articles.html?id=${article.id}" class="text-lg font-semibold text-color-base group-hover:text-blue-500">${article.title}</a>
                <p class="text-color-muted text-sm">${article.readTime || '? min read'} • ${article.createdAt ? article.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
              </div>
              ${index < snapshot.docs.length - 1 ? '<hr class="border-color-base mx-4">' : ''}`;
          });
        }, (error) => {
          console.error("Error fetching latest articles:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load articles.</p>`;
        });
      }

      /* Latest analysis */
      function loadLatestAnalysis(db) {
        const container = document.getElementById('latest-analysis-list');
        if (!container) return;
        const q = query(collection(db, "analysis"), orderBy("createdAt", "desc"), limit(3));
        onSnapshot(q, (snapshot) => {
          container.innerHTML = '';
          if (snapshot.empty) {
            container.innerHTML = `<p class="text-color-muted text-center">No analysis available yet.</p>`;
            return;
          }
          snapshot.forEach((doc, index) => {
            const analysis = { id: doc.id, ...doc.data() };
            container.innerHTML += `
              <div class="p-4 rounded-lg group hover-bg-base transition-colors">
                <a href="analysis.html?id=${analysis.id}" class="text-lg font-semibold text-color-base group-hover:text-blue-500">${analysis.title}</a>
                <p class="text-color-muted text-sm">Category: ${analysis.category || 'General'} • ${analysis.createdAt ? analysis.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
              </div>
              ${index < snapshot.docs.length - 1 ? '<hr class="border-color-base mx-4">' : ''}`;
          });
        }, (error) => {
          console.error("Error fetching latest analysis:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load analysis.</p>`;
        });
      }

      /* Init page via app.js (will hide loader once auth is known) */
      function initDashboardPage(user, db, userProfile) {
        const memberNameEl = document.getElementById('member-name');
        if (memberNameEl && userProfile?.displayName) {
          const name = userProfile.displayName;
          memberNameEl.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        }

        loadLatestArticles(db);
        loadLatestAnalysis(db);
        loadLiveNewsTabs();
        loadLiveCurrencyRates();

        updateSessionInfo();
        setInterval(updateSessionInfo, 300000);
      }

      initializeAppCore(initDashboardPage);

    } catch (error) {
      console.error("Failed to initialize the application:", error);
      const appLoader = document.getElementById('app-loader');
      if (appLoader) appLoader.style.display = 'none';
      const appWrapper = document.getElementById('app-wrapper');
      if (appWrapper) appWrapper.style.display = 'block';

      const mainContent = document.querySelector('main');
      if (mainContent) {
        mainContent.innerHTML = `
          <div style="padding:40px; text-align:center; color:#f87171; height:calc(100vh - 68px); display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h1 style="font-size:2.25rem; font-weight:bold; margin-bottom:1rem;">Page Load Error</h1>
            <p style="color:#fca5a5; margin-bottom:0.5rem;">Could not connect to the Finex application.</p>
            <p style="color:#fca5a5; font-size:0.875rem; max-width:600px;">This may be due to a network error or a browser extension (like an ad blocker) blocking a required script. Please check your connection, disable your ad blocker for this site, and try again.</p>
            <p style="font-size:0.75rem; color:#b91c1c; margin-top:1rem;">Error details: ${error.message}</p>
          </div>`;
      }
    }
  </script>
</body>
</html>
