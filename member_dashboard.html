<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>
    /* --- Prevent dark/light flicker --- */
    try {
      const theme = localStorage.getItem('finex_theme');
      if (theme === 'light') document.documentElement.classList.remove('dark');
      else document.documentElement.classList.add('dark');
    } catch { document.documentElement.classList.add('dark'); }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Member Dashboard | Finex - Financial Clarity</title>

  <meta name="description" content="Your personal dashboard for tracking financial growth, accessing exclusive guides, and analyzing trading results on the Finex platform.">
  <meta property="og:title" content="Member Dashboard | Finex">
  <meta property="og:description" content="Your personal hub for financial tools and clarity.">
  <meta name="twitter:title" content="Member Dashboard | Finex">
  <meta name="twitter:description" content="Your personal hub for financial tools and clarity.">

  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js" />
  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js" />
  <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <link rel="stylesheet" href="main.css" />

  <style type="text/tailwindcss">
    @layer utilities {
      .text-color-base   { @apply text-zinc-900 dark:text-zinc-100; }
      .text-color-muted  { @apply text-zinc-500 dark:text-zinc-400; }
      .border-color-base { @apply border-zinc-200 dark:border-zinc-800; }
      .hover-bg-base     { @apply hover:bg-zinc-100 dark:hover:bg-zinc-800; }
      .glass-card        { @apply rounded-2xl border border-color-base bg-white/60 dark:bg-zinc-900/40 backdrop-blur; }
      .textured-background { @apply bg-gradient-to-b from-zinc-50 to-zinc-100 dark:from-zinc-950 dark:to-zinc-900; }
    }

    .strength-bar-bg { @apply w-full bg-zinc-100 rounded-full h-1.5 dark:bg-zinc-800; }
    .strength-bar { @apply h-1.5 rounded-full; }
    .strength-bar-green { @apply bg-green-500; }
    .strength-bar-light-green { @apply bg-green-300; }
    .strength-bar-yellow { @apply bg-yellow-300; }
    .strength-bar-orange { @apply bg-orange-400; }
    .strength-bar-red { @apply bg-red-500; }
    .change-green { @apply text-green-500; }
    .change-red { @apply text-red-500; }
    .change-gray { @apply text-gray-500; }

    .news-item { @apply flex items-start space-x-3 p-3; }
    .news-item-icon { @apply h-10 w-10 rounded-full flex-shrink-0 bg-zinc-200 dark:bg-zinc-700 flex items-center justify-center; }
    .news-item-icon i { @apply text-zinc-500 text-lg; }
    .news-item-content { @apply flex-1 min-w-0; }
    .news-item-meta { @apply flex items-center space-x-2; }
    .news-item-source { @apply text-sm font-semibold text-color-base; }
    .news-item-time { @apply text-xs text-color-muted; }
    .news-item-desc {
      @apply text-sm text-color-base mt-1;
      display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2;
      overflow: hidden; text-overflow: ellipsis;
    }

    /* --- 3D GLASS TEXT STYLES --- */
    .glass-text {
      /* Light Mode Default */
      color: rgba(63, 63, 70, 0.75); /* text-zinc-700 with 75% opacity */
      text-shadow:
        0 1px 1px rgba(255, 255, 255, 0.8), /* Top highlight */
        0 -1px 1px rgba(0, 0, 0, 0.2);     /* Bottom shadow */
    }

    .dark .glass-text {
      /* Dark Mode Override */
      color: rgba(228, 228, 231, 0.75); /* text-zinc-200 with 75% opacity */
      text-shadow:
        0 1px 1px rgba(255, 255, 255, 0.2), /* Top highlight */
        0 -1px 1px rgba(0, 0, 0, 0.5);     /* Bottom shadow */
    }
    
    /* Apply base glass text style to the clock's child elements */
    #digital-clock-3d > span {
      @apply glass-text;
    }
    
    /* Make the colon blink */
    #digital-clock-3d .colon {
      animation: blink 1s step-end infinite;
      /* Tweak position to look centered */
      @apply relative -top-1 md:-top-2;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }
    /* --- END NEW 3D GLASS TEXT STYLES --- */
  </style>
</head>

<body class="antialiased textured-background">

  <div id="app-loader" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-80 z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <div id="app-wrapper" style="display: none;">
    <header id="header-placeholder"></header>
    <div id="sidebar-placeholder"></div>

    <main class="pt-[68px]">
      <section class="container mx-auto min-h-screen flex flex-col items-center justify-center text-center p-4 relative">
        
        <div class="max-w-3xl">
          <h1 class="text-4xl md:text-6xl font-bold text-color-base">
            Welcome back, <span id="member-name">Member</span>.
          </h1>
          <p class="text-lg md:text-xl text-color-muted mt-4 max-w-xl mx-auto">
            Your journey to financial clarity continues. What will you master today?
          </p>
        </div>

        <div class="absolute inset-x-0 bottom-0 px-4 md:px-6 pb-3 md:pb-5 flex justify-between items-end">

            <div id="hero-session-widget" class="glass-text text-left p-4">
                <h3 id="hero-session-name" class="text-2xl md:text-3xl font-bold">--</h3>
                <ul id="hero-best-pairs" class="text-sm font-medium space-y-1 mt-2">
                    <li>--</li>
                </ul>
            </div>

            <div>
              <a href="#dashboard-content" class="text-color-muted animate-bounce" aria-label="Scroll to content">
                <i class="fas fa-chevron-down fa-2x" aria-hidden="true"></i>
              </a>
            </div>

            <div id="digital-clock-3d" class="text-4xl md:text-5xl font-bold font-sans p-4">
              </div>
        
        </div>
        </section>

      <section id="dashboard-content" class="scroll-mt-[84px] container mx-auto pt-16 md:py-20 space-y-10">
        <article class="glass-card flex flex-col md:flex-row items-center gap-8 p-8 transition-all duration-300 hover:border-blue-500/50">
          <div class="text-7xl text-blue-500 flex-shrink-0" aria-hidden="true">
            <i class="fas fa-book-open"></i>
          </div>
          <div>
            <span class="text-sm font-semibold text-blue-400 uppercase tracking-wider">Featured Guide</span>
            <h2 class="text-3xl font-bold mt-2 mb-3">Your Guide: The 5 Pillars of Wealth</h2>
            <p class="text-color-muted mb-6">Start with the fundamentals. This guide covers the core principles for building a strong financial foundation.</p>
            <a href="articles.html" class="main-button font-bold py-3 px-6 rounded-lg inline-block">Start Learning</a>
          </div>
        </article>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass-card p-6 flex flex-col justify-center">
            <h3 class="text-xl font-bold text-color-base mb-1">Current Trading Session</h3>
            <p id="session-name" class="text-2xl font-semibold text-blue-400">--</p>
          </div>
          <div class="glass-card p-6 flex flex-col justify-center">
            <h3 class="text-xl font-bold text-color-base mb-2">Top Pairs by Volatility</h3>
            <ul id="best-pairs" class="flex flex-wrap gap-x-3 gap-y-2 text-base font-medium text-color-base">
              <li>--</li>
            </ul>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass-card h-[500px] flex flex-col p-6">
            <h3 class="text-2xl font-bold mb-4">Al Jazeera English Live</h3>
            <div class="aspect-video mb-4 rounded-lg overflow-hidden">
              <iframe
                src="https://www.youtube.com/embed/gCNeDWCI0vo?autoplay=1&mute=1"
                title="Al Jazeera English 24/7 Live"
                class="w-full h-full"
                loading="lazy"
                referrerpolicy="strict-origin-when-cross-origin"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>
            </div>
            <div class="mt-auto">
              <h4 class="text-lg font-semibold">Live Global News</h4>
              <p class="text-sm text-color-muted">24/7 coverage of global news, finance, and major events.</p>
            </div>
          </div>

          <div class="glass-card h-[500px] flex flex-col p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold">Live Market Updates</h3>
              <button id="news-refresh-btn" class="text-color-muted hover:text-blue-500 transition-colors" title="Refresh Feed">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>

            <div class="flex w-full h-9 items-center justify-center rounded-lg bg-black/20 p-1 mb-4" id="news-tab-container">
              <button class="news-tab-btn flex-1"
                data-tab-name="LiveSquawk"
                data-tab-url="https://www.investing.com/rss/news.rss"
                data-tab-link="https://www.investing.com/news/latest-news"
                data-state="inactive">
                LiveSquawk
              </button>
              <button class="news-tab-btn flex-1"
                data-tab-name="PiQ"
                data-tab-url="https://www.investing.com/rss/news_285.rss"
                data-tab-link="https://www.investing.com/news/forex-news"
                data-state="inactive">
                PiQ
              </button>
              <button class="news-tab-btn flex-1"
                data-tab-name="FinancialJuice"
                data-tab-url="https://www.dailyfx.com/rss/market_news.xml"
                data-tab-link="https://www.dailyfx.com/market-news"
                data-state="inactive">
                FinancialJuice
              </button>
            </div>

            <div id="news-content-container" class="flex-grow overflow-y-auto pr-2 space-y-4" aria-live="polite">
              <p class="text-color-muted text-center" id="news-loading-text">Loading live feed...</p>
            </div>

            <div class="mt-auto pt-4 border-t border-color-base">
              <a href="https://www.investing.com/news/latest-news" id="view-more-link" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 hover:underline">
                View more <i class="fas fa-external-link-alt fa-xs ml-1"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="glass-card p-8">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">Live Forex (vs. USD)</h3>
            <p class="text-sm text-color-muted" id="currency-last-updated">Updating...</p>
          </div>
          <div id="currency-strength-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4" aria-live="polite">
            <p class="text-color-muted text-center">Loading live rates...</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="glass-card p-8">
            <h3 class="text-2xl font-bold mb-4">Fresh Insights</h3>
            <div id="latest-articles-list" class="space-y-2">
              <p class="text-color-muted text-center">Loading latest articles...</p>
            </div>
          </div>

          <div class="glass-card p-8">
            <h3 class="text-2xl font-bold mb-4">Latest Analysis</h3>
            <div id="latest-analysis-list" class="space-y-2">
              <p class="text-color-muted text-center">Loading latest analysis...</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    try {
      // --- 3D CLOCK LOGIC (DASHBOARD ONLY) ---
      function updateClock() {
        const clockElement = document.getElementById('digital-clock-3d');
        if (!clockElement) return;

        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        
        clockElement.innerHTML = `
          <span>${hours}</span>
          <span class="colon text-3xl md:text-4xl">:</span>
          <span>${minutes}</span>
          <span class="colon text-3xl md:text-4xl">:</span>
          <span class="text-2xl md:text-3xl opacity-80">${seconds}</span>
        `;
      }
      updateClock(); // Run once on load
      setInterval(updateClock, 1000); // Run every second
      // --- END CLOCK LOGIC ---


      // Core app
      const { initializeAppCore, db } = await import('./app.js');
      const { collection, onSnapshot, query, orderBy, limit } =
        await import("https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js");

      const rssFeedCache = new Map();

      // --- SESSION & PAIRS FUNCTIONS (DASHBOARD ONLY) ---
      /**
       * Updates session name and pairs for BOTH the hero and main dashboard.
       */
      function updateSessionInfo() {
        // Get references to ALL session elements
        const sessionElement = document.getElementById('session-name');
        const pairsElement = document.getElementById('best-pairs');
        const heroSessionElement = document.getElementById('hero-session-name');
        const heroPairsElement = document.getElementById('hero-best-pairs');
        
        // Stop if *none* of the dashboard elements are on the page
        if (!sessionElement && !pairsElement && !heroSessionElement && !heroPairsElement) {
            return; 
        }

        const now = new Date();
        const utcHour = now.getUTCHours();
        const utcDay = now.getUTCDay(); // 0 = Sunday

        let sessionName = "";
        let bestPairs = [];

        // Market Closed Check (Friday 21:00 UTC to Sunday 21:00 UTC)
        if ((utcDay === 5 && utcHour >= 21) || utcDay === 6 || (utcDay === 0 && utcHour < 21)) {
            sessionName = "Market Closed";
            bestPairs = ["--"];
        }
        // London / New York Overlap (12:00 - 16:00 UTC)
        else if (utcHour >= 12 && utcHour < 16) { 
            sessionName = "London / New York Overlap";
            bestPairs = ["EUR/USD", "GBP/USD", "USD/JPY"];
        }
        // Tokyo / London Overlap (07:00 - 09:00 UTC)
        else if (utcHour >= 7 && utcHour < 9) {
            sessionName = "Tokyo / London Overlap";
            bestPairs = ["EUR/JPY", "GBP/JPY", "CHF/JPY"];
        }
        // Sydney / Tokyo Overlap (00:00 - 06:00 UTC)
        else if (utcHour >= 0 && utcHour < 6) {
            sessionName = "Sydney / Tokyo Overlap";
            bestPairs = ["AUD/JPY", "NZD/JPY", "USD/JPY"];
        }
        // London Session (Only) (09:00 - 12:00 UTC)
        else if (utcHour >= 9 && utcHour < 12) { 
            sessionName = "London Session";
            bestPairs = ["EUR/USD", "GBP/USD", "USD/CHF"];
        }
        // New York Session (Only) (16:00 - 21:00 UTC)
        else if (utcHour >= 16 && utcHour < 21) {
            sessionName = "New York Session";
            bestPairs = ["USD/CAD", "AUD/USD", "NZD/USD"];
        }
        // Tokyo Session (Only) (06:00 - 07:00 UTC)
        else if (utcHour >= 6 && utcHour < 7) {
            sessionName = "Tokyo Session";
            bestPairs = ["USD/JPY", "AUD/JPY", "NZD/JPY"];
        }
        // Sydney Session (Only) (21:00 - 00:00 UTC)
        else if (utcHour >= 21) {
            sessionName = "Sydney Session";
            bestPairs = ["AUD/USD", "NZD/USD", "AUD/JPY"];
        }
        // Fallback for gaps
        else {
            sessionName = "Market Open (Low Volatility)";
            bestPairs = ["--"];
        }

        // --- Update Session Name (Both locations) ---
        if (sessionElement) {
            sessionElement.textContent = sessionName;
        }
        if (heroSessionElement) {
            heroSessionElement.textContent = sessionName;
        }

        // --- Update Pairs for Main Dashboard Widget ---
        if (pairsElement) {
            pairsElement.innerHTML = ""; // Clear old list
            bestPairs.forEach(pair => {
                // Render pairs as styled tags
                pairsElement.innerHTML += `<li class="px-2.5 py-1 bg-zinc-100 dark:bg-zinc-800 rounded-md shadow-sm">${pair}</li>`;
            });
        }

        // --- Update Pairs for Hero Widget ---
        if (heroPairsElement) {
            heroPairsElement.innerHTML = ""; // Clear old list
            bestPairs.forEach(pair => {
                // Render pairs as simple list items
                heroPairsElement.innerHTML += `<li>${pair}</li>`;
            });
        }
      }
      // --- END: SESSION FUNCTIONS ---


      // Smooth scroll helper for the chevron anchor
      function scrollToContent() {
        const el = document.getElementById('dashboard-content');
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      document.querySelector('a[href="#dashboard-content"]')
        ?.addEventListener('click', (e) => { e.preventDefault(); scrollToContent(); });

      function initDashboardPage(user, db, userProfile) {
        const memberNameEl = document.getElementById('member-name');
        if (memberNameEl && userProfile?.displayName) {
          const name = userProfile.displayName;
          memberNameEl.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        }

        loadLatestArticles(db);
        loadLatestAnalysis(db);
        loadLiveNewsTabs();
        loadLiveCurrencyRates();

        // --- CALL SESSION INFO (DASHBOARD ONLY) ---
        updateSessionInfo(); // Run once on page load
        setInterval(updateSessionInfo, 300000); // Update session every 5 mins
        // --- END ---

        // Reveal content smoothly once layout is ready (optional)
        requestAnimationFrame(() => {
          const dc = document.getElementById('dashboard-content');
          if (dc) dc.classList.remove('opacity-0');
        });
      }

      function loadLatestArticles(db) {
        const container = document.getElementById('latest-articles-list');
        if (!container) return;
        const q = query(collection(db, "articles"), orderBy("createdAt", "desc"), limit(3));
        onSnapshot(q, (snapshot) => {
          container.innerHTML = '';
          if (snapshot.empty) {
            container.innerHTML = `<p class="text-color-muted text-center">No articles available yet.</p>`;
            return;
          }
          snapshot.forEach((doc, index) => {
            const article = { id: doc.id, ...doc.data() };
            container.innerHTML += `
              <div class="p-4 rounded-lg group hover-bg-base transition-colors">
                <a href="articles.html?id=${article.id}" class="text-lg font-semibold text-color-base group-hover:text-blue-500">${article.title}</a>
                <p class="text-color-muted text-sm">${article.readTime || '? min read'} • ${article.createdAt ? article.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
              </div>
              ${index < snapshot.docs.length - 1 ? '<hr class="border-color-base mx-4">' : ''}`;
          });
        }, (error) => {
          console.error("Error fetching latest articles:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load articles.</p>`;
        });
      }

      function loadLatestAnalysis(db) {
        const container = document.getElementById('latest-analysis-list');
        if (!container) return;
        const q = query(collection(db, "analysis"), orderBy("createdAt", "desc"), limit(3));
        onSnapshot(q, (snapshot) => {
          container.innerHTML = '';
          if (snapshot.empty) {
            container.innerHTML = `<p class="text-color-muted text-center">No analysis available yet.</p>`;
            return;
          }
          snapshot.forEach((doc, index) => {
            const analysis = { id: doc.id, ...doc.data() };
            container.innerHTML += `
              <div class="p-4 rounded-lg group hover-bg-base transition-colors">
                <a href="analysis.html?id=${analysis.id}" class="text-lg font-semibold text-color-base group-hover:text-blue-500">${analysis.title}</a>
                <p class="text-color-muted text-sm">Category: ${analysis.category || 'General'} • ${analysis.createdAt ? analysis.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
              </div>
              ${index < snapshot.docs.length - 1 ? '<hr class="border-color-base mx-4">' : ''}`;
          });
        }, (error) => {
          console.error("Error fetching latest analysis:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load analysis.</p>`;
        });
      }

      function formatTimeAgo(dateString) {
        const time = new Date(dateString);
        const now = new Date();
        const diffInMinutes = Math.floor((now.getTime() - time.getTime()) / 60000);
        if (diffInMinutes < 1) return "just now";
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `${diffInHours}h ago`;
        const diffInDays = Math.floor(diffInHours / 24);
        return `${diffInDays}d ago`;
      }

      async function fetchRSSFeed(feedUrl, sourceName, containerId, forceRefresh = false) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `<p class="text-color-muted text-center">Loading ${sourceName} feed...</p>`;

        if (rssFeedCache.has(feedUrl) && !forceRefresh) {
          renderRSSFeed(rssFeedCache.get(feedUrl), sourceName, container);
          return;
        }

        try {
          const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
          if (!response.ok) throw new Error('Network error');

          const data = await response.json();
          if (data.status !== 'ok') throw new Error('RSS feed error');

          rssFeedCache.set(feedUrl, data.items);
          renderRSSFeed(data.items, sourceName, container);

        } catch (error) {
          console.error("Error fetching RSS feed:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load ${sourceName} feed.</p>`;
        }
      }

      function renderRSSFeed(items, sourceName, container) {
        if (!container) return;
        container.innerHTML = '';

        if (!items || items.length === 0) {
          container.innerHTML = `<p class="text-color-muted text-center">No news available.</p>`;
          return;
        }

        const fragment = document.createDocumentFragment();

        items.forEach(item => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = item.description;
          const description = (tempDiv.textContent || tempDiv.innerText || "").trim();

          const iconClass = sourceName === "LiveSquawk" ? "fa-satellite-dish"
                          : sourceName === "PiQ" ? "fa-chart-pie"
                          : "fa-newspaper";

          const itemHTML = `
            <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="news-item hover-bg-base transition-colors rounded-lg">
              <div class="news-item-icon">
                <i class="fas ${iconClass}"></i>
              </div>
              <div class="news-item-content">
                <div class="news-item-meta">
                  <span class="news-item-source">${sourceName}</span>
                  <span class="news-item-time">${formatTimeAgo(item.pubDate)}</span>
                </div>
                <h4 class="news-item-title">${item.title}</h4>
                <p class="news-item-desc">${description}</p>
              </div>
            </a>`;
          const node = document.createElement('div');
          node.innerHTML = itemHTML;
          fragment.appendChild(node);
        });

        container.appendChild(fragment);
      }

      function loadLiveNewsTabs() {
        const tabContainer = document.getElementById('news-tab-container');
        const refreshButton = document.getElementById('news-refresh-btn');
        const moreLink = document.getElementById('view-more-link');
        if (!tabContainer || !refreshButton || !moreLink) return;

        const activeTabClasses = ['bg-blue-500','text-white','shadow'];
        const inactiveTabClasses = ['text-zinc-400','hover:text-zinc-50'];
        const baseTabClasses = ['flex-1','inline-flex','items-center','justify-center','whitespace-nowrap','rounded-md','px-3','py-1','text-sm','font-medium','transition-all','cursor-pointer'];

        let activeTab = tabContainer.querySelector('.news-tab-btn[data-tab-name="LiveSquawk"]');

        function styleTabs() {
          tabContainer.querySelectorAll('.news-tab-btn').forEach(tab => {
            tab.classList.remove(...activeTabClasses, ...inactiveTabClasses);
            tab.classList.add(...baseTabClasses);
            if (tab === activeTab) {
              tab.setAttribute('data-state','active');
              tab.classList.add(...activeTabClasses);
            } else {
              tab.setAttribute('data-state','inactive');
              tab.classList.add(...inactiveTabClasses);
            }
          });
        }

        tabContainer.addEventListener('click', (e) => {
          const button = e.target.closest('button.news-tab-btn');
          if (!button) return;
          activeTab = button;
          styleTabs();
          moreLink.href = button.dataset.tabLink;
          fetchRSSFeed(button.dataset.tabUrl, button.dataset.tabName, 'news-content-container');
        });

        refreshButton.addEventListener('click', () => {
          const icon = refreshButton.querySelector('i');
          icon.classList.add('animate-spin');
          fetchRSSFeed(activeTab.dataset.tabUrl, activeTab.dataset.tabName, 'news-content-container', true);
          setTimeout(() => icon.classList.remove('animate-spin'), 500);
        });

        styleTabs();
        if (activeTab) {
          fetchRSSFeed(activeTab.dataset.tabUrl, activeTab.dataset.tabName, 'news-content-container');
        }
      }

      async function loadLiveCurrencyRates() {
        const container = document.getElementById('currency-strength-container');
        const lastUpdatedEl = document.getElementById('currency-last-updated');
        if (!container || !lastUpdatedEl) return;

        container.innerHTML = '<p class="text-color-muted text-center">Loading live rates...</p>';

        try {
          const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR,JPY,GBP,AUD,CAD,CHF,NZD');
          if (!response.ok) throw new Error('Network response was not ok');
          const data = await response.json();

          const yesterday = new Date(data.date);
          yesterday.setDate(yesterday.getDate() - 1);
          const yds = yesterday.toISOString().split('T')[0];

          const r2 = await fetch(`https://api.frankfurter.app/${yds}?from=USD&to=EUR,JPY,GBP,AUD,CAD,CHF,NZD`);
          if (!r2.ok) throw new Error('Network response for historical data was not ok');
          const old = await r2.json();

          const { rates } = data;
          const oldRates = old.rates;

          container.innerHTML = '';
          const currencies = ['EUR','JPY','GBP','AUD','CAD','CHF','NZD'];

          currencies.forEach(ccy => {
            if (!rates[ccy] || !oldRates[ccY]) return;
            const current = rates[ccy];
            const prev = oldRates[ccy];
            const change = ((current - prev) / prev) * 100;

            const changeStyle = change > 0.01 ? { class:'change-green', icon:'▲' }
                              : change < -0.01 ? { class:'change-red', icon:'▼' }
                              : { class:'change-gray', icon:'■' };

            // Mixed presentation preserved intentionally to match your prior UX
            const rateString = ccy === 'JPY'
              ? `1 USD = ${current.toFixed(2)} ${ccy}`
              : `1 ${ccy} = ${(1 / current).toFixed(4)} USD`;

            container.innerHTML += `
              <div class="space-y-1">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-color-base">${ccy}</span>
                  </div>
                  <div class="flex items-center">
                    <span class="text-sm font-medium text-color-base">${rateString}</span>
                    <span class="text-xs ml-2 ${changeStyle.class}">${changeStyle.icon} ${Math.abs(change).toFixed(2)}%</span>
                  </div>
                </div>
              </div>`;
          });

          lastUpdatedEl.textContent = `Live data from ${data.date}`;
        } catch (error) {
          console.error("Error fetching currency rates:", error);
          container.innerHTML = `<p class="text-red-500 text-center">Could not load live rates.</p>`;
          lastUpdatedEl.textContent = 'Error updating data';
        }
      }

      // INIT
      initializeAppCore(initDashboardPage);
      
    } catch (error) {
      // Fallback if Firebase/app fails
      console.error("Failed to initialize the application:", error);
      const appLoader = document.getElementById('app-loader');
      if (appLoader) appLoader.style.display = 'none';
      const appWrapper = document.getElementById('app-wrapper');
      if (appWrapper) appWrapper.style.display = 'block';

      const mainContent = document.querySelector('main');
      if (mainContent) {
        mainContent.innerHTML = `
          <div style="padding:40px; text-align:center; color:#f87171; height:calc(100vh - 68px); display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h1 style="font-size:2.25rem; font-weight:bold; margin-bottom:1rem;">Page Load Error</h1>
            <p style="color:#fca5a5; margin-bottom:0.5rem;">Could not connect to the Finex application.</p>
            <p style="color:#fca5a5; font-size:0.875rem; max-width:600px;">This may be due to a network error or a browser extension (like an ad blocker) blocking a required script. Please check your connection, disable your ad blocker for this site, and try again.</p>
            <p style="font-size:0.75rem; color:#b91c1c; margin-top:1rem;">Error details: ${error.message}</p>
          </div>`;
      }
    }
  </script>
</body>
</html>
