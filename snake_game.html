<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Snake | Finex</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* Scoped styles for the game */
        .game-wrapper {
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        
        /* Style for the game canvas */
        .game-wrapper canvas {
            background-color: #0c0c0c;
            border-radius: 0.75rem; /* 12px */
            image-rendering: pixelated; /* Keeps the pixel art sharp */
        }

        /* Custom message box for game over/start */
        .game-wrapper #message-box {
            @apply absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-75 p-6 rounded-lg text-center text-xl shadow-2xl;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
    </style>
</head>
<body class="antialiased textured-background">

    <div id="app-loader" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-80 z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="app-wrapper" style="display: none;">
        
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <main class="container mx-auto p-4 md:p-8 flex-grow pt-[68px]">
            <div class="flex items-center justify-center">
                
                <div class="glass-card w-full max-w-lg text-center p-6 game-wrapper">
                    <h1 class="text-3xl sm:text-4xl font-bold text-color-base mb-2">
                        3D Snake
                    </h1>

                    <div id="score-display" class="text-2xl mb-4 text-color-base font-bold">
                        Score: 0
                    </div>

                    <div id="game-container" class="relative w-full aspect-video mx-auto mb-4">
                        <div id="message-box" class="hidden text-white">
                            <p id="message-text">Press Start!</p>
                        </div>
                    </div>

                    <button id="start-button" class="main-button text-lg mb-2 w-full max-w-xs">
                        Start Game
                    </button>
                    <p class="text-sm text-color-muted">Use Arrow Keys to control</p>

                </div>

            </div>
        </main>
    </div>

    <script>
        // This script is intentionally not a module, so it can run after app.js
        // We wrap it to wait for app.js to finish
        function initSnakeGame() {
            // Check for Three.js
            if (typeof THREE === 'undefined') {
                document.getElementById('game-container').innerHTML = '<p class="text-red-500">Error: Could not load 3D library.</p>';
                return;
            }

            const gameContainer = document.getElementById('game-container');
            if (!gameContainer) return;

            const scoreEl = document.getElementById('score-display');
            const startButton = document.getElementById('start-button');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // --- 3D Scene Setup ---
            let scene, camera, renderer, snake, food, direction, score, isRunning, gameLoopId;
            const gridSize = 1;
            const gameBounds = 10; // Moves on a 20x20 plane (from -10 to +10)
            const snakeGeo = new THREE.BoxGeometry(gridSize, gridSize, gridSize);
            const foodGeo = new THREE.SphereGeometry(gridSize / 2, 16, 16);
            
            // --- Game State ---
            function initializeGame() {
                // Clear any existing game
                if (renderer) {
                    gameContainer.removeChild(renderer.domElement);
                }
                if (gameLoopId) {
                    cancelAnimationFrame(gameLoopId);
                }

                // --- Scene and Camera ---
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0c0c0c); // Dark background
                const aspect = gameContainer.clientWidth / gameContainer.clientHeight;
                camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
                camera.position.set(0, 15, 10); // Angled view from above
                camera.lookAt(0, 0, 0);

                // --- Renderer ---
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(gameContainer.clientWidth, gameContainer.clientHeight);
                gameContainer.appendChild(renderer.domElement);

                // --- Lighting ---
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
                dirLight.position.set(5, 10, 7.5);
                scene.add(dirLight);

                // --- Ground Plane ---
                const planeGeo = new THREE.PlaneGeometry(gameBounds * 2, gameBounds * 2);
                const planeMat = new THREE.MeshStandardMaterial({ color: 0x222222, side: THREE.DoubleSide });
                const plane = new THREE.Mesh(planeGeo, planeMat);
                plane.rotation.x = -Math.PI / 2; // Rotate to be flat
                scene.add(plane);
                
                // --- Game State Variables ---
                snake = [];
                direction = { x: 0, z: -1 }; // Start moving "up"
                score = 0;
                isRunning = false;
                scoreEl.textContent = 'Score: 0';
                startButton.textContent = 'Start Game';
                
                // --- Create Initial Snake ---
                const snakeMat = new THREE.MeshStandardMaterial({ color: 0x48bb78 });
                const head = new THREE.Mesh(snakeGeo, snakeMat);
                head.position.set(0, gridSize / 2, 0);
                snake.push(head);
                scene.add(head);
                
                // --- Create Food ---
                const foodMat = new THREE.MeshStandardMaterial({ color: 0xf56565 });
                food = new THREE.Mesh(foodGeo, foodMat);
                generateFood();
                scene.add(food);
                
                showMessage('Press Start!', false);
                render(); // Initial render
            }

            function startGame() {
                if (isRunning) return; 
                
                // Reset game (but keep 3D objects)
                // Remove old snake from scene
                snake.forEach(part => scene.remove(part));
                
                // Create new snake
                snake = [];
                const snakeMat = new THREE.MeshStandardMaterial({ color: 0x48bb78 });
                const head = new THREE.Mesh(snakeGeo, snakeMat);
                head.position.set(0, gridSize / 2, 0);
                snake.push(head);
                scene.add(head);

                direction = { x: 0, z: -1 }; 
                score = 0;
                scoreEl.textContent = 'Score: 0';
                isRunning = true;
                startButton.textContent = 'In Progress';
                hideMessage();
                
                gameTick(); // Start the game loop
            }

            let lastTick = 0;
            function gameTick(now) {
                if (!isRunning) return;
                gameLoopId = requestAnimationFrame(gameTick);
                
                // --- Speed Control ---
                const speed = 150; // ms per tick
                if (now - lastTick < speed) {
                    return;
                }
                lastTick = now;
                
                // --- Game Logic ---
                // 1. Get new head position
                const oldHeadPos = snake[0].position;
                const newHeadPos = {
                    x: oldHeadPos.x + direction.x * gridSize,
                    y: gridSize / 2,
                    z: oldHeadPos.z + direction.z * gridSize
                };
                
                // 2. Check Wall Collision
                if (newHeadPos.x >= gameBounds || newHeadPos.x < -gameBounds ||
                    newHeadPos.z >= gameBounds || newHeadPos.z < -gameBounds) {
                    return gameOver();
                }

                // 3. Check Self Collision
                for (let i = 1; i < snake.length; i++) {
                    if (snake[i].position.x === newHeadPos.x && snake[i].position.z === newHeadPos.z) {
                        return gameOver();
                    }
                }

                // 4. Check for Food
                let ateFood = false;
                if (newHeadPos.x === food.position.x && newHeadPos.z === food.position.z) {
                    ateFood = true;
                    score++;
                    scoreEl.textContent = `Score: ${score}`;
                    generateFood();
                }

                // 5. Move Snake
                // Create a new head
                const newHead = new THREE.Mesh(snakeGeo, snake[0].material);
                newHead.position.set(newHeadPos.x, newHeadPos.y, newHeadPos.z);
                scene.add(newHead);
                snake.unshift(newHead); // Add to front

                // Remove tail if we didn't eat
                if (!ateFood) {
                    const tail = snake.pop();
                    scene.remove(tail);
                }

                // 6. Update Camera
                camera.position.x = snake[0].position.x;
                camera.position.z = snake[0].position.z + 10;
                camera.lookAt(snake[0].position);
                
                render();
            }

            function render() {
                renderer.render(scene, camera);
            }

            function generateFood() {
                let newPos;
                let onSnake;
                do {
                    onSnake = false;
                    newPos = {
                        x: Math.floor(Math.random() * gameBounds * 2 - gameBounds) + 0.5,
                        z: Math.floor(Math.random() * gameBounds * 2 - gameBounds) + 0.5,
                        y: gridSize / 2
                    };
                    for (let part of snake) {
                        if (part.position.x === newPos.x && part.position.z === newPos.z) {
                            onSnake = true;
                            break;
                        }
                    }
                } while (onSnake); 
                
                food.position.set(newPos.x, newPos.y, newPos.z);
            }

            function gameOver() {
                isRunning = false;
                if (gameLoopId) cancelAnimationFrame(gameLoopId);
                startButton.textContent = 'Restart Game';
                showMessage(`Game Over! Score: ${score}`);
            }

            function showMessage(text) {
                messageText.textContent = text;
                messageBox.classList.remove('hidden');
            }

            function hideMessage() {
                messageBox.classList.add('hidden');
            }

            // --- Event Listeners ---
            document.addEventListener('keydown', e => {
                if (!isRunning && (e.key.startsWith('Arrow') || ['w', 'a', 's', 'd'].includes(e.key))) {
                    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                        return;
                    }
                    startGame();
                }

                switch (e.key) {
                    case 'ArrowUp':
                    case 'w':
                        if (direction.z === 0) direction = { x: 0, z: -1 };
                        break;
                    case 'ArrowDown':
                    case 's':
                        if (direction.z === 0) direction = { x: 0, z: 1 };
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        if (direction.x === 0) direction = { x: -1, z: 0 };
                        break;
                    case 'ArrowRight':
                    case 'd':
                        if (direction.x === 0) direction = { x: 1, z: 0 };
                        break;
                }
                
                if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                }
            });

            startButton.addEventListener('click', () => {
                if (isRunning) {
                    initializeGame(); 
                    startGame(); 
                } else {
                    initializeGame(); 
                    startGame(); 
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (renderer) {
                    const w = gameContainer.clientWidth;
                    const h = gameContainer.clientHeight;
                    renderer.setSize(w, h);
                    camera.aspect = w / h;
                    camera.updateProjectionMatrix();
                    render();
                }
            });

            // --- Initial Setup ---
            initializeGame();
        }
    </script>
    
    <script type="module" src="app.js"></script>
    <script type="module">
        import { initializeAppCore } from './app.js';
        
        function initGamePage(user, db) {
            console.log("Setting up 3D Snake Game page...");
            setTimeout(() => {
                if (typeof initSnakeGame === 'function') {
                    initSnakeGame();
                } else {
                    console.error("Snake Game init function not found!");
                }
            }, 100); // 100ms delay
        }

        initializeAppCore(initGamePage);
    </script>
</body>
</html>
