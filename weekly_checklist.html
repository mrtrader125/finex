<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Checklist | Finex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
    <style>
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; @apply text-color-muted; }
        .loader { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #0052cc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        .dark .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #0065ff; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased textured-background">
    <div id="loading-container" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <div class="loader mb-4"></div>
        <p class="text-lg text-color-muted">Initializing Checklist...</p>
    </div>

    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <main class="container mx-auto p-4 md:p-8">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-bold text-color-base">Weekly Trading Checklist</h1>
                <p id="week-identifier" class="text-lg text-color-muted mt-4">Plan and review your trading week.</p>
            </div>
            <div class="max-w-4xl mx-auto space-y-8">
                <!-- 1. Weekly Analysis Card -->
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-4">1. Weekly Analysis</h2>
                    <div>
                        <label for="pairs-analyzed" class="form-label">How many pairs/instruments did you analyze this week?</label>
                        <input type="number" id="pairs-analyzed" min="0" class="form-input w-full md:w-1/2">
                    </div>
                </div>
                <!-- 2. Watchlist Card -->
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-4">2. Watchlist for the Week</h2>
                    <p class="text-color-muted mb-4">Select the pairs/instruments you plan to focus on.</p>
                    <div id="watchlist-pairs" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                     <div class="mt-4">
                        <label for="other-pairs" class="form-label">Other pairs/instruments (comma-separated):</label>
                        <input type="text" id="other-pairs" class="form-input w-full" placeholder="e.g., XAU/USD, SPX500">
                     </div>
                </div>
                <!-- 3. Top Pairs Focus Card -->
                 <div class="glass-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-4">3. Top Pairs Focus</h2>
                    <p class="text-color-muted mb-4">List the 1-3 pairs you consider the highest probability setups for the week and why.</p>
                    <textarea id="top-pairs-focus" rows="4" class="form-textarea w-full" placeholder="e.g., EUR/USD - Strong uptrend on H4, waiting for pullback to support.&#10;GBP/JPY - Potential reversal pattern forming on Daily chart."></textarea>
                </div>

                <!-- *** 4. UPDATED TRADE LOG CARD *** -->
                <div class="glass-card p-6 md:p-8">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold">4. Weekly Trade Log</h2>
                        <a href="trading_journal.html" class="main-button font-bold py-2 px-4 rounded-lg text-sm">
                            Log New Trade <i class="fas fa-plus ml-1"></i>
                        </a>
                    </div>
                    <p class="text-color-muted mb-6">
                        Trades logged in your main <a href="trading_journal.html" class="text-blue-500 hover:underline">Trading Journal</a> for this week will appear here automatically.
                    </p>
                    <div id="trade-log-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 mb-6">
                        <p class="text-color-muted text-center">Loading trades...</p>
                    </div>
                    
                    <!-- NEW: Trade Log Summary -->
                    <div class="border-t border-color-base pt-6">
                        <h3 class="text-xl font-bold mb-4">Trade Log Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="glass-card p-3"><span class="text-sm text-color-muted block">Total P/L</span><span id="weekly-total-pl" class="text-xl font-bold">-$--.--</span></div>
                            <div class="glass-card p-3"><span class="text-sm text-color-muted block">Total Trades</span><span id="weekly-total-trades" class="text-xl font-bold">0</span></div>
                            <div class="glass-card p-3"><span class="text-sm text-color-muted block">Win Rate</span><span id="weekly-win-rate" class="text-xl font-bold">--%</span></div>
                            <div class="glass-card p-3"><span class="text-sm text-color-muted block">Avg R:R</span><span id="weekly-avg-rr" class="text-xl font-bold">N/A</span></div>
                        </div>
                    </div>
                </div>
                <!-- *** END UPDATED CARD *** -->

                <!-- 5. Weekly Summary Card -->
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-4">5. Weekly Summary</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Removed the P/L input, as it's now automated in card 4 -->
                        <div>
                            <label for="lessons-learned" class="form-label">Key Lessons Learned / Reflections</label>
                            <textarea id="lessons-learned" rows="4" class="form-textarea w-full" placeholder="What went well? What could be improved? What did I learn from my wins AND losses?"></textarea>
                        </div>
                    </div>
                </div>
                <p id="save-status" class="text-center text-sm text-color-muted h-4 mt-4"></p>
            </div>
        </main>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        // *** IMPORT SHARED FUNCTIONS ***
        import { initializeAppCore, db, getWeekId, getWeekDateRange } from './app.js';
        import { 
            doc, setDoc, onSnapshot, serverTimestamp, 
            collection, query, where 
        } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        function initChecklistPage(user, db) {
            console.log("Setting up Weekly Checklist specific logic...");

            const loadingContainer = document.getElementById('loading-container');
            const weekIdentifier = document.getElementById('week-identifier');
            const saveStatus = document.getElementById('save-status');
            const pairsAnalyzedInput = document.getElementById('pairs-analyzed');
            const watchlistContainer = document.getElementById('watchlist-pairs');
            const otherPairsInput = document.getElementById('other-pairs');
            const topPairsFocusInput = document.getElementById('top-pairs-focus');
            const tradeLogList = document.getElementById('trade-log-list'); // This still exists
            // const weeklyPlInput = document.getElementById('weekly-pl'); // This is removed
            const lessonsLearnedInput = document.getElementById('lessons-learned');

            // *** REMOVED addTradeForm ***
            if (!loadingContainer || !weekIdentifier || !saveStatus || !pairsAnalyzedInput || !watchlistContainer || !tradeLogList) {
                 console.error("Critical checklist elements missing!");
                 if(loadingContainer) loadingContainer.innerHTML = "<p class='text-red-500'>Error loading page elements.</p>";
                 return;
            }

            let currentUserId = user.uid;
            let currentWeekId = '';
            let checklistDocRef = null;
            let checklistData = {};
            let debounceTimer = null;
            const commonPairs = ["EUR/USD", "GBP/USD", "USD/JPY", "USD/CAD", "AUD/USD", "NZD/USD", "USD/CHF", "GBP/JPY"];

            // *** REMOVED local getWeekId function (now imported) ***

            function populateWatchlistCheckboxes() {
                 watchlistContainer.innerHTML = commonPairs.map(pair => `
                     <label class="flex items-center space-x-2 cursor-pointer checkbox-label p-1">
                         <input type="checkbox" class="form-checkbox watchlist-checkbox" value="${pair}">
                         <span class="text-color-base">${pair}</span>
                     </label>
                 `).join('');
            }

            // *** NEW: Function to display trades from the journal ***
            function displayWeeklyTradeLog(trades = []) {
                if (!trades || trades.length === 0) {
                    tradeLogList.innerHTML = '<p class="text-color-muted text-center">No trades logged in your journal for this week.</p>';
                    return;
                }
                tradeLogList.innerHTML = trades.map(trade => {
                    const plColor = (trade.pl || 0) >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                    const dateString = trade.createdAt?.toDate() ? trade.createdAt.toDate().toLocaleDateString() : 'N/A';
                    return `
                    <div class="bg-gray-100 dark:bg-white/5 p-3 rounded-lg text-sm flex flex-wrap justify-between items-center gap-2">
                        <span class="font-semibold text-color-base">${trade.symbol}</span>
                        <span class="text-color-muted flex-grow mx-2">${trade.notes ? (trade.notes.substring(0, 50) + (trade.notes.length > 50 ? '...' : '')) : 'No notes.'}</span>
                        <span class="text-xs text-color-muted">${dateString}</span>
                        <span class="${plColor} font-semibold">${(trade.pl || 0).toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</span>
                    </div>
                    `;
                }).join('');
            }

            // *** NEW: Function to calculate summary from journal trades ***
            function calculateWeeklySummary(trades = []) {
                const total = trades.length;
                const totalPL = trades.reduce((sum, t) => sum + (t.pl || 0), 0);
                const winners = trades.filter(t => t.pl > 0);
                const winRate = total > 0 ? (winners.length / total) * 100 : 0;
                
                const plEl = document.getElementById('weekly-total-pl');
                const tradesEl = document.getElementById('weekly-total-trades');
                const winRateEl = document.getElementById('weekly-win-rate');
                
                if (plEl) {
                    plEl.textContent = totalPL.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                    plEl.className = `text-xl font-bold ${totalPL >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'}`;
                }
                if (tradesEl) tradesEl.textContent = total;
                if (winRateEl) winRateEl.textContent = `${winRate.toFixed(0)}%`;
                // Avg R:R is hard without stop/target data, so we leave it as N/A
            }

            async function saveData(field, value) {
                 if (!checklistDocRef) return;
                 saveStatus.textContent = 'Saving...';
                 const dataToSave = { [field]: value, lastUpdated: serverTimestamp() };
                 try {
                     await setDoc(checklistDocRef, dataToSave, { merge: true });
                     saveStatus.textContent = 'Saved.';
                     setTimeout(() => saveStatus.textContent = '', 2000);
                 } catch (error) { console.error("Error saving checklist data:", error); saveStatus.textContent = 'Error saving.'; }
            }

            function debouncedSave(field, value) {
                 clearTimeout(debounceTimer); saveStatus.textContent = 'Typing...';
                 debounceTimer = setTimeout(() => { saveData(field, value); }, 1000);
            }

            function listenForChecklistData() {
                onSnapshot(checklistDocRef, (doc) => {
                    if (doc.exists()) {
                        checklistData = doc.data();
                        pairsAnalyzedInput.value = checklistData.pairsAnalyzed ?? '';
                        otherPairsInput.value = checklistData.otherPairs ?? '';
                        topPairsFocusInput.value = checklistData.topPairsFocus ?? '';
                        // weeklyPlInput.value = checklistData.weeklyPL ?? ''; // Removed
                        lessonsLearnedInput.value = checklistData.lessonsLearned ?? '';
                        const selectedPairs = checklistData.watchlist || [];
                        document.querySelectorAll('.watchlist-checkbox').forEach(checkbox => {
                            checkbox.checked = selectedPairs.includes(checkbox.value);
                        });
                        // *** REMOVED: displayTradeLog(checklistData.trades); ***
                    } else {
                        console.log("No checklist data for this week yet."); checklistData = {};
                        pairsAnalyzedInput.value = ''; otherPairsInput.value = ''; topPairsFocusInput.value = '';
                        // weeklyPlInput.value = ''; // Removed
                        lessonsLearnedInput.value = '';
                        document.querySelectorAll('.watchlist-checkbox').forEach(checkbox => checkbox.checked = false);
                        // *** REMOVED: displayTradeLog([]); ***
                    }
                    if(loadingContainer) loadingContainer.style.display = 'none';

                }, (error) => {
                     console.error("Error listening to checklist data:", error);
                     if(loadingContainer) loadingContainer.style.display = 'none';
                     const mainContent = document.querySelector('main');
                     if(mainContent) mainContent.innerHTML = "<p class='text-red-500 text-center p-8'>Could not load checklist data.</p>";
                });
            }

            // *** NEW: Function to listen for trades from the journal ***
            function listenForWeeklyTrades() {
                const tradesCollectionRef = collection(db, "trades");
                const { startDate, endDate } = getWeekDateRange(new Date());

                const q = query(tradesCollectionRef, 
                    where("userId", "==", currentUserId),
                    where("createdAt", ">=", startDate),
                    where("createdAt", "<=", endDate)
                );

                onSnapshot(q, (snapshot) => {
                    const trades = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const entry = Number(data.entryPrice) || 0;
                        const exit = Number(data.exitPrice) || 0;
                        const size = Number(data.positionSize) || 0;
                        const pl = (data.direction === 'long' ? (exit - entry) : (entry - exit)) * size;
                        return { id: doc.id, ...data, pl: isNaN(pl) ? 0 : pl };
                    });
                    
                    // Sort by date, newest first
                    trades.sort((a, b) => (b.createdAt?.toDate() ?? 0) - (a.createdAt?.toDate() ?? 0));
                    
                    displayWeeklyTradeLog(trades);
                    calculateWeeklySummary(trades);

                }, (error) => {
                    console.error("Error fetching weekly trades:", error);
                    if (error.code === 'failed-precondition') {
                         tradeLogList.innerHTML = `<p class="text-center text-red-500 text-sm p-4"><b>Action Required:</b> This feature requires a database index. Please go to your Firebase console for the 'trades' collection and create a composite index on these fields:<br><b>userId (Ascending)</b>, <b>createdAt (Ascending)</b>, <b>createdAt (Ascending)</b>.</p>`;
                    } else {
                         tradeLogList.innerHTML = `<p class="text-center text-red-500">Error loading trades.</p>`;
                    }
                    calculateWeeklySummary([]); // Reset summary on error
                });
            }

            function setupEventListeners() {
                 pairsAnalyzedInput?.addEventListener('input', (e) => debouncedSave('pairsAnalyzed', parseInt(e.target.value) || 0));
                 otherPairsInput?.addEventListener('input', (e) => debouncedSave('otherPairs', e.target.value));
                 topPairsFocusInput?.addEventListener('input', (e) => debouncedSave('topPairsFocus', e.target.value));
                 // weeklyPlInput?.addEventListener('input', (e) => debouncedSave('weeklyPL', e.target.value)); // Removed
                 lessonsLearnedInput?.addEventListener('input', (e) => debouncedSave('lessonsLearned', e.target.value));
                 watchlistContainer?.addEventListener('change', (e) => {
                     if (e.target.classList.contains('watchlist-checkbox')) {
                         const selectedPairs = Array.from(document.querySelectorAll('.watchlist-checkbox:checked')).map(cb => cb.value);
                         saveData('watchlist', selectedPairs);
                     }
                 });
                 // *** REMOVED: addTradeForm.addEventListener('submit', ...) ***
            }

            // --- Initial Setup ---
            currentWeekId = getWeekId(new Date());
            if(weekIdentifier) weekIdentifier.textContent = `Checklist for ${currentWeekId.replace('-', ', Week ')}`;
            checklistDocRef = doc(db, `users/${currentUserId}/weeklyChecklists`, currentWeekId);

            populateWatchlistCheckboxes();
            listenForChecklistData(); // Loads the plan
            listenForWeeklyTrades(); // *** NEW: Loads the trades ***
            setupEventListeners();
        }

        initializeAppCore(initChecklistPage);
    </script>
</body>
</html>
