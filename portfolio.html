<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio | Finex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="main.css">
</head>
<body class="antialiased textured-background">
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-placeholder"></div>
        <div id="header-placeholder"></div>

        <div class="min-h-screen flex flex-col">
            <main class="container mx-auto p-4 md:p-8 flex-grow">
                
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-color-base">Portfolio Tracker</h1>
                    <p class="text-lg text-color-muted mt-2 max-w-3xl mx-auto">Manually track your long-term holdings and their cost basis.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:items-start"> 
                    <div class="lg:col-span-1 space-y-8">
                        <div class="glass-card p-6 text-center">
                            <h2 class="text-2xl font-bold mb-4">Portfolio Summary</h2>
                             <div class="stat-card">
                                 <h4 class="stat-title">Total Cost Basis</h4>
                                 <p id="total-cost-basis" class="stat-value">$0.00</p>
                             </div>
                             <p class="text-xs text-color-muted mt-3">(Live valuation feature coming soon)</p>
                        </div>

                        <div class="glass-card">
                            <details class="group"> 
                                <summary class="p-6 cursor-pointer flex justify-between items-center list-none group-open:border-b group-open:border-color-base">
                                    <h2 class="text-2xl font-bold">Add New Holding</h2>
                                    <i class="fas fa-chevron-down chevron-icon text-color-muted group-hover:text-color-base"></i>
                                </summary>
                                <form id="asset-form" class="space-y-4 p-6">
                                    <div>
                                        <label for="asset-symbol" class="text-sm text-color-muted block mb-1">Asset Symbol</label>
                                        <input type="text" id="asset-symbol" required class="form-input w-full" placeholder="e.g., AAPL, BTC, VOO">
                                    </div>
                                    <div class="custom-select-wrapper">
                                        <label class="text-sm text-color-muted block mb-1">Asset Type</label>
                                        <input type="hidden" id="asset-type" name="asset-type" value="stock">
                                        <div class="custom-select-trigger type-stock" data-dropdown-trigger="asset-type">
                                            <span>Stock</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                        <div class="custom-select-options">
                                            <div class="custom-option selected" data-value="stock">Stock</div>
                                            <div class="custom-option" data-value="crypto">Crypto</div>
                                            <div class="custom-option" data-value="etf">ETF</div>
                                            <div class="custom-option" data-value="other">Other</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="asset-quantity" class="text-sm text-color-muted block mb-1">Quantity</label>
                                            <input type="number" step="any" min="0" id="asset-quantity" required class="form-input w-full" placeholder="e.g., 10, 0.5">
                                        </div>
                                        <div>
                                            <label for="asset-avg-price" class="text-sm text-color-muted block mb-1">Avg Purchase Price ($)</label>
                                            <input type="number" step="any" min="0" id="asset-avg-price" required class="form-input w-full" placeholder="e.g., 150.25">
                                        </div>
                                    </div>
                                    <button type="submit" id="save-asset-btn" class="main-button w-full font-bold py-3">Add Holding</button>
                                    <p id="form-message" class="text-center text-sm mt-3 h-4"></p>
                                </form>
                                </details>
                        </div>
                    </div>

                    <div class="lg:col-span-2 glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4">Current Holdings</h2>
                        <div id="portfolio-holdings" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                             <p id="loading-holdings" class="text-center text-color-muted">Loading holdings...</p>
                             <p id="no-holdings" class="text-center text-color-muted hidden">You haven't added any holdings yet.</p>
                             </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content glass-card p-8 rounded-2xl w-full max-w-sm text-center transform scale-95">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="text-color-muted mb-6">Are you sure you want to delete this holding?</p>
                <div class="flex gap-4">
                    <button id="cancel-delete-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">Cancel</button>
                    <button id="confirm-delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">Delete</button>
                </div>
            </div>
        </div>
        
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
             <div class="modal-content glass-card p-8 rounded-2xl w-full max-w-lg transform scale-95">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold">Edit Holding</h2>
                     <button id="close-edit-modal" class="text-color-muted hover:text-color-base text-2xl">&times;</button>
                 </div>
                 <form id="edit-asset-form" class="space-y-4">
                     <input type="hidden" id="edit-asset-id">
                     <div>
                         <label for="edit-asset-symbol" class="text-sm text-color-muted block mb-1">Asset Symbol</label>
                         <input type="text" id="edit-asset-symbol" required class="form-input w-full" readonly disabled> 
                     </div>
                     <div class="custom-select-wrapper">
                         <label class="text-sm text-color-muted block mb-1">Asset Type</label>
                         <input type="hidden" id="edit-asset-type" name="edit-asset-type" value="stock">
                         <div class="custom-select-trigger type-stock" data-dropdown-trigger="edit-asset-type">
                             <span>Stock</span>
                             <i class="fas fa-chevron-down"></i>
                         </div>
                         <div class="custom-select-options">
                             <div class="custom-option selected" data-value="stock">Stock</div>
                             <div class="custom-option" data-value="crypto">Crypto</div>
                             <div class="custom-option" data-value="etf">ETF</div>
                             <div class="custom-option" data-value="other">Other</div>
                         </div>
                     </div>
                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label for="edit-asset-quantity" class="text-sm text-color-muted block mb-1">Quantity</label>
                             <input type="number" step="any" min="0" id="edit-asset-quantity" required class="form-input w-full">
                         </div>
                         <div>
                             <label for="edit-asset-avg-price" class="text-sm text-color-muted block mb-1">Avg Purchase Price ($)</label>
                             <input type="number" step="any" min="0" id="edit-asset-avg-price" required class="form-input w-full">
                         </div>
                     </div>
                     <button type="submit" id="update-asset-btn" class="main-button w-full font-bold py-3">Update Holding</button>
                     <p id="edit-form-message" class="text-center text-sm mt-3 h-4"></p>
                 </form>
                 </div>
        </div>
        
    </div> <script type="module" src="app.js"></script>
    <script type="module">
        import { initializeAppCore, db, auth } from './app.js';
        import { collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        function initPortfolioPage(user, db) {
            console.log("Setting up Portfolio page specific logic...");
            
            // --- JAVASCRIPT IS UPDATED ---
            const elements = {
                assetForm: document.getElementById('asset-form'),
                saveAssetBtn: document.getElementById('save-asset-btn'),
                formMessage: document.getElementById('form-message'),
                portfolioHoldings: document.getElementById('portfolio-holdings'),
                loadingHoldings: document.getElementById('loading-holdings'),
                noHoldings: document.getElementById('no-holdings'),
                totalCostBasis: document.getElementById('total-cost-basis'),
                deleteModal: document.getElementById('delete-modal'),
                cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                editModal: document.getElementById('edit-modal'),
                closeEditModalBtn: document.getElementById('close-edit-modal'),
                editAssetForm: document.getElementById('edit-asset-form'),
                editAssetId: document.getElementById('edit-asset-id'),
                editAssetSymbol: document.getElementById('edit-asset-symbol'),
                editAssetType: document.getElementById('edit-asset-type'), // Hidden input
                editAssetQuantity: document.getElementById('edit-asset-quantity'),
                editAssetAvgPrice: document.getElementById('edit-asset-avg-price'),
                updateAssetBtn: document.getElementById('update-asset-btn'),
                editFormMessage: document.getElementById('edit-form-message'),
            };

            let currentUserId = user.uid;
            let portfolioCollectionRef = collection(db, `users/${currentUserId}/portfolio`);
            let allHoldings = [];
            let assetToDeleteId = null;
            let assetToEdit = null;

            async function addHolding(e) {
                e.preventDefault();
                elements.saveAssetBtn.disabled = true;
                elements.saveAssetBtn.textContent = 'Saving...';
                showFormMessage('Saving asset...', false, elements.formMessage);

                // Read value from hidden input for custom dropdown
                const assetData = {
                    userId: currentUserId,
                    symbol: elements.assetForm['asset-symbol'].value.toUpperCase().trim(),
                    type: elements.assetForm['asset-type'].value, // Reads hidden input
                    quantity: parseFloat(elements.assetForm['asset-quantity'].value),
                    avgPrice: parseFloat(elements.assetForm['asset-avg-price'].value),
                    addedAt: serverTimestamp()
                };

                if (isNaN(assetData.quantity) || isNaN(assetData.avgPrice) || assetData.quantity < 0 || assetData.avgPrice < 0 || !assetData.symbol) {
                     showFormMessage('Invalid input.', true, elements.formMessage);
                     elements.saveAssetBtn.disabled = false;
                     elements.saveAssetBtn.textContent = 'Add Holding';
                     return;
                }

                try {
                    await addDoc(portfolioCollectionRef, assetData);
                    elements.assetForm.reset();
                    // Manually reset custom dropdown after form reset
                    resetCustomDropdown(elements.assetForm.querySelector('[data-dropdown-trigger="asset-type"]'));
                    showFormMessage('Holding Added!', false, elements.formMessage);
                } catch (error) {
                    console.error("Error adding holding: ", error);
                    showFormMessage('Error saving asset.', true, elements.formMessage);
                } finally {
                    elements.saveAssetBtn.disabled = false;
                    elements.saveAssetBtn.textContent = 'Add Holding';
                }
            }

            async function deleteHolding() {
                 if (!assetToDeleteId) return;
                 elements.confirmDeleteBtn.disabled = true;
                 elements.confirmDeleteBtn.textContent = 'Deleting...';
                 const docRef = doc(db, `users/${currentUserId}/portfolio`, assetToDeleteId);
                 try {
                     await deleteDoc(docRef);
                     closeModal(elements.deleteModal);
                 } catch (error) {
                     console.error("Error deleting holding: ", error);
                     alert('Error deleting holding.'); 
                 } finally {
                     assetToDeleteId = null;
                     elements.confirmDeleteBtn.disabled = false;
                     elements.confirmDeleteBtn.textContent = 'Delete';
                 }
            }

            async function updateHolding(e) {
                e.preventDefault();
                if (!assetToEdit) return;
                elements.updateAssetBtn.disabled = true;
                elements.updateAssetBtn.textContent = 'Updating...';
                showFormMessage('Saving changes...', false, elements.editFormMessage);

                // Read value from hidden input for custom dropdown
                const updatedData = {
                     type: elements.editAssetType.value, // Reads hidden input
                     quantity: parseFloat(elements.editAssetQuantity.value),
                     avgPrice: parseFloat(elements.editAssetAvgPrice.value),
                     lastUpdated: serverTimestamp()
                 };

                 if (isNaN(updatedData.quantity) || isNaN(updatedData.avgPrice) || updatedData.quantity < 0 || updatedData.avgPrice < 0) {
                     showFormMessage('Invalid input.', true, elements.editFormMessage);
                     elements.updateAssetBtn.disabled = false;
                     elements.updateAssetBtn.textContent = 'Update Holding';
                     return;
                 }
                
                const docRef = doc(db, `users/${currentUserId}/portfolio`, assetToEdit.id);
                try {
                    await updateDoc(docRef, updatedData);
                    showFormMessage('Holding Updated!', false, elements.editFormMessage);
                    setTimeout(() => closeModal(elements.editModal), 1500); 
                } catch (error) {
                    console.error("Error updating holding: ", error);
                    showFormMessage('Error updating asset.', true, elements.editFormMessage);
                } finally {
                    elements.updateAssetBtn.disabled = false;
                    elements.updateAssetBtn.textContent = 'Update Holding';
                }
            }

            function listenForHoldings() {
                 const q = query(portfolioCollectionRef, orderBy("symbol", "asc")); 
                 
                 onSnapshot(q, (snapshot) => {
                     elements.loadingHoldings.style.display = 'none';
                     allHoldings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     
                     if (allHoldings.length === 0) {
                         elements.noHoldings.classList.remove('hidden');
                         elements.portfolioHoldings.innerHTML = ''; 
                     } else {
                         elements.noHoldings.classList.add('hidden');
                         renderPortfolioTable(allHoldings);
                     }
                     calculateSummary(allHoldings);

                 }, (error) => {
                     console.error("Error fetching portfolio: ", error);
                     elements.loadingHoldings.textContent = 'Error loading holdings.';
                     elements.portfolioHoldings.innerHTML = '<p class="text-red-500 text-center">Could not load portfolio data.</p>';
                 });
            }

            function renderPortfolioTable(holdings) {
                elements.portfolioHoldings.innerHTML = holdings.map(asset => {
                    const costBasis = (asset.quantity || 0) * (asset.avgPrice || 0);
                    const typeColorClass = getTypeColor(asset.type);
                    
                    return `
                    <div class="glass-card-inset flex flex-wrap justify-between items-center gap-4 text-sm">
                        <div class="flex items-center gap-3 flex-grow min-w-[120px]">
                            <span class="font-bold text-lg text-color-base">${asset.symbol || 'N/A'}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-md ${typeColorClass}">${asset.type?.toUpperCase() || 'N/A'}</span>
                        </div>
                        <div class="text-center flex-shrink-0">
                            <span class="text-xs text-color-muted block">Quantity</span>
                            <span class="font-semibold text-color-base">${asset.quantity != null ? asset.quantity : '?'}</span>
                        </div>
                         <div class="text-center flex-shrink-0">
                             <span class="text-xs text-color-muted block">Avg Price</span>
                             <span class="font-semibold text-color-base">${asset.avgPrice != null ? asset.avgPrice.toLocaleString('en-US', {style:'currency', currency:'USD'}) : '?'}</span>
                         </div>
                        <div class="text-center flex-shrink-0">
                            <span class="text-xs text-color-muted block">Cost Basis</span>
                            <span class="font-semibold text-color-base">${costBasis.toLocaleString('en-US', {style:'currency', currency:'USD'})}</span>
                        </div>
                        <div class="flex gap-3 flex-shrink-0">
                             <button data-id="${asset.id}" class="edit-asset-btn text-xs text-blue-500 hover:text-blue-400"><i class="fas fa-edit mr-1"></i>Edit</button>
                             <button data-id="${asset.id}" class="delete-asset-btn text-xs text-red-500 hover:text-red-400"><i class="fas fa-trash-alt mr-1"></i>Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            function calculateSummary(holdings) {
                 const totalCost = holdings.reduce((sum, asset) => {
                     return sum + (asset.quantity || 0) * (asset.avgPrice || 0);
                 }, 0);
                 elements.totalCostBasis.textContent = totalCost.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }

            function getTypeColor(type) {
                switch(type?.toLowerCase()) {
                    case 'stock': return 'bg-blue-600/20 text-blue-400 type-stock'; // Add type class
                    case 'crypto': return 'bg-yellow-600/20 text-yellow-400 type-crypto'; // Add type class
                    case 'etf': return 'bg-green-600/20 text-green-400 type-etf'; // Add type class
                    default: return 'bg-gray-600/20 text-gray-400 type-other'; // Add type class
                }
            }
            
            function showFormMessage(message, isError = false, element = elements.formMessage) {
                 if (!element) return;
                 element.textContent = message;
                 element.className = `text-center text-sm mt-3 h-4 ${isError ? 'text-red-400' : 'text-green-400'}`;
                 setTimeout(() => { if (element) element.textContent = ''; }, 3000);
            }

            function openModal(modalElement) {
                 if (!modalElement) return;
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content')?.classList.remove('scale-95');
            }

            function closeModal(modalElement) {
                 if (!modalElement) return;
                 modalElement.classList.add('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content')?.classList.add('scale-95');
                 if (modalElement === elements.deleteModal) assetToDeleteId = null;
                 if (modalElement === elements.editModal) {
                     assetToEdit = null;
                     elements.editAssetForm.reset(); 
                     elements.editFormMessage.textContent = ''; 
                 }
            }
            
            function openEditModal(assetId) {
                assetToEdit = allHoldings.find(h => h.id === assetId);
                if (!assetToEdit) return;
                
                elements.editAssetId.value = assetToEdit.id;
                elements.editAssetSymbol.value = assetToEdit.symbol || '';
                // Set value for custom dropdown in edit modal
                setCustomDropdownValue(elements.editAssetForm.querySelector('[data-dropdown-trigger="edit-asset-type"]'), assetToEdit.type || 'stock');
                elements.editAssetQuantity.value = assetToEdit.quantity != null ? assetToEdit.quantity : '';
                elements.editAssetAvgPrice.value = assetToEdit.avgPrice != null ? assetToEdit.avgPrice : '';
                
                openModal(elements.editModal);
            }

            // === NEW FUNCTIONS FOR CUSTOM DROPDOWNS ===
            function setupCustomDropdowns() {
                document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
                    const trigger = wrapper.querySelector('.custom-select-trigger');
                    const optionsContainer = wrapper.querySelector('.custom-select-options');
                    const hiddenInput = wrapper.querySelector('input[type="hidden"]');
                    const triggerText = trigger.querySelector('span');

                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.custom-select-wrapper.open').forEach(openWrapper => {
                            if (openWrapper !== wrapper) openWrapper.classList.remove('open');
                        });
                        wrapper.classList.toggle('open');
                    });

                    optionsContainer.addEventListener('click', (e) => {
                        const option = e.target.closest('.custom-option');
                        if (!option) return;
                        const selectedValue = option.dataset.value;
                        const selectedText = option.textContent;
                        hiddenInput.value = selectedValue;
                        triggerText.textContent = selectedText;
                        optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        updateDropdownColor(trigger, selectedValue);
                        wrapper.classList.remove('open');
                    });
                });
                document.addEventListener('click', () => {
                    document.querySelectorAll('.custom-select-wrapper.open').forEach(wrapper => wrapper.classList.remove('open'));
                });
            }

            function updateDropdownColor(triggerElement, value) {
                if (!triggerElement) return;
                triggerElement.classList.remove('type-stock', 'type-crypto', 'type-etf', 'type-other'); // Clear only type colors
                if (value === 'stock') triggerElement.classList.add('type-stock');
                else if (value === 'crypto') triggerElement.classList.add('type-crypto');
                else if (value === 'etf') triggerElement.classList.add('type-etf');
                else if (value === 'other') triggerElement.classList.add('type-other');
            }

            // Helper to reset custom dropdown to first option
            function resetCustomDropdown(triggerElement) {
                 if (!triggerElement) return;
                 const wrapper = triggerElement.closest('.custom-select-wrapper');
                 const hiddenInput = wrapper.querySelector('input[type="hidden"]');
                 const optionsContainer = wrapper.querySelector('.custom-select-options');
                 const firstOption = optionsContainer.querySelector('.custom-option');
                 if (firstOption) {
                     const defaultValue = firstOption.dataset.value;
                     const defaultText = firstOption.textContent;
                     hiddenInput.value = defaultValue;
                     triggerElement.querySelector('span').textContent = defaultText;
                     optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                     firstOption.classList.add('selected');
                     updateDropdownColor(triggerElement, defaultValue);
                 }
            }
            
            // Helper to set custom dropdown value (e.g., for edit modal)
            function setCustomDropdownValue(triggerElement, value) {
                if (!triggerElement) return;
                const wrapper = triggerElement.closest('.custom-select-wrapper');
                const hiddenInput = wrapper.querySelector('input[type="hidden"]');
                const optionsContainer = wrapper.querySelector('.custom-select-options');
                const targetOption = optionsContainer.querySelector(`.custom-option[data-value="${value}"]`);
                
                if (targetOption) {
                     const selectedValue = targetOption.dataset.value;
                     const selectedText = targetOption.textContent;
                     hiddenInput.value = selectedValue;
                     triggerElement.querySelector('span').textContent = selectedText;
                     optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                     targetOption.classList.add('selected');
                     updateDropdownColor(triggerElement, selectedValue);
                } else {
                     // Fallback to first option if value not found
                     resetCustomDropdown(triggerElement);
                }
            }
            // === END OF NEW FUNCTIONS ===

            function setupEventListeners() {
                elements.assetForm.addEventListener('submit', addHolding);
                elements.confirmDeleteBtn.addEventListener('click', deleteHolding);
                elements.cancelDeleteBtn.addEventListener('click', () => closeModal(elements.deleteModal));
                elements.deleteModal.addEventListener('click', (e) => { if (e.target === elements.deleteModal) closeModal(elements.deleteModal); });

                elements.editAssetForm.addEventListener('submit', updateHolding);
                elements.closeEditModalBtn.addEventListener('click', () => closeModal(elements.editModal));
                elements.editModal.addEventListener('click', (e) => { if (e.target === elements.editModal) closeModal(elements.editModal); });

                 elements.portfolioHoldings.addEventListener('click', (e) => {
                     const deleteBtn = e.target.closest('.delete-asset-btn');
                     const editBtn = e.target.closest('.edit-asset-btn');
                     
                     if (deleteBtn) {
                         assetToDeleteId = deleteBtn.dataset.id;
                         openModal(elements.deleteModal);
                     } else if (editBtn) {
                         openEditModal(editBtn.dataset.id);
                     }
                 });
                
                document.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape') {
                         if (!elements.deleteModal.classList.contains('opacity-0')) closeModal(elements.deleteModal);
                         if (!elements.editModal.classList.contains('opacity-0')) closeModal(elements.editModal);
                     }
                 });
                 
                 // Initialize custom dropdowns
                 setupCustomDropdowns();
            }

            // --- Initial Load ---
            setupEventListeners();
            listenForHoldings();
        }

        initializeAppCore(initPortfolioPage);
    </script>
</body>
</html>
